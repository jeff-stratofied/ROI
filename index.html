<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Loan Portfolio â€” Rebuilt Dashboard</title>

  <!-- ====================================
       Styles (organized, with dark mode)
       ==================================== -->
  <style>

:root {
  --bg-light:#f8fafc;
  --bg-dark:#0F172A;
  --card-light:var(--card);
  --card-dark:#1E293B;
  --border-light:rgba(15,23,42,0.04);
  --border-dark:#334155;
  --text-light:#0f172a;
  --text-dark:#E2E8F0;
  --accent:#0ea5e9;
}
html[data-theme="dark"] {
  --bg:var(--bg-dark);
  --card:var(--card-dark);
  --border:var(--border-dark);
  --text:var(--text-dark);
}
html[data-theme="light"] {
  --bg: #eef2f6;
  --card: #ffffff;
  --border: rgba(15,23,42,0.07);
  --text: #0f172a;
}
body {
  background: var(--bg);
  color: var(--text);
}

/* === Injected Full Dark Mode Palette === */
:root{
  --bg:#0F172A;
  --card:#1E293B;
  --border:#334155;
  --text:#E2E8F0;
  --accent:#0ea5e9;
}
body.dark {
  background: var(--bg) !important;
  color: var(--text) !important;
}
.dark .kpi,
.dark .tile,
.dark .drawer,
.dark .card,
.dark header,
.dark .info-card {
  background: var(--card) !important;
  border-color: var(--border) !important;
  color: var(--text) !important;
}
.dark svg text { fill: var(--text) !important; }
.dark .drawer-chart { background: #0F172A !important; }

    :root{
      --bg: #f8fafc;
      --muted:#64748b;
      --card:var(--card);
      --brand:#0ea5e9;
      --accent:#7c3aed;
      --surface:#f1f5f9;
      --text:#0f172a;
      --shadow: 0 12px 30px rgba(15,23,42,0.06);
      --kpi-hover: translateY(-6px);
    }
    @media (prefers-color-scheme: dark) {
      :root{
        --bg: #0b1220;
        --muted: #9aa6b2;
        --card: #071022;
        --brand: #38bdf8;
        --accent: #c4b5fd;
        --surface: #071829;
        --text: #e6eef8;
        --shadow: 0 12px 30px rgba(2,6,23,0.6);
      }
      body { color: var(--text); background: linear-gradient(180deg,#071829 0%, #071022 100%); }
    }

    html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,Arial;color:var(--text)}
    body{background:linear-gradient(180deg,var(--surface) 0%, var(--card) 100%); background-color:var(--bg); -webkit-font-smoothing:antialiased}
    .app{max-width:1200px;margin:20px auto;padding:16px}
    header{display:flex;flex-direction:column;gap:8px;margin-bottom:12px}
    .header-top{display:flex;align-items:center;justify-content:space-between}
    h1{ font-size:20px; margin:0 }
    p.lead{ margin:0; color:var(--muted); font-size:13px }
    .current-date{ font-size:13px; color:var(--muted); margin-top:4px }

    /* =========================
       Buttons (unified with Amort Page)
       ========================= */
    .actions { display:flex; gap:8px; align-items:center }
    .btn{ padding:8px 12px; border-radius:8px; border:1px solid rgba(15,23,42,0.06); background:transparent; cursor:pointer; font-weight:600 }
    .btn.primary{ background:linear-gradient(90deg,var(--brand),var(--accent)); color:white; border:none; box-shadow: var(--shadow) }
    .close-btn{ background:#f1f5f9; border:none; padding:8px; border-radius:8px; cursor:pointer; }

    /* =========================
       KPI row + tiles (unified hover)
       ========================= */
    .kpis{ display:grid; grid-template-columns:repeat(4,1fr); gap:12px; margin:14px 0 18px }
    .kpi{ background:var(--card); padding:14px; border-radius:12px; box-shadow:0 6px 18px rgba(16,24,40,0.04); border:1px solid rgba(15,23,42,0.04); cursor:pointer; transition: transform .18s ease, box-shadow .18s ease; display:flex;flex-direction:column;justify-content:center }
    .kpi:hover, .tile:hover{ transform: var(--kpi-hover); box-shadow:var(--shadow) }
    .kpi h3{ margin:0; font-size:12px; color:var(--muted) }
    .kpi p{ margin:8px 0 0; font-size:18px; font-weight:700 }

    .grid{ display:grid; grid-template-columns:repeat(2,1fr); gap:12px; height:calc(100vh - 320px); overflow:auto; padding-right:6px }
    @media(max-width:900px){ .grid{ grid-template-columns:1fr; height:auto } .kpis{ grid-template-columns:repeat(2,1fr) } }

    .tile{ display:flex; align-items:center; justify-content:space-between; padding:12px; border-radius:12px; background:var(--card); min-height:110px; cursor:pointer; overflow:hidden; transition: transform .18s ease, box-shadow .18s ease; border:1px solid rgba(15,23,42,0.04) }
    .tile-left{ flex:1; padding-right:10px }
    .loan-name{ font-weight:700; font-size:14px }
    .loan-sub{ font-size:12px; color:var(--muted); margin-top:6px }
    .loan-meta{ display:flex; gap:8px; font-size:12px; color:var(--muted); margin-top:8px }

    .chart-wrap{ width:170px; flex-shrink:0; display:flex; flex-direction:column; align-items:flex-end }
    .mini-label{ font-size:12px; color:var(--muted); margin-bottom:6px }
    svg.sparkline{ width:170px; height:48px; display:block }

    /* =========================
       Drawer (with opening animation)
       ========================= */
    .drawer{
      position:fixed; right:0; top:0; height:100vh; max-width:1000px; width:760px; background:var(--card);
      box-shadow:-28px 0 80px rgba(2,6,23,0.14); transform:translateX(110%); transition: transform .32s cubic-bezier(.2,.9,.3,1), opacity .24s ease;
      z-index:120; overflow:auto; padding:20px; opacity:0;
    }
    .drawer.open{ transform:translateX(0); opacity:1; animation: drawerIn .28s cubic-bezier(.2,.9,.3,1); }
    @keyframes drawerIn { from { transform: translateX(30%); opacity:0 } to { transform: translateX(0); opacity:1 } }

    .drawer-head{ display:flex; align-items:start; justify-content:space-between; gap:8px }
    .drawer-chart { width:100%; height:260px; background: linear-gradient(180deg,var(--card),#fcfeff); border-radius:8px; border:1px solid rgba(15,23,42,0.03); margin-bottom:8px; padding:0; position:relative; display:block }

    /* Drawer info row */
    .drawer-info-row { display:flex; gap:12px; margin-bottom:8px; align-items:center }
    .info-card{ flex:1; background:var(--bg); padding:12px; border-radius:8px; display:flex; flex-direction:column; justify-content:center; min-height:56px; }
    .info-card.small{ width:160px; align-items:flex-end }
    .muted-small{ font-size:12px; color:var(--muted); margin-bottom:6px }
    .main-val{ font-weight:800; font-size:18px }

    .amort-wrap{ border:1px solid rgba(15,23,42,0.04); border-radius:8px; padding:8px; max-height:40vh; overflow:auto }
    table{ width:100%; border-collapse:collapse; font-size:13px }
    thead th{ position:sticky; top:0; background:var(--card); padding:8px; text-align:left; color:var(--muted); font-weight:700 }
    td{ padding:8px; border-bottom:1px dashed rgba(15,23,42,0.04); text-align:right }
    td:first-child, th:first-child{ text-align:left }

    .tooltip{ position:fixed; pointer-events:none; background:#0f172a; color:white; padding:6px 8px; border-radius:6px; font-size:12px; transform:translate(-50%,-120%); box-shadow:0 6px 18px rgba(2,6,23,0.2); display:none; z-index:9999; line-height:1.12 }
    .small{ font-size:12px; color:var(--muted) }

    /* tiny responsive tweaks */
    @media(max-width:760px){
      .drawer{ width:100%; min-width:0; }
      .kpis{ grid-template-columns:repeat(2,1fr) }
    }
  
/* Theme toggle switch */
.switch {
  position: relative;
  display: inline-block;
  width: 46px;
  height: 24px;
  margin-left:12px;
}
.switch input {display:none;}
.slider {
  position:absolute;
  cursor:pointer;
  top:0; left:0; right:0; bottom:0;
  background:#cbd5e1;
  transition:.3s;
  border-radius:34px;
}
.slider:before {
  position:absolute;
  content:"";
  height:18px;
  width:18px;
  left:4px;
  bottom:3px;
  background:white;
  transition:.3s;
  border-radius:50%;
}
input:checked + .slider {
  background:linear-gradient(90deg,var(--brand),var(--accent));
}
input:checked + .slider:before {
  transform:translateX(22px);
}


/* Theme toggle switch */
.switch {
  position: relative;
  display: inline-block;
  width: 46px;
  height: 24px;
  margin-left:12px;
}
.switch input {display:none;}
.slider {
  position:absolute;
  cursor:pointer;
  top:0; left:0; right:0; bottom:0;
  background:#cbd5e1;
  transition:.3s;
  border-radius:34px;
}
.slider:before {
  position:absolute;
  content:"";
  height:18px;
  width:18px;
  left:4px;
  bottom:3px;
  background:white;
  transition:.3s;
  border-radius:50%;
}
input:checked + .slider {
  background:linear-gradient(90deg,var(--brand),var(--accent));
}
input:checked + .slider:before {
  transform:translateX(22px);
}


.theme-icon {
  background:none;
  border:none;
  font-size:20px;
  cursor:pointer;
  transition:opacity .2s;
}
.theme-icon:hover { opacity:0.7; }
:root[data-theme="dark"] {
  --bg:#111;
  --text:#eee;
}

</style>
</head>
<body>
  <div class="app" role="main">

      <!-- Header here -->
    <header>
  <div class="header-top">

    <div>
      <h1>Loan Portfolio â€” ROI</h1>
      <p class="lead">Unified design, dark mode, animations, KPI drawers with primary/secondary cards.</p>

      <div class="current-date" style="margin-top:4px;">
        Current Month: <strong id="currentMonthLabel">18</strong>
      </div>
    </div>

    <!-- User + Toggle aligned to the right -->
    <div style="display:flex; gap:10px; align-items:center;">
      <div style="font-size:13px; color:var(--muted)">
        User: <strong style="color:var(--brand)">Jeff L Customer</strong>
      </div>
      <button id="themeToggle" class="theme-icon" title="Toggle dark mode">ðŸŒ™</button>
    </div>

  </div>
</header>

    <!-- KPI Row -->
    <section class="kpis" id="kpis"></section>

    <!-- Loan grid -->
    <section class="grid" id="loanGrid" aria-live="polite"></section>
  </div>

  <!-- Drawer -->
  <aside id="drawer" class="drawer" aria-hidden="true">
    <div class="drawer-head">
      <div>
        <h2 id="drawerTitle">Drawer</h2>
        <div class="muted" id="drawerSub">details</div>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <button class="btn" id="downloadCsvBtn">Download CSV</button>
        <button class="close-btn" id="closeBtn" aria-label="Close drawer">âœ•</button>
      </div>
    </div>

    <div class="drawer-info-row">
      <div class="info-card" id="drawerPrimaryCard">
        <div class="muted-small" id="drawerPrimaryTitle">Primary</div>
        <div id="drawerPrimary" class="main-val"></div>
      </div>
      <div class="info-card small" id="drawerSecondaryCard">
        <div class="muted-small" id="drawerSecondaryTitle">Secondary</div>
        <div id="drawerSecondary" class="main-val small"></div>
      </div>
    </div>

    <div id="drawerBody">
      <div class="drawer-chart" id="drawerChartArea"></div>
      <div class="legend" id="drawerLegend" style="display:none"></div>
      <div id="drawerExtra"></div>

      <div style="margin-top:12px" id="drawerAmortContainer"></div>

      <div class="actions" style="padding-top:10px">
        <button class="btn" id="printBtn">Print</button>
        <button class="btn primary" id="copyCsvBtn">Copy CSV</button>
      </div>
    </div>
  </aside>

  <div id="tooltip" class="tooltip" role="status" aria-live="polite"></div>

  <!-- ====================================
       Script (organized with sections)
       ==================================== -->
  <script>
    /* -------------------------
       Settings & data
       ------------------------- */
    const CURRENT_MONTH = 18;
    document.getElementById('currentMonthLabel').textContent = CURRENT_MONTH;

    function monthDiff(d1,d2){ const a=new Date(d1); const b=new Date(d2); return (b.getFullYear()-a.getFullYear())*12 + (b.getMonth()-a.getMonth()); }

    const loans = [
      { id:1, purchaseDate:'2024-01-01', purchasePrice:7000, termYears:10, graceYears:0.83, nominalRate:0.0883 },
      { id:2, purchaseDate:'2024-02-01', purchasePrice:7500, termYears:8, graceYears:2, nominalRate:0.075 },
      { id:3, purchaseDate:'2024-03-01', purchasePrice:12000, termYears:12, graceYears:3, nominalRate:0.0825 },
      { id:4, purchaseDate:'2024-04-01', purchasePrice:6000, termYears:9, graceYears:1.5, nominalRate:0.095 },
      { id:5, purchaseDate:'2024-07-01', purchasePrice:5000, termYears:10, graceYears:1, nominalRate:0.09 },
      { id:6, purchaseDate:'2025-01-01', purchasePrice:7500, termYears:5, graceYears:0, nominalRate:0.073 },
      { id:7, purchaseDate:'2025-06-01', purchasePrice:10000, termYears:8, graceYears:0, nominalRate:0.09 },
      { id:8, purchaseDate:'2025-10-01', purchasePrice:5000, termYears:9, graceYears:0.5, nominalRate:0.11 },
      { id:9, purchaseDate:'2025-02-01', purchasePrice:10000, termYears:7, graceYears:0.25, nominalRate:0.10 },
      { id:10,purchaseDate:'2025-03-01', purchasePrice:8000, termYears:3, graceYears:0, nominalRate:0.06 }
    ];

    /* -------------------------
       Amortization logic
       ------------------------- */
    function calcAmort(principal, annualRate, termYears, graceYears){
      const monthlyRate = annualRate/12;
      const totalMonths = Math.round(termYears*12);
      const graceMonths = Math.round(graceYears*12);
      const repayMonths = Math.max(1, totalMonths - graceMonths);
      let balance = principal; const schedule=[];
      for(let m=1;m<=graceMonths;m++){ const interest = +(balance*monthlyRate).toFixed(2); balance = +(balance + interest).toFixed(2); schedule.push({ monthIndex:m, payment:0, principalPaid:0, interest, balance }); }
      const payment = monthlyRate===0 ? +(balance/repayMonths).toFixed(2) : +((balance*monthlyRate)/(1-Math.pow(1+monthlyRate,-repayMonths))).toFixed(2);
      for(let m=1;m<=repayMonths;m++){ const interest = +(balance*monthlyRate).toFixed(2); const principalPaid = +Math.min(balance, +(payment - interest).toFixed(2)); balance = +(Math.max(0, balance - principalPaid).toFixed(2)); schedule.push({ monthIndex: graceMonths + m, payment:+payment.toFixed(2), principalPaid, interest, balance }); }
      return { payment, schedule };
    }

    const loansWithAmort = loans.map(l => {
      const amort = calcAmort(l.purchasePrice, l.nominalRate, l.termYears, l.graceYears);
      let cumP=0, cumI=0, cumTotal=0;
      const cumSchedule = amort.schedule.map(r => { cumP=+(cumP+r.principalPaid).toFixed(2); cumI=+(cumI+r.interest).toFixed(2); cumTotal=+(cumTotal+r.payment).toFixed(2); return {...r, cumPrincipal:cumP, cumInterest:cumI, cumTotal}; });

    // Loan 1 monthly fees (from ROI.xlsx). Index 0 => month 1
    const loan1FeeSeries = [8.562578,8.624465,8.686342,8.748219,8.810096,8.871973,8.933841,8.995708,9.057576,9.119434,9.733353,9.685593,9.637483,9.589013,9.540192,9.491009,9.441454,9.391548,9.341268,9.290616,9.239599,9.1882,9.136436,9.084276,9.031741,8.97881,8.925502,8.871797,8.817685,8.763185,8.708287,8.652991,8.597273,8.541157,8.484621,8.427674,8.370303,8.31251,8.254297,8.195639,8.136567,8.077051,8.017091,7.956705,7.895874,7.834587,7.772853,7.710671,7.648021,7.584912,7.521343,7.457306,7.392797,7.327808,7.262347,7.196403,7.129967,7.063046,6.995633,6.927725,6.859321,6.790412,6.720986,6.651062,6.580621,6.509651,6.438173,6.366154,6.293616,6.220546,6.146934,6.072779,5.998083,5.922842,5.847037,5.770675,5.693749,5.616266,5.538215,5.459587,5.38037,5.300572,5.220194,5.139227,5.057658,4.975485,4.893381,4.810673,4.727349,4.64342,4.558875,4.473702,4.387901,4.301471,4.214401,4.12669,4.038339,3.949336,3.85968,3.769359,3.678374,3.586724,3.494398,3.401395,3.307703,3.213322,3.118253,3.022483,2.926,2.828816,2.730919,2.632297,2.53295,2.432866,2.332045,2.230487,2.12818,2.025124,1.921306,1.816727,1.711375,1.605249,1.498338,1.390642,1.28216,1.172881,1.062792,0.951893,0.840185,0.727655];
      const roiSeries = cumSchedule.map(s => { const loanValue = s.balance + s.cumInterest + s.cumTotal; const roi = (loanValue - l.purchasePrice)/l.purchasePrice; return { month:s.monthIndex, roi, loanValue }; });
      const miniPts = roiSeries.slice(0, Math.min(24, roiSeries.length)).map(s=>({ x:s.month, y:s.roi }));
      return {...l, amort, cumSchedule, roiSeries, miniPts };
    });

    /* -------------------------
       KPI computations
       ------------------------- */
    function computeKPIs(list){
      const total = list.reduce((s,l)=>s + l.purchasePrice,0);
      const weightedROI = list.reduce((s,l)=> s + l.purchasePrice * ( (l.roiSeries[Math.min(CURRENT_MONTH-1, l.roiSeries.length-1)] || {}).roi || 0 ), 0) / Math.max(1, total);
      const projectedWeightedROI = list.reduce((s,l)=> s + l.purchasePrice * ( (l.roiSeries[l.roiSeries.length-1] || {}).roi || 0 ), 0) / Math.max(1, total);
      const avgRate = list.reduce((s,l)=> s + l.nominalRate * l.purchasePrice, 0) / Math.max(1, total);
      return { total, weightedROI, projectedWeightedROI, avgRate };
    }
    const kpis = computeKPIs(loansWithAmort);

    /* -------------------------
       Small chart utilities (line & bar with hover)
       ------------------------- */
    function createLineChart(containerEl, series, opts = {}) {
      containerEl.innerHTML = '';
      const svgNS = "http://www.w3.org/2000/svg";
      const rect = containerEl.getBoundingClientRect();
      const w = Math.max(360, rect.width || 600);
      const h = opts.h || 260;
      const pad = opts.pad || 28;
      const svg = document.createElementNS(svgNS, "svg");
      svg.setAttribute("viewBox", `0 0 ${w} ${h}`); svg.setAttribute("width", "100%"); svg.setAttribute("height", "100%"); svg.style.display="block";
      const data = series.length ? series.slice() : [{x:0,y:0}];
      const ys = data.map(d=>d.y); const xs = data.map(d=>d.x);
      const minY = Math.min(...ys); const maxY = Math.max(...ys); const rangeY = Math.max(1e-6, maxY - minY);
      const stepX = (w - pad*2) / Math.max(1, data.length - 1);
      function toXY(d,i){ const x = pad + i*stepX; const y = pad + (h - pad*2) - ((d.y - minY)/rangeY)*(h - pad*2); return [x,y]; }
      // grid
      for(let gy=0;gy<5;gy++){ const y=pad+gy*((h-pad*2)/4); const line=document.createElementNS(svgNS,'line'); line.setAttribute('x1',pad); line.setAttribute('x2',w-pad); line.setAttribute('y1',y); line.setAttribute('y2',y); line.setAttribute('stroke','#eef2f7'); svg.appendChild(line); }
      // path
      let path=''; data.forEach((p,i)=>{ const xy=toXY(p,i); path += (i===0?('M '+xy[0]+' '+xy[1]):(' L '+xy[0]+' '+xy[1])); });
      const el=document.createElementNS(svgNS,'path'); el.setAttribute('d',path); el.setAttribute('fill','none'); el.setAttribute('stroke',opts.color||'#0ea5e9'); el.setAttribute('stroke-width','2'); svg.appendChild(el);
      // === Add vertical line for CURRENT_MONTH (global) ===
if (typeof CURRENT_MONTH !== "undefined") {
  const monthIndex = CURRENT_MONTH - 1; 
  if (monthIndex >= 0 && monthIndex < data.length) {
    const [cx] = toXY(data[monthIndex], monthIndex);

    const vLine = document.createElementNS(svgNS, "line");
    vLine.setAttribute("x1", cx);
    vLine.setAttribute("x2", cx);
    vLine.setAttribute("y1", pad);
    vLine.setAttribute("y2", h - pad);
    vLine.setAttribute("stroke", "#111827");
    vLine.setAttribute("stroke-dasharray", "3 3");
    vLine.setAttribute("stroke-opacity", "0.6");

    svg.appendChild(vLine);
  }
}

      // hover
      const vLine=document.createElementNS(svgNS,'line'); vLine.setAttribute('stroke','#111827'); vLine.setAttribute('stroke-dasharray','3 4'); vLine.setAttribute('stroke-opacity','0.6'); svg.appendChild(vLine);
      const hoverG=document.createElementNS(svgNS,'g'); hoverG.setAttribute('class','hover'); svg.appendChild(hoverG);
      svg.addEventListener('mousemove', function(ev){ const rect=svg.getBoundingClientRect(); const svgX=ev.clientX-rect.left; let idx=Math.round((svgX-pad)/stepX); idx=Math.max(0,Math.min(data.length-1,idx)); const point=data[idx]; const [cx,cy]=toXY(point,idx); vLine.setAttribute('x1',cx); vLine.setAttribute('x2',cx); vLine.setAttribute('y1',pad); vLine.setAttribute('y2',h-pad); hoverG.innerHTML=''; const c=document.createElementNS(svgNS,'circle'); c.setAttribute('cx',cx); c.setAttribute('cy',cy); c.setAttribute('r',4); c.setAttribute('fill',opts.color||'#0ea5e9'); c.setAttribute('stroke','var(--card)'); c.setAttribute('stroke-width','1'); hoverG.appendChild(c); tooltip.style.display='block'; tooltip.style.left=(rect.left+cx)+'px'; tooltip.style.top=(rect.top+cy-28)+'px'; tooltip.innerHTML = (opts.labelFn?opts.labelFn(point, idx):(`M${point.x} â€¢ ${(point.y*100).toFixed(2)}%`)); });
      svg.addEventListener('mouseleave', function(){ hoverG.innerHTML=''; tooltip.style.display='none'; });
      containerEl.appendChild(svg); return svg;
    }

function createBarChart(containerEl, keys, values, opts = {}) {
  containerEl.innerHTML = '';

  const svgNS = "http://www.w3.org/2000/svg";
  const rect = containerEl.getBoundingClientRect();
  const w = Math.max(360, rect.width || 600);
  const h = opts.h || 260;

  const padL = opts.padL || 55;
  const padR = opts.padR || 20;
  const padT = opts.padT || 25;
  const padB = opts.padB || 55;

  const svg = document.createElementNS(svgNS, "svg");
  svg.setAttribute("viewBox", `0 0 ${w} ${h}`);
  svg.setAttribute("width", "100%");
  svg.setAttribute("height", "100%");
  svg.style.display = "block";

  const maxValue = Math.max(...values, 1);
  const barW = (w - padL - padR) / Math.max(1, keys.length);

  // --- GRID LINES + Y LABELS ---
  for (let i = 0; i <= 5; i++) {
    const y = padT + (h - padT - padB) * (i / 5);

    const line = document.createElementNS(svgNS, "line");
    line.setAttribute("x1", padL);
    line.setAttribute("x2", w - padR);
    line.setAttribute("y1", y);
    line.setAttribute("y2", y);
    line.setAttribute("stroke", "var(--border)");
    line.setAttribute("stroke-opacity", "0.35");
    svg.appendChild(line);

    const value = maxValue * (1 - i / 5);
    const lbl = document.createElementNS(svgNS, "text");
    lbl.textContent = "$" + Math.round(value).toLocaleString();
    lbl.setAttribute("x", padL - 10);
    lbl.setAttribute("y", y + 4);
    lbl.setAttribute("font-size", "11");
    lbl.setAttribute("fill", "var(--text)");
    lbl.setAttribute("text-anchor", "end");
    svg.appendChild(lbl);
  }

  // --- HOVER GROUP (created now, appended later so it stays on TOP) ---
  const hoverG = document.createElementNS(svgNS, "g");
  hoverG.setAttribute("class", "hover");

  // --- DRAW BARS ---
  keys.forEach((k, i) => {
    const amount = values[i];

    const x = padL + i * barW;
    const barH = (amount / maxValue) * (h - padT - padB);
    const y = h - padB - barH;

    const bar = document.createElementNS(svgNS, "rect");
    bar.setAttribute("x", x + 6);
    bar.setAttribute("y", y);
    bar.setAttribute("width", barW - 12);
    bar.setAttribute("height", barH);
    bar.setAttribute("rx", 4);
    bar.setAttribute("fill", opts.color || "#0ea5e9");
    bar.style.cursor = "pointer";

    // --- UNIFIED HOVER TOOLTIP ---
    bar.addEventListener("mousemove", (ev) => {
      const rectSvg = svg.getBoundingClientRect();
      const cx = ev.clientX - rectSvg.left;
      const cy = ev.clientY - rectSvg.top;

      hoverG.innerHTML = "";

      // black floating tooltip box above bar
      const tipBg = document.createElementNS(svgNS, "rect");
      tipBg.setAttribute("x", cx - 45);
      tipBg.setAttribute("y", cy - 38);
      tipBg.setAttribute("width", 90);
      tipBg.setAttribute("height", 26);
      tipBg.setAttribute("rx", 6);
      tipBg.setAttribute("fill", "black");
      tipBg.setAttribute("opacity", "0.85");

      const tipTxt = document.createElementNS(svgNS, "text");
      tipTxt.textContent = "$" + amount.toLocaleString();
      tipTxt.setAttribute("x", cx);
      tipTxt.setAttribute("y", cy - 21);
      tipTxt.setAttribute("font-size", "12");
      tipTxt.setAttribute("font-weight", "600");
      tipTxt.setAttribute("fill", "white");
      tipTxt.setAttribute("text-anchor", "middle");

      hoverG.appendChild(tipBg);
      hoverG.appendChild(tipTxt);
    });

    bar.addEventListener("mouseleave", () => {
      hoverG.innerHTML = "";
    });

    svg.appendChild(bar);

    // X axis labels
    const lbl = document.createElementNS(svgNS, "text");
    lbl.textContent = k;
    lbl.setAttribute("x", x + barW / 2);
    lbl.setAttribute("y", h - padB + 22);
    lbl.setAttribute("font-size", "11");
    lbl.setAttribute("fill", "var(--text)");
    lbl.setAttribute("text-anchor", "middle");
    svg.appendChild(lbl);
  });

  // --- ADD HOVER GROUP LAST (IMPORTANT: fixes tooltip behind bars) ---
  svg.appendChild(hoverG);

  containerEl.appendChild(svg);
  return svg;
}


    function createHistogram(containerEl, values, bins=6, opts={}) {
      containerEl.innerHTML=''; const minV=Math.min(...values); const maxV=Math.max(...values); const range=Math.max(1e-6,maxV-minV); const binSize=range/bins; const counts=new Array(bins).fill(0); values.forEach(v=>{ let idx=Math.floor((v-minV)/binSize); if(idx===bins) idx=bins-1; counts[idx]++; }); const labels=counts.map((_,i)=>{ const a=minV+i*binSize; const b=a+binSize; return `${(a*100).toFixed(1)}â€“${(b*100).toFixed(1)}%`; }); return createBarChart(containerEl, labels, counts, opts); }

    /* -------------------------
       UI: Render KPI tiles
       ------------------------- */
    const kpisEl = document.getElementById('kpis');
    kpisEl.innerHTML = `
      <div class="kpi" data-kpi="distribution"><h3>Total Loans</h3><p>${loansWithAmort.length}</p></div>
      <div class="kpi" data-kpi="tpv"><h3>Weighted ROI to Date</h3><p id="wroi">${(kpis.weightedROI*100).toFixed(2)}%</p></div>
      <div class="kpi" data-kpi="rates"><h3>Projected Weighted ROI</h3><p id="wproj">${(kpis.projectedWeightedROI*100).toFixed(2)}%</p></div>
      <div class="kpi" data-kpi="payments"><h3>Avg Rate</h3><p>${(kpis.avgRate*100).toFixed(2)}%</p></div>
    `;

    /* -------------------------
       Render loan tiles + mini charts
       ------------------------- */
    const grid = document.getElementById('loanGrid');
    const tooltip = document.getElementById('tooltip');

    loansWithAmort.forEach((loan, idx) => {
      const tile = document.createElement('div'); tile.className='tile'; tile.setAttribute('tabindex','0');
      tile.innerHTML = `
        <div class="tile-left">
          <div class="loan-name">Loan ${loan.id}</div>
          <div class="loan-sub">$${loan.purchasePrice.toLocaleString()}</div>
          <div class="loan-meta"><div>Term: ${loan.termYears}y</div><div>Grace: ${loan.graceYears}y</div></div>
        </div>
        <div class="chart-wrap">
          <div class="mini-label">
  ROI ${(((loan.roiSeries[Math.min(CURRENT_MONTH - 1, loan.roiSeries.length - 1)] || {}).roi || 0) * 100).toFixed(2)}%
</div>
          <svg class="sparkline" viewBox="0 0 170 48" preserveAspectRatio="none" data-idx="${idx}" aria-hidden="true"></svg>
        </div>
      `;
      tile.addEventListener('click', e=>{ e.stopPropagation(); openDrawerForLoan(loan); });
      tile.addEventListener('keydown', e=>{ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); openDrawerForLoan(loan); } });
      grid.appendChild(tile);

      // render mini chart: cumulative ROI points
      const svg = tile.querySelector('svg.sparkline');
      const w=170,h=48,pad=6;
      const pts = loan.miniPts && loan.miniPts.length ? loan.miniPts : loan.roiSeries.map(s=>({x:s.month,y:s.roi}));
      const ys = pts.map(p=>p.y); const minY=Math.min(...ys); const maxY=Math.max(...ys); const rangeY=Math.max(1e-6,maxY-minY);
      const stepX=(w-pad*2)/Math.max(1,pts.length-1);
      let d=''; pts.forEach((p,i)=>{ const x=pad + i*stepX; const y = pad + (h - pad*2) - ((p.y - minY)/rangeY)*(h - pad*2); d += (i===0?('M '+x+' '+y):(' L '+x+' '+y)); });
      svg.innerHTML = `<path d="${d}" fill="none" stroke="#0ea5e9" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"></path><g class="mini-hover"></g>`;
      // current date vertical line per-loan
      const earliestDate = "2024-01-01"; const diff = monthDiff(earliestDate, loan.purchaseDate); let curIdxForLoan = CURRENT_MONTH - diff; curIdxForLoan = Math.max(1, Math.min(loan.roiSeries.length, curIdxForLoan)); const dashX = pad + (curIdxForLoan-1)*((w-pad*2)/Math.max(1,loan.roiSeries.length-1));
      const line = document.createElementNS('http://www.w3.org/2000/svg','line'); line.setAttribute('x1',dashX); line.setAttribute('x2',dashX); line.setAttribute('y1',2); line.setAttribute('y2',h-2); line.setAttribute('stroke','#111827'); line.setAttribute('stroke-dasharray','3 3'); line.setAttribute('stroke-opacity','0.6'); svg.appendChild(line);
      svg.addEventListener('mousemove', ev=>{ const rect=svg.getBoundingClientRect(); const relX=ev.clientX-rect.left; const step = (w-pad*2)/Math.max(1,pts.length-1); let idxNearest=Math.round((relX-pad)/step); idxNearest=Math.max(0,Math.min(pts.length-1,idxNearest)); const pt=pts[idxNearest]; const p = loan.roiSeries[pt.x-1]||loan.roiSeries[idxNearest]; tooltip.style.left=ev.clientX+'px'; tooltip.style.top=(ev.clientY-10)+'px'; tooltip.style.display='block'; tooltip.innerHTML = 'M'+p.month+' â€¢ ROI '+(p.roi*100).toFixed(2)+'%'; const hoverG = svg.querySelector('g.mini-hover'); hoverG.innerHTML=''; const cx = pad + idxNearest*step; const cy = pad + (h - pad*2) - ((pt.y - minY)/rangeY)*(h - pad*2); const c=document.createElementNS('http://www.w3.org/2000/svg','circle'); c.setAttribute('cx',cx); c.setAttribute('cy',cy); c.setAttribute('r',3.6); c.setAttribute('fill','#0ea5e9'); c.setAttribute('stroke','var(--card)'); c.setAttribute('stroke-width','1'); hoverG.appendChild(c); });
      svg.addEventListener('mouseleave', ()=>{ tooltip.style.display='none'; const hoverG = svg.querySelector('g.mini-hover'); if(hoverG) hoverG.innerHTML=''; });
    });

    /* -------------------------
       Drawer helpers & openers
       ------------------------- */
    const drawer = document.getElementById('drawer');
    const drawerTitle = document.getElementById('drawerTitle');
    const drawerSub = document.getElementById('drawerSub');
    const drawerPrimaryTitle = document.getElementById('drawerPrimaryTitle');
    const drawerPrimary = document.getElementById('drawerPrimary');
    const drawerSecondaryTitle = document.getElementById('drawerSecondaryTitle');
    const drawerSecondary = document.getElementById('drawerSecondary');
    const drawerChartArea = document.getElementById('drawerChartArea');
    const drawerLegend = document.getElementById('drawerLegend');
    const drawerExtra = document.getElementById('drawerExtra');
    const drawerAmortContainer = document.getElementById('drawerAmortContainer');

    document.getElementById('closeBtn').addEventListener('click', closeDrawer);
    document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeDrawer(); });

    function closeDrawer(){ drawer.classList.remove('open'); drawer.setAttribute('aria-hidden','true'); tooltip.style.display='none'; currentLoan=null; currentMode=null; }

    let currentLoan=null, currentMode=null;

    function openDrawerForLoan(loan){
      currentMode='loan'; currentLoan=loan;
      drawerTitle.textContent = 'Loan ' + loan.id;
      drawerSub.textContent = 'Purchased: ' + loan.purchaseDate;
      drawerPrimaryTitle.textContent = 'Purchase Price'; drawerPrimary.textContent = '$' + loan.purchasePrice.toLocaleString();
      drawerSecondaryTitle.textContent = 'Nominal Rate'; drawerSecondary.textContent = (loan.nominalRate*100).toFixed(2)+'%';
      drawerExtra.innerHTML=''; drawerLegend.style.display='flex'; drawerLegend.innerHTML = '<div class=\"item\"><span class=\"sw\" style=\"background:#0f172a\"></span>Balance</div><div class=\"item\"><span class=\"sw\" style=\"background:#0ea5e9\"></span>ROI</div>';

      const series = loan.roiSeries.map(s=>({x:s.month,y:s.roi}));
      createLineChart(drawerChartArea, series, { color:'#0ea5e9', labelFn:(pt)=>`M${pt.x} â€¢ ROI ${(pt.y*100).toFixed(2)}%` });

      // ROI-by-month table (replaces amort table)
      drawerAmortContainer.innerHTML = '<h3 style="margin-top:8px">ROI by Month</h3><div class="amort-wrap"><table><thead><tr><th>Month</th><th style="text-align:right">Balance</th><th style="text-align:right">Cum Interest</th><th style="text-align:right">Cum Payments</th><th style="text-align:right">Cum Fees</th><th style="text-align:right">Loan Value</th><th style="text-align:right">ROI</th></tr></thead><tbody id="roiBody"></tbody></table></div>';
      const roiBody = document.getElementById('roiBody');
      roiBody.innerHTML = '';
      // build rows using cumSchedule and roiSeries, accounting for fees (loan1FeeSeries from embedded Excel; loans 2-10 assume $3/mo)
      loan.roiSeries.forEach(s => {
        const month = s.month;
        // find cumulative schedule entry
        const cs = loan.cumSchedule.find(r => r.monthIndex === month) || {};
        const balance = (cs.balance !== undefined) ? cs.balance : '';
        const cumInterest = (cs.cumInterest !== undefined) ? cs.cumInterest : '';
        const cumPayments = (cs.cumTotal !== undefined) ? cs.cumTotal : '';
        // cumulative fees
        let cumFees = 0;
cumFees = 3 * month;
        const loanValueAdj = (s.loanValue || 0) - cumFees;
        const roiAdj = ((loanValueAdj - loan.purchasePrice) / loan.purchasePrice) || 0;
        const tr = document.createElement('tr');
        tr.innerHTML = `<td style="text-align:left">${month}</td><td style="text-align:right">$${Number(balance).toFixed(2)}</td><td style="text-align:right">$${Number(cumInterest).toFixed(2)}</td><td style="text-align:right">$${Number(cumPayments).toFixed(2)}</td><td style="text-align:right">$${Number(cumFees).toFixed(2)}</td><td style="text-align:right">$${Number(loanValueAdj).toFixed(2)}</td><td style="text-align:right">${(roiAdj*100).toFixed(2)}%</td>`;
        roiBody.appendChild(tr);
      });

      drawer.classList.add('open'); drawer.setAttribute('aria-hidden','false'); drawer.scrollTop=0;
    }

    /* -------------------------
       KPI drawer renderers
       ------------------------- */
    function getMonthlyTotals(list){ const totals={}; list.forEach(l=>{ const d=new Date(l.purchaseDate); const key=`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`; totals[key]=(totals[key]||0)+l.purchasePrice; }); return totals; }

    function renderDistributionDrawer(){
      currentMode='kpi'; currentLoan=null;
      drawerAmortContainer.innerHTML = '';
      drawerTitle.textContent='Total Loans'; drawerSub.textContent='Loan Purchase Amounts Per Month';
      const totalsObj=getMonthlyTotals(loansWithAmort); const keys=Object.keys(totalsObj).sort(); const values=keys.map(k=>totalsObj[k]); const totalInv=values.reduce((a,b)=>a+b,0);
      drawerPrimaryTitle.textContent='Total Invested'; drawerPrimary.textContent='$'+totalInv.toLocaleString();
      drawerSecondaryTitle.textContent='Total Loans'; drawerSecondary.textContent=loansWithAmort.length+' loans';
      createBarChart(drawerChartArea, keys, values, { color:'#0ea5e9' });
      drawerExtra.innerHTML = `<h3 style="margin-top:12px;margin-bottom:8px">Loans</h3><div style="border:1px solid rgba(15,23,42,0.06);border-radius:8px;max-height:260px;overflow:auto;background:var(--card);padding:6px;"><table style="width:100%;font-size:13px"><thead><tr><th style="text-align:left">Loan</th><th style="text-align:left">Purchase</th><th>Amount</th><th>Rate</th></tr></thead><tbody>${loansWithAmort.map(l=>`<tr><td style="text-align:left">Loan ${l.id}</td><td>${l.purchaseDate}</td><td>$${l.purchasePrice.toLocaleString()}</td><td>${(l.nominalRate*100).toFixed(2)}%</td></tr>`).join('')}</tbody></table></div>`;
      drawer.classList.add('open'); drawer.setAttribute('aria-hidden','false');
    }

    function renderTPVDrawer(){
      currentMode='kpi'; currentLoan=null;
      drawerAmortContainer.innerHTML = '';
      drawerTitle.textContent='Portfolio â€” Weighted ROI (To Date)'; drawerSub.textContent='Snapshot';
      const monthsMax = Math.max(...loansWithAmort.map(l=>l.roiSeries.length)); const upTo = Math.min(monthsMax, Math.max(CURRENT_MONTH,1));
      const series=[]; for(let m=1;m<=upTo;m++){ let totalInvested=0, weightedSum=0; loansWithAmort.forEach(l=>{ const entry=l.roiSeries.find(r=>r.month===m); if(entry){ weightedSum += l.purchasePrice*entry.roi; totalInvested += l.purchasePrice; } }); series.push({x:m,y: totalInvested?weightedSum/totalInvested:0}); }
      drawerPrimaryTitle.textContent='Weighted ROI to Date'; drawerPrimary.textContent=(kpis.weightedROI*100).toFixed(2)+'%';
      const portfolioValue = loansWithAmort.reduce((s,l)=>{ const idx=Math.min(CURRENT_MONTH-1,l.roiSeries.length-1); const row=l.roiSeries[idx]||{loanValue:l.purchasePrice}; return s + (row.loanValue||l.purchasePrice); },0);
      drawerSecondaryTitle.textContent='Portfolio Value'; drawerSecondary.textContent='$'+portfolioValue.toLocaleString();
      createLineChart(drawerChartArea, series, { color:'#0f172a', labelFn:(pt)=>`M${pt.x} â€¢ Weighted ROI ${(pt.y*100).toFixed(2)}%` });
      drawerExtra.innerHTML=`<div style="margin-top:10px"><strong class="small">Weighted ROI to date</strong><div style="font-size:18px;font-weight:800;margin-top:6px">${(kpis.weightedROI*100).toFixed(2)}%</div></div>`;
      drawer.classList.add('open'); drawer.setAttribute('aria-hidden','false');
    }

    function renderRatesDrawer(){
      currentMode='kpi'; currentLoan=null;
      drawerAmortContainer.innerHTML = '';
      drawerTitle.textContent='Projected Weighted ROI'; drawerSub.textContent='Projection to maturity';
      const projectedPortfolioValue = loansWithAmort.reduce((s,l)=>{ const last=l.roiSeries[l.roiSeries.length-1]||{loanValue:l.purchasePrice}; return s + (last.loanValue||l.purchasePrice); },0);
      drawerPrimaryTitle.textContent='Projected Weighted ROI'; drawerPrimary.textContent=(kpis.projectedWeightedROI*100).toFixed(2)+'%';
      drawerSecondaryTitle.textContent='Projected Portfolio Value'; drawerSecondary.textContent='$'+projectedPortfolioValue.toLocaleString();
      const monthsMax = Math.max(...loansWithAmort.map(l=>l.roiSeries.length)); const series=[]; for(let m=1;m<=monthsMax;m++){ let total=0, weighted=0; loansWithAmort.forEach(l=>{ const e=l.roiSeries.find(r=>r.month===m); if(e){ weighted += l.purchasePrice*e.roi; total += l.purchasePrice; } }); series.push({x:m,y: total?weighted/total:0}); }
      createLineChart(drawerChartArea, series, { color:'#7c3aed', labelFn:(pt)=>`M${pt.x} â€¢ Projected ROI ${(pt.y*100).toFixed(2)}%` });
      drawerExtra.innerHTML=`<div style="margin-top:10px"><strong class="small">Projected Weighted ROI (to maturity)</strong></div>`;
      drawer.classList.add('open'); drawer.setAttribute('aria-hidden','false');
    }

    function renderPaymentsDrawer(){
      currentMode='kpi'; currentLoan=null;
      drawerAmortContainer.innerHTML = '';
      drawerTitle.textContent='Average / Rate Distribution'; drawerSub.textContent='Portfolio nominal rates';
      drawerPrimaryTitle.textContent='Average Rate'; drawerPrimary.textContent=(kpis.avgRate*100).toFixed(2)+'%';
      const total=loansWithAmort.reduce((s,l)=>s+l.purchasePrice,0); const weightedAvg = loansWithAmort.reduce((s,l)=>s+l.nominalRate*l.purchasePrice,0)/Math.max(1,total);
      drawerSecondaryTitle.textContent='Weighted Avg Rate'; drawerSecondary.textContent=(weightedAvg*100).toFixed(2)+'%';
      const rates=loansWithAmort.map(l=>l.nominalRate); createHistogram(drawerChartArea, rates, 6, { color:'#0ea5e9' });
      drawerExtra.innerHTML=`<div style="margin-top:10px" class="small">Rates range: ${(Math.min(...rates)*100).toFixed(2)}% â€” ${(Math.max(...rates)*100).toFixed(2)}%</div>`;
      drawer.classList.add('open'); drawer.setAttribute('aria-hidden','false');
    }

    /* -------------------------
       KPI wiring & interactions
       ------------------------- */
    document.querySelectorAll('.kpi').forEach(k=>{ k.addEventListener('click', ev=>{ ev.stopPropagation(); const key=k.getAttribute('data-kpi'); if(key==='distribution') renderDistributionDrawer(); if(key==='tpv') renderTPVDrawer(); if(key==='rates') renderRatesDrawer(); if(key==='payments') renderPaymentsDrawer(); }); });

    /* -------------------------
       CSV / clipboard / download / print
       ------------------------- */
    function copyPortfolioCSV(){ let rows=[['Loan','Purchase Date','Amount','Rate']]; loansWithAmort.forEach(l=>rows.push(['Loan '+l.id,l.purchaseDate,l.purchasePrice,(l.nominalRate*100).toFixed(2)+'%'])); const csv=rows.map(r=>r.join(',')).join('\n'); navigator.clipboard.writeText(csv); alert('CSV copied to clipboard'); }
    function amortToCSV(loan){ const rows=[['Month','Payment','Principal','Interest','Balance']]; loan.amort.schedule.forEach(r=>rows.push([r.monthIndex,r.payment.toFixed(2),r.principalPaid.toFixed(2),r.interest.toFixed(2),r.balance.toFixed(2)])); return rows.map(r=>r.join(',')).join('\n'); }
    document.getElementById('copyCsvBtn')?.addEventListener('click', async ()=>{ if(currentMode!=='loan' || !currentLoan) return alert('Open an individual loan drawer to copy CSV'); const csv=amortToCSV(currentLoan); try{ await navigator.clipboard.writeText(csv); alert('CSV copied to clipboard'); }catch(e){ alert('Copy failed â€” browser denied clipboard access'); } });
    document.getElementById('downloadCsvBtn')?.addEventListener('click', ()=>{ if(currentMode==='loan' && currentLoan){ const csv=amortToCSV(currentLoan); const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='loan-'+currentLoan.id+'-amort.csv'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url); } else alert('Download CSV is supported for individual loan drawers only.'); });
    document.getElementById('printBtn')?.addEventListener('click', ()=>window.print());

    /* -------------------------
       Close drawer on outside click; hide tooltip on scroll
       ------------------------- */
    document.addEventListener('click', function(e){ if(!drawer.classList.contains('open')) return; const clickedInside=drawer.contains(e.target); const clickedTile=!!e.target.closest('.tile'); if(!clickedInside && !clickedTile) closeDrawer(); });
    document.querySelector('.grid').addEventListener('scroll', ()=>{ tooltip.style.display='none'; });

    /* -------------------------
       End
       ------------------------- */
  


// icon toggle
document.addEventListener("DOMContentLoaded", () => {
  const btn = document.getElementById("themeToggle");
  if (!btn) return;  // prevents null errors

  const applyTheme = (theme) => {
    document.documentElement.setAttribute("data-theme", theme);
    localStorage.setItem("theme", theme);
    btn.textContent = theme === "dark" ? "â˜€ï¸" : "ðŸŒ™";
  };

  const saved = localStorage.getItem("theme") || "light";
  applyTheme(saved);

  btn.addEventListener("click", () => {
    const newTheme =
      document.documentElement.getAttribute("data-theme") === "dark"
        ? "light"
        : "dark";
    applyTheme(newTheme);
  });
});


</script>
</body>
</html>

<!-- Added customTooltip function -->
<script>
function customTooltip(context) {
    let tooltipEl = document.getElementById('chartjs-tooltip');
    if (!tooltipEl) {
        tooltipEl = document.createElement('div');
        tooltipEl.id = 'chartjs-tooltip';
        tooltipEl.style.position = 'absolute';
        tooltipEl.style.background = 'rgba(0,0,0,0.85)';
        tooltipEl.style.color = 'var(--card)';
        tooltipEl.style.padding = '8px 12px';
        tooltipEl.style.borderRadius = '6px';
        tooltipEl.style.pointerEvents = 'none';
        tooltipEl.style.transition = '0.1s ease';
        tooltipEl.style.zIndex = '9999';
        document.body.appendChild(tooltipEl);
    }
    const tooltip = context.tooltip;
    if (tooltip.opacity === 0) {
        tooltipEl.style.opacity = 0;
        return;
    }
    tooltipEl.style.opacity = 1;
    tooltipEl.innerHTML = `<div style="font-weight:600;font-size:13px;">${tooltip.dataPoints[0].formattedValue}</div>`;
    const { offsetLeft, offsetTop } = context.chart.canvas;
    tooltipEl.style.left = offsetLeft + tooltip.caretX + 15 + 'px';
    tooltipEl.style.top = offsetTop + tooltip.caretY + 'px';
}
</script>
