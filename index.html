<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Loan Portfolio â€” Unified Dashboard</title>

  <!-- ============
       STYLES
       (organized: variables, base, components, layouts, utils, dark-mode)
       ============ -->
  <style>
    /* ======================
       CSS VARIABLES
       ====================== */
    :root{
      /* light theme colors */
      --bg: #f1f5f9;
      --surface: #ffffff;
      --muted: #64748b;
      --text: #0f172a;
      --card-shadow: 0 6px 18px rgba(16,24,40,0.04);
      --card-border: rgba(15,23,42,0.04);
      --brand: #0ea5e9;
      --accent: #7c3aed;
      --success: #06b6d4;
      --danger: #fb7185;
      --grid-gap: 12px;
      --radius: 10px;
      --glass: rgba(255,255,255,0.6);
      --trans-fast: .18s;
      --trans-med: .28s;
      --drawer-width: 860px;
    }

    /* prefer dark mode if system set */
    @media (prefers-color-scheme: dark) {
      :root{
        --bg: #0b1220;
        --surface: #071126;
        --muted: #94a3b8;
        --text: #e6eef8;
        --card-shadow: 0 10px 30px rgba(2,6,23,0.6);
        --card-border: rgba(255,255,255,0.04);
        --glass: rgba(255,255,255,0.03);
      }
    }

    /* manual theme override â€” set <html data-theme="dark"> to force dark */
    html[data-theme="dark"] {
      --bg: #0b1220;
      --surface: #071126;
      --muted: #94a3b8;
      --text: #e6eef8;
      --card-shadow: 0 10px 30px rgba(2,6,23,0.6);
      --card-border: rgba(255,255,255,0.04);
      --glass: rgba(255,255,255,0.03);
    }

    /* ======================
       BASE
       ====================== */
    html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,Arial;color:var(--text);-webkit-font-smoothing:antialiased;background:linear-gradient(180deg,var(--bg) 0%, rgba(248,250,252,0.6) 100%);}
    .app{max-width:1200px;margin:20px auto;padding:16px}
    h1{font-size:20px;margin:0}
    p.lead{margin:0;color:var(--muted);font-size:13px}
    .muted{color:var(--muted)}
    .small{font-size:12px;color:var(--muted)}

    /* ======================
       COMPONENTS: BUTTONS (match Amort page)
       ====================== */
    .btn{
      padding:8px 10px;border-radius:8px;border:1px solid rgba(15,23,42,0.06);
      background:transparent;color:var(--text);cursor:pointer;font-weight:600;transition:transform var(--trans-fast), box-shadow var(--trans-fast), opacity var(--trans-fast);
      box-shadow:none;
      display:inline-flex;align-items:center;gap:8px;
    }
    .btn:hover{ transform:translateY(-2px); box-shadow:var(--card-shadow) }
    .btn:active{ transform:translateY(0) }
    .btn.ghost{ background:transparent; border:1px solid var(--card-border) }
    .btn.primary{
      background:linear-gradient(90deg,var(--brand),var(--accent)); color:white; border:none; box-shadow: 0 8px 20px rgba(12,74,124,0.08);
    }
    .close-btn{ background:#f1f5f9;border:none;padding:8px;border-radius:8px;cursor:pointer }
    .close-btn:hover{ transform:translateY(-2px) }

    /* ======================
       LAYOUT: header, kpis, grid
       ====================== */
    header{display:flex;flex-direction:column;gap:8px;margin-bottom:12px}
    .header-top{display:flex;align-items:center;justify-content:space-between}
    .header-left{display:flex;flex-direction:column;gap:6px}
    .header-controls{display:flex;gap:10px;align-items:center}

    .current-date{font-size:13px;color:var(--muted)}

    .kpis{display:grid;grid-template-columns:repeat(4,1fr);gap:var(--grid-gap);margin:14px 0 18px}
    .kpi{
      background:var(--surface);padding:14px;border-radius:var(--radius);
      box-shadow:var(--card-shadow);border:1px solid var(--card-border);
      cursor:pointer;transition:transform var(--trans-fast), box-shadow var(--trans-fast), border-color var(--trans-fast);
      display:flex;flex-direction:column;justify-content:space-between;min-height:84px;
    }
    .kpi:hover{ transform:translateY(-6px); box-shadow:0 14px 36px rgba(2,6,23,0.08); border-color: rgba(15,23,42,0.07); }
    .kpi h3{ margin:0; font-size:12px; color:var(--muted) }
    .kpi p{ margin:8px 0 0; font-size:18px; font-weight:700 }

    .grid{display:grid;grid-template-columns:repeat(2,1fr);gap:var(--grid-gap);height:calc(100vh - 340px);overflow:auto;padding-right:6px}
    @media(max-width:900px){ .grid{grid-template-columns:1fr;height:auto} .kpis{grid-template-columns:repeat(2,1fr)} }

    /* ======================
       LOAN TILE
       ====================== */
    .tile{display:flex;align-items:center;justify-content:space-between;padding:12px;border-radius:12px;background:var(--surface);min-height:110px;cursor:pointer;overflow:hidden;transition:transform var(--trans-fast) cubic-bezier(.2,.9,.3,1), box-shadow var(--trans-fast)}
    .tile:hover{ transform:translateY(-6px); box-shadow:0 14px 36px rgba(2,6,23,0.06) }
    .tile-left{flex:1;padding-right:10px}
    .loan-name{font-weight:700;font-size:14px}
    .loan-sub{font-size:12px;color:var(--muted);margin-top:6px}
    .loan-meta{display:flex;gap:8px;font-size:12px;color:var(--muted);margin-top:8px}

    .chart-wrap{width:170px;flex-shrink:0;display:flex;flex-direction:column;align-items:flex-end}
    .mini-label{font-size:12px;color:var(--muted);margin-bottom:6px}
    svg.sparkline{width:170px;height:48px;display:block}

    /* ======================
       DRAWER
       ====================== */
    .drawer{
      position:fixed;right:0;top:0;height:100vh;width:var(--drawer-width);max-width:calc(100% - 32px);
      background:var(--surface);box-shadow:-28px 0 80px rgba(2,6,23,0.14);transform:translateX(110%);transition:transform var(--trans-med) cubic-bezier(.2,.9,.3,1), opacity var(--trans-med);
      z-index:90;overflow:auto;padding:20px;border-left:1px solid var(--card-border);
      opacity:0;
    }
    /* drawer open animation (slide + content fade) */
    .drawer.open{ transform:translateX(0); opacity:1; animation: drawerContentFade .32s ease both; }
    @keyframes drawerContentFade {
      from { transform: translateX(18%); opacity:0 }
      to   { transform: translateX(0); opacity:1 }
    }

    .drawer-head{display:flex;align-items:start;justify-content:space-between;gap:8px}
    .drawer h2{margin:0 0 6px;font-size:20px}
    .drawer .muted{font-size:13px;margin-bottom:10px}

    .drawer-chart{
      width:100%;height:260px;background:linear-gradient(180deg,#ffffff,#fcfeff);border-radius:8px;border:1px solid rgba(15,23,42,0.03);
      display:block;position:relative;margin-bottom:10px;padding:10px;box-sizing:border-box;
    }

    .drawer .drawer-info-row{display:flex;gap:12px;margin-bottom:10px;align-items:center}
    .drawer .info-card{flex:1;background:#f8fafc;padding:12px;border-radius:8px;min-height:48px;display:flex;flex-direction:column;justify-content:center}
    .drawer .info-card.small{width:160px;align-items:flex-end}
    .drawer .muted-small{font-size:12px;color:var(--muted);margin-bottom:6px;display:block}
    .drawer .main-val{font-weight:800;font-size:18px}
    .drawer .main-val.small{font-size:16px}

    .legend{display:flex;gap:10px;font-size:12px;align-items:center;margin-top:6px}
    .legend .sw{width:12px;height:8px;border-radius:2px;display:inline-block}

    .amort-wrap{border:1px solid rgba(15,23,42,0.04);border-radius:8px;padding:8px;max-height:40vh;overflow:auto}
    table{width:100%;border-collapse:collapse;font-size:13px}
    thead th{position:sticky;top:0;background:var(--surface);padding:8px;text-align:left;color:var(--muted);font-weight:700}
    td{padding:8px;border-bottom:1px dashed rgba(15,23,42,0.04);text-align:right}
    td:first-child, th:first-child{ text-align:left }

    .actions{display:flex;gap:8px;margin-top:12px}
    .tooltip{position:fixed;pointer-events:none;background:#0f172a;color:white;padding:6px 8px;border-radius:6px;font-size:12px;transform:translate(-50%,-120%);box-shadow:0 6px 18px rgba(2,6,23,0.2);display:none;z-index:9999;line-height:1.12}

    /* small responsive tweaks */
    @media(max-width:1100px){ :root{--drawer-width:720px} }
    @media(max-width:860px){ :root{--drawer-width:100%} .drawer{left:0;right:0} }
  </style>
</head>
<body>
  <div class="app" role="main">
    <!-- HEADER -->
    <header>
      <div class="header-top">
        <div class="header-left">
          <h1>Loan Portfolio â€” Unified Dashboard</h1>
          <p class="lead">Interactive KPIs, mini-charts, and detailed drawers â€” now with unified styling and dark mode.</p>
        </div>
        <div class="header-controls">
          <div class="current-date">Current Month: <strong id="currentMonthLabel">18</strong></div>
          <button id="themeToggle" class="btn" title="Toggle dark mode">ðŸŒ™ Toggle theme</button>
        </div>
      </div>
    </header>

    <!-- KPI ROW -->
    <section class="kpis" id="kpis"></section>

    <!-- LOAN GRID -->
    <section class="grid" id="loanGrid" aria-live="polite"></section>
  </div>

  <!-- DRAWER -->
  <aside id="drawer" class="drawer" aria-hidden="true" role="dialog" aria-label="Details panel">
    <div class="drawer-head">
      <div>
        <h2 id="drawerTitle">Drawer</h2>
        <div class="muted" id="drawerSub">details</div>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <button class="btn" id="downloadCsvBtn">Download CSV</button>
        <button class="close-btn" id="closeBtn" aria-label="Close drawer">âœ•</button>
      </div>
    </div>

    <!-- info row: primary left, secondary right -->
    <div class="drawer-info-row">
      <div class="info-card" id="drawerPrimaryCard">
        <div class="muted-small" id="drawerPrimaryTitle">Purchase Price</div>
        <div id="drawerPrimary" class="main-val"></div>
      </div>
      <div class="info-card small" id="drawerSecondaryCard">
        <div class="muted-small" id="drawerSecondaryTitle">Rate</div>
        <div id="drawerSecondary" class="main-val small"></div>
      </div>
    </div>

    <div id="drawerBody">
      <div class="drawer-chart" id="drawerChartArea"></div>
      <div class="legend" id="drawerLegend" style="display:none"></div>
      <div id="drawerExtra"></div>

      <div id="drawerAmortContainer" style="margin-top:10px">
        <h3 style="margin-top:8px">Amortization</h3>
        <div class="amort-wrap" id="amortWrap">
          <table>
            <thead>
              <tr><th>Month</th><th>Payment</th><th>Principal</th><th>Interest</th><th>Balance</th></tr>
            </thead>
            <tbody id="amortBody"></tbody>
          </table>
        </div>
      </div>

      <div class="actions" style="padding-top:10px">
        <button class="btn" id="printBtn">Print</button>
        <button class="btn primary" id="copyCsvBtn">Copy CSV</button>
      </div>
    </div>
  </aside>

  <div id="tooltip" class="tooltip" role="status" aria-live="polite"></div>

  <!-- ============
       SCRIPTS
       (organized into: constants, data, math/helpers, chart builders, renderers, UI wiring)
       ============ -->
  <script>
  /* =====================================================
     CONSTANTS & SMALL HELPERS
     ===================================================== */
  const CURRENT_MONTH = 18;
  document.getElementById('currentMonthLabel').textContent = CURRENT_MONTH;
  const tooltip = document.getElementById('tooltip');

  function formatMoney(v){ return '$' + Number(v).toLocaleString(); }
  function monthLabelFromDate(dStr){ const d=new Date(dStr+'T00:00:00'); return d.toLocaleString(undefined,{year:'numeric',month:'short'}); }
  function clamp(v,a,b){ return Math.max(a, Math.min(b, v)); }

  /* =====================================================
     SAMPLE DATA (kept from your last updated file)
     ===================================================== */
  const loans = [
    { id:1, purchaseDate:'2025-01-15', purchasePrice:10000, termYears:10, graceYears:4.5, nominalRate:0.08 },
    { id:2, purchaseDate:'2025-02-01', purchasePrice:7500, termYears:8, graceYears:2, nominalRate:0.075 },
    { id:3, purchaseDate:'2025-02-20', purchasePrice:12000, termYears:12, graceYears:3, nominalRate:0.0825 },
    { id:4, purchaseDate:'2025-03-10', purchasePrice:6000, termYears:9, graceYears:1.5, nominalRate:0.095 },
    { id:5, purchaseDate:'2025-03-30', purchasePrice:5000, termYears:10, graceYears:1, nominalRate:0.09 },
    { id:6, purchaseDate:'2025-04-15', purchasePrice:7500, termYears:5, graceYears:0, nominalRate:0.073 },
    { id:7, purchaseDate:'2025-04-30', purchasePrice:10000, termYears:8, graceYears:0, nominalRate:0.09 },
    { id:8, purchaseDate:'2025-05-20', purchasePrice:5000, termYears:9, graceYears:0.5, nominalRate:0.11 },
    { id:9, purchaseDate:'2025-06-10', purchasePrice:10000, termYears:7, graceYears:0.25, nominalRate:0.10 },
    { id:10,purchaseDate:'2025-06-30', purchasePrice:8000, termYears:3, graceYears:0, nominalRate:0.06 }
  ];

  /* =====================================================
     AMORTIZATION/ROI CALCS (identical logic as before)
     ===================================================== */
  function calcAmort(principal, annualRate, termYears, graceYears) {
    const monthlyRate = annualRate / 12;
    const totalMonths = Math.round(termYears * 12);
    const graceMonths = Math.round(graceYears * 12);
    const repayMonths = Math.max(1, totalMonths - graceMonths);
    let balance = principal;
    const schedule = [];

    for (let m = 1; m <= graceMonths; m++) {
      const interest = +(balance * monthlyRate).toFixed(2);
      balance = +(balance + interest).toFixed(2);
      schedule.push({ monthIndex: m, payment: 0, principalPaid: 0, interest, balance });
    }

    const payment = monthlyRate === 0 ? +(balance / repayMonths).toFixed(2)
      : +((balance * monthlyRate) / (1 - Math.pow(1 + monthlyRate, -repayMonths))).toFixed(2);

    for (let m = 1; m <= repayMonths; m++) {
      const interest = +(balance * monthlyRate).toFixed(2);
      const principalPaid = +Math.min(balance, +(payment - interest).toFixed(2));
      balance = +(Math.max(0, balance - principalPaid).toFixed(2));
      schedule.push({ monthIndex: graceMonths + m, payment: +payment.toFixed(2), principalPaid, interest, balance });
    }
    return { payment, schedule };
  }

  const loansWithAmort = loans.map(l => {
    const amort = calcAmort(l.purchasePrice, l.nominalRate, l.termYears, l.graceYears);
    let cumP = 0, cumI = 0, cumTotal = 0;
    const cumSchedule = amort.schedule.map(r => {
      cumP = +(cumP + r.principalPaid).toFixed(2);
      cumI = +(cumI + r.interest).toFixed(2);
      cumTotal = +(cumTotal + r.payment).toFixed(2);
      return { ...r, cumPrincipal: cumP, cumInterest: cumI, cumTotal };
    });

    // derive a simple ROI series and mini pts
    const roiSeries = cumSchedule.map(s => {
      const loanValue = s.balance + s.cumInterest + s.cumTotal;
      const roi = (loanValue - l.purchasePrice) / l.purchasePrice;
      return { month: s.monthIndex, roi, loanValue };
    });

    const miniPts = roiSeries.slice(0, Math.min(24, roiSeries.length)).map(s => ({ x: s.month, y: s.roi }));
    return { ...l, amort, cumSchedule, roiSeries, miniPts };
  });

  /* =====================================================
     KPIs
     ===================================================== */
  function computeKPIs(list) {
    const total = list.reduce((s, l) => s + l.purchasePrice, 0);
    const weightedROI = list.reduce((s, l) => {
      const idx = Math.min(CURRENT_MONTH - 1, l.roiSeries.length - 1);
      return s + l.purchasePrice * ((l.roiSeries[idx] || {}).roi || 0);
    }, 0) / Math.max(1, total);

    const projectedWeightedROI = list.reduce((s, l) => {
      const last = (l.roiSeries[l.roiSeries.length - 1] || {}).roi || 0;
      return s + l.purchasePrice * last;
    }, 0) / Math.max(1, total);

    const avgRate = list.reduce((s, l) => s + l.nominalRate * l.purchasePrice, 0) / Math.max(1, total);

    // monthly income approximate: sum of first non-zero payment for each loan
    const monthlyIncome = list.reduce((s, l) => s + (l.amort.schedule.length ? l.amort.schedule[0].payment : 0), 0);

    return { total, weightedROI, projectedWeightedROI, avgRate, monthlyIncome };
  }

  const kpis = computeKPIs(loansWithAmort);

  /* =====================================================
     CHART BUILDERS (reusable)
     - createLineChart(containerEl, series, opts)
     - createBarChart(containerEl, keys, values, opts)
     - createHistogram(containerEl, values, bins, opts)
     ===================================================== */

  function createLineChart(containerEl, series, opts = {}) {
    containerEl.innerHTML = '';
    const svgNS = "http://www.w3.org/2000/svg";
    const rect = containerEl.getBoundingClientRect();
    const w = Math.max(320, rect.width || 640);
    const h = opts.h || 260;
    const pad = opts.pad || 28;

    const svg = document.createElementNS(svgNS, "svg");
    svg.setAttribute("viewBox", `0 0 ${w} ${h}`);
    svg.setAttribute("width", "100%");
    svg.setAttribute("height", "100%");
    svg.style.display = "block";

    const data = series.length ? series.slice() : [{x:0,y:0}];
    const ys = data.map(d => d.y);
    const xs = data.map(d => d.x);
    const minY = Math.min(...ys); const maxY = Math.max(...ys);
    const minX = Math.min(...xs); const maxX = Math.max(...xs);
    const rangeY = Math.max(1e-6, maxY - minY);

    const stepX = (w - pad * 2) / Math.max(1, data.length - 1);
    function toXY(d, i) { const x = pad + i * stepX; const y = pad + (h - pad * 2) - ((d.y - minY) / rangeY) * (h - pad * 2); return [x, y]; }

    // grid lines
    for (let gy = 0; gy < 5; gy++) {
      const y = pad + gy * ((h - pad * 2) / 4);
      const line = document.createElementNS(svgNS, 'line');
      line.setAttribute('x1', pad); line.setAttribute('x2', w - pad); line.setAttribute('y1', y); line.setAttribute('y2', y);
      line.setAttribute('stroke', '#eef2f7'); line.setAttribute('stroke-width', '1');
      svg.appendChild(line);
    }

    // path
    let path = '';
    data.forEach((p, i) => { const xy = toXY(p, i); path += (i === 0 ? ('M ' + xy[0] + ' ' + xy[1]) : (' L ' + xy[0] + ' ' + xy[1])); });
    const el = document.createElementNS(svgNS, 'path');
    el.setAttribute('d', path); el.setAttribute('fill', 'none'); el.setAttribute('stroke', opts.color || '#0ea5e9'); el.setAttribute('stroke-width', '2');
    svg.appendChild(el);

    // interactive hover
    const vLine = document.createElementNS(svgNS, 'line'); vLine.setAttribute('stroke', '#111827'); vLine.setAttribute('stroke-dasharray', '3 4'); vLine.setAttribute('stroke-opacity', '0.6'); svg.appendChild(vLine);
    const hoverGroup = document.createElementNS(svgNS, 'g'); hoverGroup.setAttribute('class', 'hover'); svg.appendChild(hoverGroup);

    svg.addEventListener('mousemove', function (ev) {
      const rect = svg.getBoundingClientRect();
      const svgX = ev.clientX - rect.left;
      let idx = Math.round((svgX - pad) / stepX);
      idx = clamp(idx, 0, data.length - 1);
      const point = data[idx];
      const [cx, cy] = toXY(point, idx);
      vLine.setAttribute('x1', cx); vLine.setAttribute('x2', cx); vLine.setAttribute('y1', pad); vLine.setAttribute('y2', h - pad);
      hoverGroup.innerHTML = '';
      const c = document.createElementNS(svgNS, 'circle'); c.setAttribute('cx', cx); c.setAttribute('cy', cy); c.setAttribute('r', 4); c.setAttribute('fill', opts.color || '#0ea5e9'); c.setAttribute('stroke', '#fff'); c.setAttribute('stroke-width', '1'); hoverGroup.appendChild(c);

      tooltip.style.display = 'block';
      tooltip.style.left = (rect.left + cx) + 'px';
      tooltip.style.top = (rect.top + cy - 28) + 'px';
      const label = (opts.labelFn && typeof opts.labelFn === 'function') ? opts.labelFn(point, idx) : (`M${point.x} â€¢ ${(point.y * 100).toFixed(2)}%`);
      tooltip.innerHTML = label;
    });

    svg.addEventListener('mouseleave', function () { hoverGroup.innerHTML = ''; tooltip.style.display = 'none'; });
    containerEl.appendChild(svg);
    return svg;
  }

  function createBarChart(containerEl, keys, values, opts = {}) {
    containerEl.innerHTML = '';
    const svgNS = "http://www.w3.org/2000/svg";
    const rect = containerEl.getBoundingClientRect();
    const w = Math.max(320, rect.width || 640);
    const h = opts.h || 260;
    const padL = opts.padL || 55, padR = opts.padR || 20, padT = opts.padT || 25, padB = opts.padB || 55;

    const svg = document.createElementNS(svgNS, "svg");
    svg.setAttribute("viewBox", `0 0 ${w} ${h}`);
    svg.setAttribute("width", "100%");
    svg.setAttribute("height", "100%");
    svg.style.display = "block";

    const maxValue = Math.max(...values, 1);
    const barW = (w - padL - padR) / Math.max(1, keys.length);

    // horizontal grid & labels
    for (let i = 0; i <= 5; i++) {
      const y = padT + (h - padT - padB) * (i / 5);
      const line = document.createElementNS(svgNS, "line");
      line.setAttribute("x1", padL); line.setAttribute("x2", w - padR); line.setAttribute("y1", y); line.setAttribute("y2", y); line.setAttribute("stroke", "#eef2f7");
      svg.appendChild(line);
      const value = maxValue * (1 - i / 5);
      const lbl = document.createElementNS(svgNS, "text");
      lbl.textContent = "$" + Math.round(value).toLocaleString();
      lbl.setAttribute("x", padL - 10); lbl.setAttribute("y", y + 4); lbl.setAttribute("font-size", "11"); lbl.setAttribute("fill", "#64748b"); lbl.setAttribute("text-anchor", "end");
      svg.appendChild(lbl);
    }

    const hoverG = document.createElementNS(svgNS, "g"); hoverG.setAttribute("class", "hover"); svg.appendChild(hoverG);

    keys.forEach((key, i) => {
      const amount = values[i];
      const x = padL + i * barW;
      const barHeight = (amount / maxValue) * (h - padT - padB);
      const y = padT + (h - padT - padB) - barHeight;
      const bar = document.createElementNS(svgNS, "rect");
      bar.setAttribute("x", x + 6); bar.setAttribute("y", y); bar.setAttribute("width", barW - 12); bar.setAttribute("height", barHeight);
      bar.setAttribute("rx", 4); bar.setAttribute("fill", opts.color || "#0ea5e9"); bar.style.cursor = "pointer";
      bar.addEventListener('mousemove', ev => {
        hoverG.innerHTML = "";
        const rect = svg.getBoundingClientRect();
        const cx = ev.clientX - rect.left;
        const cy = ev.clientY - rect.top - 14;
        const bg = document.createElementNS(svgNS, "rect");
        bg.setAttribute("x", cx - 40); bg.setAttribute("y", cy - 18); bg.setAttribute("width", 80); bg.setAttribute("height", 20); bg.setAttribute("rx", 4); bg.setAttribute("fill", "#ffffff"); bg.setAttribute("stroke", "#cbd5e1");
        const tip = document.createElementNS(svgNS, "text");
        tip.textContent = "$" + amount.toLocaleString(); tip.setAttribute("x", cx); tip.setAttribute("y", cy - 4); tip.setAttribute("font-size", "12"); tip.setAttribute("text-anchor", "middle"); tip.setAttribute("fill", "#0f172a"); hoverG.appendChild(bg); hoverG.appendChild(tip);
      });
      bar.addEventListener('mouseleave', () => { hoverG.innerHTML = ""; });
      svg.appendChild(bar);

      const t = document.createElementNS(svgNS, "text");
      t.textContent = key;
      t.setAttribute("x", x + barW / 2); t.setAttribute("y", h - padB + 22); t.setAttribute("font-size", "11"); t.setAttribute("fill", "#64748b"); t.setAttribute("text-anchor", "middle");
      svg.appendChild(t);
    });

    containerEl.appendChild(svg);
    return svg;
  }

  function createHistogram(containerEl, values, bins = 6, opts = {}) {
    containerEl.innerHTML = '';
    const minV = Math.min(...values); const maxV = Math.max(...values);
    const range = Math.max(1e-6, maxV - minV);
    const binSize = range / bins;
    const counts = new Array(bins).fill(0);
    values.forEach(v => {
      let idx = Math.floor((v - minV) / binSize);
      if (idx === bins) idx = bins - 1;
      counts[idx] += 1;
    });
    const labels = counts.map((_, i) => {
      const a = minV + i * binSize; const b = a + binSize;
      return `${(a * 100).toFixed(1)}â€“${(b * 100).toFixed(1)}%`;
    });
    return createBarChart(containerEl, labels, counts, opts);
  }

  /* =====================================================
     RENDER: KPI TILES & LOAN GRID
     ===================================================== */
  const kpisEl = document.getElementById('kpis');
  kpisEl.innerHTML = `
    <div class="kpi" data-kpi="distribution"><h3>Total Loans</h3><p>${loansWithAmort.length}</p></div>
    <div class="kpi" data-kpi="tpv"><h3>Weighted ROI to Date</h3><p id="wroi">${(kpis.weightedROI*100).toFixed(2)}%</p></div>
    <div class="kpi" data-kpi="rates"><h3>Projected Weighted ROI</h3><p id="wproj">${(kpis.projectedWeightedROI*100).toFixed(2)}%</p></div>
    <div class="kpi" data-kpi="payments"><h3>Avg Rate</h3><p>${(kpis.avgRate*100).toFixed(2)}%</p></div>
  `;

  const grid = document.getElementById('loanGrid');

  loansWithAmort.forEach((loan, idx) => {
    const tile = document.createElement('div'); tile.className = 'tile'; tile.tabIndex = 0;
    tile.innerHTML = `
      <div class="tile-left">
        <div class="loan-name">Loan ${loan.id}</div>
        <div class="loan-sub">${formatMoney(loan.purchasePrice)}</div>
        <div class="loan-meta"><div>Term: ${loan.termYears}y</div><div>Grace: ${loan.graceYears}y</div></div>
      </div>
      <div class="chart-wrap">
        <div class="mini-label">ROI ${( (loan.roiSeries[Math.min(CURRENT_MONTH-1, loan.roiSeries.length-1)]||{}).roi || 0)*100).toFixed(2)}%</div>
        <svg class="sparkline" viewBox="0 0 170 48" preserveAspectRatio="none" data-idx="${idx}" aria-hidden="true"></svg>
      </div>
    `;
    tile.addEventListener('click', e => { e.stopPropagation(); openDrawerForLoan(loan); });
    tile.addEventListener('keydown', e => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); openDrawerForLoan(loan); } });
    grid.appendChild(tile);

    // mini sparkline render (ROI)
    const svg = tile.querySelector('svg.sparkline');
    const w = 170, h = 48, pad = 6;
    const pts = loan.miniPts.length ? loan.miniPts : loan.roiSeries.map(s => ({ x: s.month, y: s.roi }));
    // path builder
    const ys = pts.map(p => p.y); const minY = Math.min(...ys); const maxY = Math.max(...ys); const range = Math.max(1e-6, maxY - minY);
    const stepX = (w - pad * 2) / Math.max(1, pts.length - 1);
    let d = '';
    pts.forEach((p, i) => { const x = pad + i * stepX; const y = pad + (h - pad * 2) - ((p.y - minY) / range) * (h - pad * 2); d += (i === 0 ? `M ${x} ${y}` : ` L ${x} ${y}`); });

    // current month dashed line relative to loan purchase
    const earliest = loansWithAmort.reduce((min, L) => L.purchaseDate < min ? L.purchaseDate : min, loansWithAmort[0].purchaseDate);
    function monthsBetween(a,b){ const da=new Date(a+'T00:00:00'), db=new Date(b+'T00:00:00'); return (db.getFullYear()-da.getFullYear())*12 + (db.getMonth()-da.getMonth()); }
    const offset = monthsBetween(earliest, loan.purchaseDate);
    let curIdx = CURRENT_MONTH - offset; curIdx = clamp(curIdx, 1, pts.length);
    const dashX = pad + (curIdx - 1) * stepX;

    svg.innerHTML = `
      <path d="${d}" fill="none" stroke="#0ea5e9" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" />
      <g class="mini-hover"></g>
      <line class="current-line" x1="${dashX}" y1="2" x2="${dashX}" y2="${h-2}" stroke="#111827" stroke-dasharray="3 3" stroke-opacity="0.6" />
    `;

    svg.addEventListener('mousemove', ev => {
      const rect = svg.getBoundingClientRect();
      const relX = ev.clientX - rect.left;
      const idxNearest = clamp(Math.round((relX - pad) / stepX), 0, pts.length - 1);
      const pt = pts[idxNearest];
      const dataPoint = loan.roiSeries[pt.x - 1] || loan.roiSeries[idxNearest] || { month: pt.x, roi: pt.y };

      tooltip.style.left = (ev.clientX) + 'px';
      tooltip.style.top = (ev.clientY - 10) + 'px';
      tooltip.style.display = 'block';
      tooltip.innerHTML = `M${dataPoint.month} â€¢ ROI ${(dataPoint.roi*100).toFixed(2)}%`;

      const hoverG = svg.querySelector('g.mini-hover');
      hoverG.innerHTML = '';
      const cx = pad + idxNearest * stepX;
      const cy = pad + (h - pad * 2) - ((pt.y - minY) / range) * (h - pad * 2);
      const c = document.createElementNS("http://www.w3.org/2000/svg", "circle");
      c.setAttribute("cx", cx); c.setAttribute("cy", cy); c.setAttribute("r", 3.6); c.setAttribute("fill", "#0ea5e9"); c.setAttribute("stroke", "#fff"); c.setAttribute("stroke-width", "1");
      hoverG.appendChild(c);
    });

    svg.addEventListener('mouseleave', () => { tooltip.style.display = 'none'; const hoverG = svg.querySelector('g.mini-hover'); if (hoverG) hoverG.innerHTML = ''; });
  });

  /* =====================================================
     DRAWER HELPERS & STATE
     ===================================================== */
  const drawer = document.getElementById('drawer');
  const drawerTitle = document.getElementById('drawerTitle');
  const drawerSub = document.getElementById('drawerSub');
  const drawerPrimaryTitle = document.getElementById('drawerPrimaryTitle');
  const drawerPrimary = document.getElementById('drawerPrimary');
  const drawerSecondaryTitle = document.getElementById('drawerSecondaryTitle');
  const drawerSecondary = document.getElementById('drawerSecondary');
  const drawerChartArea = document.getElementById('drawerChartArea');
  const drawerLegend = document.getElementById('drawerLegend');
  const drawerExtra = document.getElementById('drawerExtra');
  const amortBody = document.getElementById('amortBody');
  const drawerAmortContainer = document.getElementById('drawerAmortContainer');

  let currentLoan = null, currentMode = null;

  function openDrawer() {
    drawer.classList.add('open'); drawer.setAttribute('aria-hidden', 'false'); drawer.scrollTop = 0;
  }
  function closeDrawer() {
    drawer.classList.remove('open'); drawer.setAttribute('aria-hidden', 'true'); tooltip.style.display = 'none';
    currentLoan = null; currentMode = null;
  }

  document.getElementById('closeBtn').addEventListener('click', closeDrawer);
  document.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeDrawer(); });

  /* =====================================================
     OPEN LOAN DRAWER (detailed chart + amort table)
     - includes current month dotted line & hover interactions
     ===================================================== */
  function openDrawerForLoan(loan) {
    currentMode = 'loan'; currentLoan = loan;
    drawerTitle.textContent = `Loan ${loan.id}`;
    drawerSub.textContent = `Purchased: ${loan.purchaseDate}`;
    drawerPrimaryTitle.textContent = 'Purchase Price';
    drawerPrimary.textContent = formatMoney(loan.purchasePrice);
    drawerSecondaryTitle.textContent = 'Nominal Rate';
    drawerSecondary.textContent = (loan.nominalRate * 100).toFixed(2) + '%';

    // amort table
    drawerAmortContainer.style.display = 'block';
    amortBody.innerHTML = '';
    loan.amort.schedule.forEach(r => {
      const tr = document.createElement('tr');
      tr.innerHTML = `<td style="text-align:left">${r.monthIndex}</td><td style="text-align:right">$${Number(r.payment).toFixed(2)}</td><td style="text-align:right">$${Number(r.principalPaid).toFixed(2)}</td><td style="text-align:right">$${Number(r.interest).toFixed(2)}</td><td style="text-align:right">$${Number(r.balance).toFixed(2)}</td>`;
      amortBody.appendChild(tr);
    });

    // chart: multi-line (balance, cumP, cumI, total) with current-month dashed line
    drawerChartArea.innerHTML = ''; drawerLegend.style.display = 'flex';
    drawerLegend.innerHTML = `
      <div class="item"><span class="sw" style="background:#0f172a"></span>Balance</div>
      <div class="item"><span class="sw" style="background:${getComputedStyle(document.documentElement).getPropertyValue('--success') || '#06b6d4'}"></span>Cum Principal</div>
      <div class="item"><span class="sw" style="background:#a78bfa"></span>Cum Interest</div>
      <div class="item"><span class="sw" style="background:#fb7185"></span>Total</div>
    `;

    // construct series
    const schedule = loan.cumSchedule;
    const balances = loan.amort.schedule.map(s => ({ x: s.monthIndex, y: s.balance }));
    const cumP = schedule.map(s => ({ x: s.monthIndex, y: s.cumPrincipal }));
    const cumI = schedule.map(s => ({ x: s.monthIndex, y: s.cumInterest }));
    const cumT = schedule.map(s => ({ x: s.monthIndex, y: s.cumTotal }));
    // determine global y range
    const allYs = [...balances.map(p => p.y), ...cumP.map(p => p.y), ...cumI.map(p => p.y), ...cumT.map(p => p.y)];
    const maxY = Math.max(...allYs), minY = Math.min(...allYs), rangeY = Math.max(1, maxY - minY);
    // draw via our createLineChart helper but we need multiple lines and vertical hover; create simple custom svg for this large chart:
    (function buildLoanSVG(){
      const svgNS = "http://www.w3.org/2000/svg";
      const w = 760, h = 360, pad = 36;
      const svg = document.createElementNS(svgNS, 'svg'); svg.setAttribute('viewBox', `0 0 ${w} ${h}`); svg.setAttribute('width', '100%'); svg.setAttribute('height', '100%');
      // grid
      for (let gy = 0; gy < 5; gy++){
        const y = pad + gy * ((h - pad * 2) / 4);
        const line = document.createElementNS(svgNS, 'line');
        line.setAttribute('x1', pad); line.setAttribute('x2', w - pad); line.setAttribute('y1', y); line.setAttribute('y2', y); line.setAttribute('stroke', '#eef2f7'); svg.appendChild(line);
      }
      const length = Math.max(balances.length, 1);
      const stepX = (w - pad * 2) / Math.max(1, length - 1);
      function toXY(point, i){ const x = pad + i * stepX; const y = pad + (h - pad * 2) - ((point.y - minY) / rangeY) * (h - pad * 2); return [x,y]; }
      function buildPath(arr){
        return arr.map((p,i)=>{
          const [x,y] = toXY(p,i);
          return (i===0?`M ${x} ${y}`:` L ${x} ${y}`);
        }).join(' ');
      }
      // paths
      const pBal = buildPath(balances), pP = buildPath(cumP), pI = buildPath(cumI), pT = buildPath(cumT);
      const elBal = document.createElementNS(svgNS,'path'); elBal.setAttribute('d', pBal); elBal.setAttribute('fill','none'); elBal.setAttribute('stroke','#0f172a'); elBal.setAttribute('stroke-width','2'); svg.appendChild(elBal);
      const elP = document.createElementNS(svgNS,'path'); elP.setAttribute('d', pP); elP.setAttribute('fill','none'); elP.setAttribute('stroke',getComputedStyle(document.documentElement).getPropertyValue('--success') || '#06b6d4'); elP.setAttribute('stroke-width','1.6'); svg.appendChild(elP);
      const elI = document.createElementNS(svgNS,'path'); elI.setAttribute('d', pI); elI.setAttribute('fill','none'); elI.setAttribute('stroke','#a78bfa'); elI.setAttribute('stroke-width','1.6'); svg.appendChild(elI);
      const elT = document.createElementNS(svgNS,'path'); elT.setAttribute('d', pT); elT.setAttribute('fill','none'); elT.setAttribute('stroke','#fb7185'); elT.setAttribute('stroke-width','1.4'); svg.appendChild(elT);

      // current-month dotted line
      const maxMonth = schedule.length;
      const curX = pad + (clamp(CURRENT_MONTH, 1, maxMonth) - 1) * stepX;
      const curLine = document.createElementNS(svgNS,'line'); curLine.setAttribute('x1',curX); curLine.setAttribute('x2',curX); curLine.setAttribute('y1',pad); curLine.setAttribute('y2',h-pad); curLine.setAttribute('stroke','#111827'); curLine.setAttribute('stroke-dasharray','3 4'); curLine.setAttribute('stroke-opacity','0.6'); svg.appendChild(curLine);

      // vertical hover line + points
      const vLine = document.createElementNS(svgNS,'line'); vLine.setAttribute('stroke','#0f172a'); vLine.setAttribute('stroke-dasharray','3 4'); vLine.setAttribute('opacity','0.6'); svg.appendChild(vLine);
      const circles = document.createElementNS(svgNS,'g'); svg.appendChild(circles);

      svg.addEventListener('mousemove', (ev)=>{
        const rect = svg.getBoundingClientRect(); const x = ev.clientX - rect.left;
        let idx = Math.round((x - pad) / stepX); idx = clamp(idx, 0, schedule.length - 1);
        const px = pad + idx * stepX;
        vLine.setAttribute('x1', px); vLine.setAttribute('x2', px); vLine.setAttribute('y1', pad); vLine.setAttribute('y2', h - pad);
        circles.innerHTML = '';
        const pv = { month: schedule[idx].monthIndex, balance: balances[idx].y, cumP: cumP[idx].y, cumI: cumI[idx].y, cumT: cumT[idx].y };
        const series = [
          { val: pv.balance, color: '#0f172a' },
          { val: pv.cumP, color: (getComputedStyle(document.documentElement).getPropertyValue('--success') || '#06b6d4') },
          { val: pv.cumI, color: '#a78bfa' },
          { val: pv.cumT, color: '#fb7185' }
        ];
        series.forEach(s => {
          const [cx,cy] = toXY({ y: s.val }, idx);
          const c = document.createElementNS(svgNS,'circle'); c.setAttribute('cx',cx); c.setAttribute('cy',cy); c.setAttribute('r',4); c.setAttribute('fill', s.color); c.setAttribute('stroke','#fff'); c.setAttribute('stroke-width','1.2'); circles.appendChild(c);
        });
        tooltip.style.display = 'block'; tooltip.style.left = (rect.left + px) + 'px'; tooltip.style.top = (rect.top + 16) + 'px';
        tooltip.innerHTML = `M${pv.month} â€” Balance ${formatMoney(pv.balance)}<br>Principal ${formatMoney(pv.cumP)} â€¢ Interest ${formatMoney(pv.cumI)} â€¢ Total ${formatMoney(pv.cumT)}`;
      });

      svg.addEventListener('mouseleave', ()=>{ vLine.setAttribute('x1',0); vLine.setAttribute('x2',0); circles.innerHTML=''; tooltip.style.display='none'; });

      drawerChartArea.appendChild(svg);
    })();

    openDrawer();
  }

  /* =====================================================
     KPI DRAWERS
     - Distribution (bar chart), TPV (tpv series), Rates (histogram), Payments (timeseries)
     ===================================================== */

  // helper: TPV series (same formula as before)
  function tpvSeries(loansList) {
    const maxMonths = Math.max(...loansList.map(l => l.amort.schedule.length));
    const series = [];
    for (let m = 1; m <= maxMonths; m++) {
      let total = 0;
      loansList.forEach(l => {
        const initial = l.purchasePrice;
        const accrued = l.amort.schedule.filter(s => s.monthIndex <= m && s.payment === 0).reduce((s, r) => s + r.interest, 0);
        const payments = l.amort.schedule.filter(s => s.monthIndex <= m).reduce((s, r) => s + r.payment, 0);
        total += initial + accrued + payments;
      });
      series.push({ month: m, value: total });
    }
    return series;
  }
  const tpvSeriesData = tpvSeries(loansWithAmort);

  function renderDistributionDrawer(){
    currentMode = 'kpi'; currentLoan = null;
    drawerTitle.textContent = 'Distribution â€” Loans by Purchase Month';
    drawerSub.textContent = 'Number of loans purchased by month';
    drawerAmortContainer.style.display = 'none'; drawerExtra.innerHTML = '';

    // counts by month
    const counts = {};
    loansWithAmort.forEach(l => { const m = monthLabelFromDate(l.purchaseDate); counts[m] = (counts[m] || 0) + 1; });
    const months = Object.keys(counts).sort();
    const values = months.map(m => counts[m]);
    // primary / secondary
    const totalInvested = loansWithAmort.reduce((s,l) => s + l.purchasePrice, 0);
    document.getElementById('drawerPrimaryTitle').textContent = 'Total Invested';
    document.getElementById('drawerPrimary').textContent = formatMoney(totalInvested);
    document.getElementById('drawerSecondaryTitle').textContent = 'Total Loans';
    document.getElementById('drawerSecondary').textContent = loansWithAmort.length + ' loans';

    // chart
    createBarChart(drawerChartArea, months, values, { color:'#0ea5e9' });

    // extra list
    drawerExtra.innerHTML = `<div style="margin-top:12px"><strong class="small">Loans</strong><div style="max-height:220px;overflow:auto;margin-top:6px;border-radius:6px;padding:6px;border:1px solid rgba(15,23,42,0.06);background:var(--surface)"><table style="width:100%"><thead><tr><th style="text-align:left">Loan</th><th>Purchase</th><th>Amount</th><th>Rate</th></tr></thead><tbody>${loansWithAmort.map(l=>`<tr><td style="text-align:left">Loan ${l.id}</td><td>${l.purchaseDate}</td><td>${formatMoney(l.purchasePrice)}</td><td>${(l.nominalRate*100).toFixed(2)}%</td></tr>`).join('')}</tbody></table></div></div>`;

    openDrawer();
  }

  function renderTPVDrawer(){
    currentMode='kpi'; currentLoan=null;
    drawerTitle.textContent = 'Total Portfolio Value';
    drawerSub.textContent = 'Purchase + accrued interest (grace) + cumulative payments';
    drawerAmortContainer.style.display = 'none'; drawerExtra.innerHTML = '';

    const curVal = tpvSeriesData[clamp(CURRENT_MONTH - 1, 0, tpvSeriesData.length - 1)].value;
    document.getElementById('drawerPrimaryTitle').textContent = 'Current TPV';
    document.getElementById('drawerPrimary').textContent = formatMoney(Math.round(curVal));
    document.getElementById('drawerSecondaryTitle').textContent = 'Total Invested';
    document.getElementById('drawerSecondary').textContent = formatMoney(loansWithAmort.reduce((s,l)=>s+l.purchasePrice,0));

    // draw TPV line (map to createLineChart friendly format)
    const series = tpvSeriesData.map(d => ({ x: d.month, y: d.value }));
    createLineChart(drawerChartArea, series, {
      color: '#0ea5e9',
      labelFn: (pt) => `M${pt.x} â€¢ TPV ${formatMoney(Math.round(pt.y))}`
    });

    drawerExtra.innerHTML = `<div style="margin-top:10px"><strong class="small">TPV Snapshot</strong><div style="font-size:18px;font-weight:800;margin-top:6px">${formatMoney(Math.round(curVal))}</div></div>`;
    openDrawer();
  }

  function renderRatesDrawer(){
    currentMode='kpi'; currentLoan=null;
    drawerTitle.textContent = 'Projected Weighted ROI';
    drawerSub.textContent = 'Projection to maturity';
    drawerAmortContainer.style.display = 'none'; drawerExtra.innerHTML = '';

    document.getElementById('drawerPrimaryTitle').textContent = 'Projected Weighted ROI';
    document.getElementById('drawerPrimary').textContent = (kpis.projectedWeightedROI*100).toFixed(2) + '%';
    document.getElementById('drawerSecondaryTitle').textContent = 'Projected Portfolio Value';
    const projectedPortfolioValue = loansWithAmort.reduce((s,l)=>s + ((l.roiSeries[l.roiSeries.length-1]||{}).loanValue || l.purchasePrice), 0);
    document.getElementById('drawerSecondary').textContent = formatMoney(projectedPortfolioValue);

    // projected weighted ROI series
    const monthsMax = loansWithAmort.reduce((m,l)=>Math.max(m, l.roiSeries.length), 0);
    const series = [];
    for (let m = 1; m <= monthsMax; m++){
      let weightedSum = 0, totalInvested = 0;
      loansWithAmort.forEach(l=>{
        const entry = l.roiSeries.find(r=>r.month===m);
        if(entry){ weightedSum += l.purchasePrice * entry.roi; totalInvested += l.purchasePrice; }
      });
      series.push({ x: m, y: totalInvested ? weightedSum / totalInvested : 0 });
    }
    createLineChart(drawerChartArea, series, { color: '#7c3aed', labelFn: (pt)=>`M${pt.x} â€¢ ${(pt.y*100).toFixed(2)}%` });

    drawerExtra.innerHTML = `<div style="margin-top:10px" class="small">Projected Weighted ROI (to maturity)</div>`;
    openDrawer();
  }

  function renderPaymentsDrawer(){
    currentMode='kpi'; currentLoan=null;
    drawerTitle.textContent = 'Average / Rate Distribution';
    drawerSub.textContent = 'Portfolio nominal rates';
    drawerAmortContainer.style.display = 'none'; drawerExtra.innerHTML = '';

    document.getElementById('drawerPrimaryTitle').textContent = 'Average Rate';
    document.getElementById('drawerPrimary').textContent = (kpis.avgRate*100).toFixed(2) + '%';
    const total = loansWithAmort.reduce((s,l)=>s + l.purchasePrice,0);
    const weightedAvgRate = loansWithAmort.reduce((s,l)=> s + l.nominalRate * l.purchasePrice, 0) / Math.max(1, total);
    document.getElementById('drawerSecondaryTitle').textContent = 'Weighted Avg Rate';
    document.getElementById('drawerSecondary').textContent = (weightedAvgRate*100).toFixed(2) + '%';

    const rates = loansWithAmort.map(l=>l.nominalRate);
    createHistogram(drawerChartArea, rates, 6, { color: '#0ea5e9' });

    drawerExtra.innerHTML = `<div style="margin-top:10px" class="small">Rates range: ${(Math.min(...rates)*100).toFixed(2)}% â€” ${(Math.max(...rates)*100).toFixed(2)}%</div>`;
    openDrawer();
  }

  /* =====================================================
     KPI TILE CLICK WIRING
     ===================================================== */
  document.querySelectorAll('.kpi').forEach(k=>{
    k.addEventListener('click', ev => {
      ev.stopPropagation();
      const key = k.getAttribute('data-kpi');
      if(key === 'distribution') renderDistributionDrawer();
      if(key === 'tpv') renderTPVDrawer();
      if(key === 'rates') renderRatesDrawer();
      if(key === 'payments') renderPaymentsDrawer();
    });
  });

  /* =====================================================
     CSV / COPY / PRINT helpers
     ===================================================== */
  function amortToCSV(loan){
    const rows = [['Month','Payment','Principal','Interest','Balance']];
    loan.amort.schedule.forEach(r=>rows.push([r.monthIndex, r.payment.toFixed(2), r.principalPaid.toFixed(2), r.interest.toFixed(2), r.balance.toFixed(2)]));
    return rows.map(r=>r.join(',')).join('\n');
  }

  document.getElementById('copyCsvBtn')?.addEventListener('click', async ()=>{
    if(currentMode !== 'loan' || !currentLoan) return alert('Open a loan drawer first');
    const csv = amortToCSV(currentLoan);
    try{ await navigator.clipboard.writeText(csv); alert('CSV copied to clipboard'); } catch(e){ alert('Copy failed â€” clipboard denied'); }
  });

  document.getElementById('downloadCsvBtn')?.addEventListener('click', ()=>{
    if(currentMode === 'loan' && currentLoan){
      const csv = amortToCSV(currentLoan); const blob = new Blob([csv],{type:'text/csv;charset=utf-8;'}); const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = `loan-${currentLoan.id}-amort.csv`; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    } else alert('Download CSV supported for individual loan drawers only.');
  });

  document.getElementById('printBtn')?.addEventListener('click', ()=>window.print());

  function copyPortfolioCSV(){
    let rows = [['Loan','Purchase Date','Amount','Rate']];
    loansWithAmort.forEach(l => rows.push([`Loan ${l.id}`, l.purchaseDate, l.purchasePrice, (l.nominalRate*100).toFixed(2)+'%']));
    const csv = rows.map(r=>r.join(',')).join('\n');
    navigator.clipboard.writeText(csv); alert('CSV copied to clipboard');
  }

  /* =====================================================
     CLICK OUTSIDE TO CLOSE DRAWER (keeps semantics)
     ===================================================== */
  document.addEventListener('click', function (e) {
    if(!drawer.classList.contains('open')) return;
    const clickedInsideDrawer = drawer.contains(e.target);
    const clickedTile = !!e.target.closest('.tile');
    if(!clickedInsideDrawer && !clickedTile) closeDrawer();
  });

  /* hide tooltip when grid scrolls */
  document.querySelector('.grid').addEventListener('scroll', ()=> tooltip.style.display='none');

  /* =====================================================
     THEME TOGGLE (manual override + persist)
     ===================================================== */
  const themeToggle = document.getElementById('themeToggle');
  const userTheme = localStorage.getItem('theme'); // 'dark'|'light'
  if(userTheme) document.documentElement.setAttribute('data-theme', userTheme);
  themeToggle.addEventListener('click', ()=>{
    const cur = document.documentElement.getAttribute('data-theme');
    const next = cur === 'dark' ? 'light' : 'dark';
    if(next === 'dark') document.documentElement.setAttribute('data-theme','dark'); else document.documentElement.removeAttribute('data-theme');
    localStorage.setItem('theme', next === 'dark' ? 'dark' : 'light');
  });

  /* =====================================================
     Accessibility: hide tooltip when user presses Escape, ARIA improvements
     ===================================================== */
  document.addEventListener('keydown', (e) => { if(e.key === 'Escape') tooltip.style.display='none'; });

  /* =====================================================
     END
     ===================================================== */
  </script>
</body>
</html>
