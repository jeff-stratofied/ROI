<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Loan Portfolio ‚Äî Unified Dashboard</title>

  <!-- ===========================================================
       Styles: variables, layout, components, dark mode, motion
       =========================================================== -->
  <style>
    /* ================
       Theme variables
       ================ */
    :root{
      --bg: #f1f5f9;
      --surface: #ffffff;
      --muted: #64748b;
      --text: #0f172a;
      --card-shadow: 0 6px 18px rgba(16,24,40,0.04);
      --card-border: rgba(15,23,42,0.04);
      --brand: #0ea5e9;
      --accent: #7c3aed;
      --success: #06b6d4;
      --danger: #fb7185;
      --glass: rgba(255,255,255,0.5);
      --kpi-hover: 0 12px 30px rgba(15,23,42,0.08);
      --tile-hover: 0 12px 30px rgba(15,23,42,0.08);
      --transition-fast: 180ms;
    }

    /* dark mode variables (applies when [data-theme="dark"]) */
    :root[data-theme="dark"]{
      --bg: #0b1220;
      --surface: #071022;
      --muted: #93a0b1;
      --text: #e6eef8;
      --card-shadow: 0 10px 30px rgba(2,6,23,0.6);
      --card-border: rgba(255,255,255,0.04);
      --brand: #38bdf8;
      --accent: #a78bfa;
      --success: #34d399;
      --danger: #fb7185;
      --glass: rgba(255,255,255,0.03);
      --kpi-hover: 0 10px 30px rgba(2,6,23,0.6);
      --tile-hover: 0 12px 30px rgba(2,6,23,0.5);
    }

    /* System prefers dark */
    @media (prefers-color-scheme: dark) {
      :root { /* leave defaults in root; toggle will flip to dark when user clicks */ }
    }

    /* ================
       Base layout + typography
       ================ */
    html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,Arial;color:var(--text)}
    body{background:linear-gradient(180deg,var(--bg) 0%, #f8fafc 100%);-webkit-font-smoothing:antialiased}
    .app{max-width:1200px;margin:20px auto;padding:18px}

    header{display:flex;align-items:flex-start;justify-content:space-between;gap:12px;margin-bottom:18px}
    .header-left{display:flex;flex-direction:column}
    h1{font-size:20px;margin:0;font-weight:700}
    .lead{margin:4px 0 0;color:var(--muted);font-size:13px}
    .header-right{display:flex;gap:12px;align-items:center}

    .current-month{font-size:13px;color:var(--muted)}

    /* Toggle button (matches Amort page visual) */
    .theme-toggle{
      display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:10px;border:1px solid var(--card-border);
      background:linear-gradient(180deg,var(--surface),rgba(255,255,255,0.96));cursor:pointer;font-weight:600;
      box-shadow:var(--card-shadow);
    }
    :root[data-theme="dark"] .theme-toggle{ background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)) }

    /* ================
       KPI grid + tiles (unified hover & spacing)
       ================ */
    .kpis{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin:12px 0 18px}
    @media(max-width:1000px){ .kpis{grid-template-columns:repeat(2,1fr)} }
    .kpi{
      background:var(--surface);padding:14px;border-radius:12px;border:1px solid var(--card-border);
      box-shadow:var(--card-shadow);cursor:pointer;transition:transform var(--transition-fast) ease,box-shadow var(--transition-fast) ease;
      display:flex;flex-direction:column;justify-content:space-between;
    }
    .kpi:hover{ transform: translateY(-6px); box-shadow: var(--kpi-hover); }
    .kpi h3{margin:0;font-size:12px;color:var(--muted);font-weight:600}
    .kpi .val{margin-top:8px;font-size:20px;font-weight:800}
    .kpi .mini { font-size:12px;color:var(--muted); margin-top:6px }

    /* ================
       Grid of loan tiles
       ================ */
    .grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px;height:calc(100vh - 360px);overflow:auto;padding-right:6px}
    @media(max-width:900px){ .grid{grid-template-columns:1fr;height:auto} }
    .tile{
      display:flex;align-items:center;justify-content:space-between;padding:12px;border-radius:12px;background:var(--surface);
      box-shadow:var(--card-shadow);border:1px solid var(--card-border);cursor:pointer;transition:transform var(--transition-fast) ease,box-shadow var(--transition-fast) ease;
    }
    .tile:hover{ transform: translateY(-6px); box-shadow: var(--tile-hover); }
    .tile-left{flex:1;padding-right:10px}
    .loan-name{font-weight:700;font-size:14px}
    .loan-sub{font-size:13px;color:var(--muted);margin-top:6px}
    .loan-meta{display:flex;gap:10px;font-size:12px;color:var(--muted);margin-top:8px}

    .chart-wrap{width:180px;flex-shrink:0;display:flex;flex-direction:column;align-items:flex-end}
    .mini-label{font-size:12px;color:var(--muted);margin-bottom:6px}
    svg.sparkline{width:180px;height:54px;display:block}

    /* ================
       Drawer (right) + overlay/backdrop + animations
       ================ */
    .backdrop{
      position:fixed;inset:0;background:rgba(2,6,23,0.12);backdrop-filter:blur(3px);opacity:0;pointer-events:none;transition:opacity .22s ease;z-index:88;
    }
    .backdrop.show{opacity:1;pointer-events:auto}
    .drawer{
      position:fixed;right:0;top:0;height:100vh;width:760px;max-width:100%;background:var(--surface);
      box-shadow:-28px 0 80px rgba(2,6,23,0.14);transform:translateX(110%);transition:transform .34s cubic-bezier(.2,.9,.3,1),opacity .22s ease;
      z-index:90;overflow:auto;padding:20px;border-left:1px solid var(--card-border);opacity:0;
    }
    .drawer.open{ transform:translateX(0); opacity:1; animation: drawerPop .32s cubic-bezier(.2,.9,.3,1); }
    @keyframes drawerPop { from { transform:translateX(14%); opacity:0 } to { transform:translateX(0); opacity:1 } }

    .drawer-head{display:flex;align-items:flex-start;justify-content:space-between;gap:8px}
    .drawer h2{margin:0 0 6px;font-size:20px}
    .muted{ color:var(--muted); font-size:13px; margin-bottom:10px }

    .close-btn{
      background:#f1f5f9;border:none;padding:8px;border-radius:8px;cursor:pointer; font-weight:700;
    }
    :root[data-theme="dark"] .close-btn{ background: rgba(255,255,255,0.03) }

    /* Drawer chart & info row */
    .drawer-chart{
      height:260px;background:linear-gradient(180deg,var(--surface),rgba(255,255,255,0.98));border-radius:10px;border:1px solid var(--card-border);
      display:block;position:relative;margin-bottom:10px;padding:8px;overflow:hidden;
    }
    .drawer .drawer-info-row{display:flex;gap:12px;margin-bottom:12px;align-items:center}
    .drawer .info-card{flex:1;background:var(--bg);padding:12px;border-radius:8px;border:1px solid var(--card-border);display:flex;flex-direction:column;justify-content:center}
    .drawer .info-card.small{width:160px;align-items:flex-end}
    .drawer .muted-small{font-size:12px;color:var(--muted);margin-bottom:6px}
    .drawer .main-val{font-weight:800;font-size:18px}
    .drawer .main-val.small{font-size:16px}

    .legend{display:flex;gap:10px;font-size:12px;align-items:center;margin-top:6px}
    .legend .item{display:flex;gap:6px;align-items:center}
    .legend .sw{width:12px;height:8px;border-radius:2px;display:inline-block}

    .amort-wrap{border:1px solid var(--card-border);border-radius:8px;padding:8px;max-height:40vh;overflow:auto}
    table{width:100%;border-collapse:collapse;font-size:13px}
    thead th{position:sticky;top:0;background:var(--surface);padding:8px;text-align:left;color:var(--muted);font-weight:700}
    td{padding:8px;border-bottom:1px dashed var(--card-border);text-align:right}
    td:first-child, th:first-child{text-align:left}

    .actions{display:flex;gap:8px;margin-top:12px}
    .btn{padding:8px 10px;border-radius:8px;border:1px solid rgba(15,23,42,0.06);background:transparent;cursor:pointer;font-weight:600}
    .btn.primary{background:linear-gradient(90deg,var(--brand),var(--accent));color:white;border:none}

    /* tooltip */
    .tooltip{position:fixed;pointer-events:none;background:var(--text);color:white;padding:6px 8px;border-radius:6px;font-size:12px;transform:translate(-50%,-120%);box-shadow:0 6px 18px rgba(2,6,23,0.2);display:none;z-index:9999;line-height:1.12}

    /* small helpers */
    .small{font-size:12px;color:var(--muted)}
    .muted-2{color:var(--muted);font-size:12px}

  </style>
</head>
<body>
  <div class="app" role="main">
    <!-- Header -->
    <header>
      <div class="header-left">
        <h1>Loan Portfolio ‚Äî Unified Dashboard</h1>
        <div class="lead">Interactive KPIs, mini-charts, and detailed drawers ‚Äî now with unified styling and dark mode.</div>
      </div>

      <div class="header-right">
        <div class="current-month">Current Month: <strong id="currentMonthLabel">18</strong></div>
        <button id="themeToggle" class="theme-toggle" aria-pressed="false" title="Toggle theme">üåô Toggle theme</button>
      </div>
    </header>

    <!-- KPI tiles (above tiles as requested) -->
    <section class="kpis" id="kpis" aria-label="Key performance indicators"></section>

    <!-- Loan tiles grid -->
    <section class="grid" id="loanGrid" aria-live="polite"></section>
  </div>

  <!-- Backdrop and Drawer -->
  <div id="backdrop" class="backdrop" aria-hidden="true"></div>
  <aside id="drawer" class="drawer" aria-hidden="true">
    <div class="drawer-head">
      <div>
        <h2 id="drawerTitle">Drawer</h2>
        <div class="muted" id="drawerSub">details</div>
      </div>

      <div style="display:flex;gap:8px;align-items:center">
        <button class="btn" id="downloadCsvBtn">Download CSV</button>
        <button class="close-btn" id="closeBtn" aria-label="Close drawer">‚úï</button>
      </div>
    </div>

    <!-- primary + secondary info row -->
    <div class="drawer-info-row" id="drawerInfoRow">
      <div class="info-card">
        <div class="muted-small" id="drawerPrimaryTitle">Primary</div>
        <div id="drawerPrimary" class="main-val"></div>
      </div>
      <div class="info-card small">
        <div class="muted-small" id="drawerSecondaryTitle">Secondary</div>
        <div id="drawerSecondary" class="main-val small"></div>
      </div>
    </div>

    <div id="drawerBody">
      <div class="drawer-chart" id="drawerChartArea"></div>
      <div class="legend" id="drawerLegend" style="display:none"></div>

      <div id="drawerExtra"></div>

      <div id="drawerAmortContainer" style="margin-top:12px;">
        <h3 style="margin-top:8px">Amortization</h3>
        <div class="amort-wrap" id="amortWrap">
          <table>
            <thead>
              <tr><th>Month</th><th>Payment</th><th>Principal</th><th>Interest</th><th>Balance</th></tr>
            </thead>
            <tbody id="amortBody"></tbody>
          </table>
        </div>
      </div>

      <div class="actions" style="padding-top:10px">
        <button class="btn" id="printBtn">Print</button>
        <button class="btn primary" id="copyCsvBtn">Copy CSV</button>
      </div>
    </div>
  </aside>

  <div id="tooltip" class="tooltip" role="status" aria-live="polite"></div>

  <!-- ===========================================================
       Script: organized sections ‚Äî constants, data, helpers, UI
       =========================================================== -->
  <script>
    /* ============================
       Constants & Initialization
       ============================ */
    const CURRENT_MONTH = 18;
    document.getElementById('currentMonthLabel').textContent = CURRENT_MONTH;

    // Default theme: follow system, but support toggle
    (function initTheme(){
      const root = document.documentElement;
      const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
      if(prefersDark) root.setAttribute('data-theme','dark');
      else root.removeAttribute('data-theme');
    })();

    document.getElementById('themeToggle').addEventListener('click', function(){
      const root = document.documentElement;
      const isDark = root.getAttribute('data-theme') === 'dark';
      if(isDark){ root.removeAttribute('data-theme'); this.setAttribute('aria-pressed','false'); this.textContent = 'üåô Toggle theme'; }
      else{ root.setAttribute('data-theme','dark'); this.setAttribute('aria-pressed','true'); this.textContent = '‚òÄÔ∏è Toggle theme'; }
    });

    /* ============================
       Sample loan data
       (Use your real data ‚Äî kept same shape as earlier)
       ============================ */
    const loans = [
      { id:1, purchaseDate:'2025-01-15', purchasePrice:10000, termYears:10, graceYears:4.5, nominalRate:0.08 },
      { id:2, purchaseDate:'2025-02-01', purchasePrice:7500, termYears:8, graceYears:2, nominalRate:0.075 },
      { id:3, purchaseDate:'2025-02-20', purchasePrice:12000, termYears:12, graceYears:3, nominalRate:0.0825 },
      { id:4, purchaseDate:'2025-03-10', purchasePrice:6000, termYears:9, graceYears:1.5, nominalRate:0.095 },
      { id:5, purchaseDate:'2025-03-30', purchasePrice:5000, termYears:10, graceYears:1, nominalRate:0.09 },
      { id:6, purchaseDate:'2025-04-15', purchasePrice:7500, termYears:5, graceYears:0, nominalRate:0.073 },
      { id:7, purchaseDate:'2025-04-30', purchasePrice:10000, termYears:8, graceYears:0, nominalRate:0.09 },
      { id:8, purchaseDate:'2025-05-20', purchasePrice:5000, termYears:9, graceYears:0.5, nominalRate:0.11 },
      { id:9, purchaseDate:'2025-06-10', purchasePrice:10000, termYears:7, graceYears:0.25, nominalRate:0.10 },
      { id:10,purchaseDate:'2025-06-30', purchasePrice:8000, termYears:3, graceYears:0, nominalRate:0.06 }
    ];

    /* ============================
       Amortization calculation (grace capitalized)
       ============================ */
    function calcAmort(principal, annualRate, termYears, graceYears) {
      const monthlyRate = annualRate / 12;
      const totalMonths = Math.round(termYears * 12);
      const graceMonths = Math.round(graceYears * 12);
      const repayMonths = Math.max(1, totalMonths - graceMonths);

      let balance = principal;
      const schedule = [];

      for (let m = 1; m <= graceMonths; m++) {
        const interest = +(balance * monthlyRate).toFixed(2);
        balance = +(balance + interest).toFixed(2);
        schedule.push({ monthIndex: m, payment: 0, principalPaid: 0, interest, balance });
      }

      const payment = monthlyRate === 0
        ? +(balance / repayMonths).toFixed(2)
        : +((balance * monthlyRate) / (1 - Math.pow(1 + monthlyRate, -repayMonths))).toFixed(2);

      for (let m = 1; m <= repayMonths; m++) {
        const interest = +(balance * monthlyRate).toFixed(2);
        const principalPaid = +Math.min(balance, +(payment - interest).toFixed(2));
        balance = +(Math.max(0, balance - principalPaid).toFixed(2));
        schedule.push({ monthIndex: graceMonths + m, payment: +payment.toFixed(2), principalPaid, interest, balance });
      }

      return { payment, schedule };
    }

    /* ============================
       Build loans with amort + cumulative metrics + ROI series
       ============================ */
    const loansWithAmort = loans.map(l => {
      const amort = calcAmort(l.purchasePrice, l.nominalRate, l.termYears, l.graceYears);

      let cumP = 0, cumI = 0, cumTotal = 0;
      const cumSchedule = amort.schedule.map(r => {
        cumP = +(cumP + r.principalPaid).toFixed(2);
        cumI = +(cumI + r.interest).toFixed(2);
        cumTotal = +(cumTotal + r.payment).toFixed(2);
        return { ...r, cumPrincipal: cumP, cumInterest: cumI, cumTotal };
      });

      // ROI series: loanValue = balance + cumInterest + cumTotal (minus assumed fees if any)
      const roiSeries = cumSchedule.map(s => {
        const loanValue = +(s.balance + s.cumInterest + s.cumTotal).toFixed(2);
        const roi = +( (loanValue - l.purchasePrice) / l.purchasePrice ).toFixed(6);
        return { month: s.monthIndex, roi, loanValue };
      });

      const miniPts = roiSeries.slice(0, Math.min(24, roiSeries.length)).map(s => ({ x: s.month, y: s.roi }));
      return { ...l, amort, cumSchedule, roiSeries, miniPts };
    });

    /* ============================
       KPI calculations
       ============================ */
    function computeKPIs(list) {
      const total = list.reduce((s, l) => s + l.purchasePrice, 0);
      const weightedRate = list.reduce((s, l) => s + l.nominalRate * l.purchasePrice, 0) / Math.max(1, total);
      const monthlyIncome = list.reduce((s, l) => s + (l.amort.schedule.length ? l.amort.schedule[0].payment : 0), 0);
      // weighted ROI to date (CURRENT_MONTH)
      const weightedROI = list.reduce((s, l) => {
        const idx = Math.min(CURRENT_MONTH - 1, l.roiSeries.length - 1);
        const r = (l.roiSeries[idx] || {}).roi || 0;
        return s + r * l.purchasePrice;
      }, 0) / Math.max(1, total);

      // projected weighted ROI at maturity
      const projectedWeightedROI = list.reduce((s, l) => {
        const last = l.roiSeries[l.roiSeries.length - 1] || { roi: 0 };
        return s + last.roi * l.purchasePrice;
      }, 0) / Math.max(1, total);

      return { total, weightedRate, monthlyIncome, weightedROI, projectedWeightedROI };
    }

    const kpis = computeKPIs(loansWithAmort);

    /* ============================
       UI helpers: small chart builders & utilities
       - createLineChart: interactive, shows current-month dotted line
       - createBarChart: used in KPI drawers
       - histogram builder
       ============================ */

    function createLineChart(containerEl, series, opts = {}) {
      containerEl.innerHTML = '';
      const svgNS = 'http://www.w3.org/2000/svg';
      const rect = containerEl.getBoundingClientRect();
      const w = Math.max(480, rect.width || 600);
      const h = opts.h || 260;
      const pad = opts.pad || 28;

      const svg = document.createElementNS(svgNS, 'svg');
      svg.setAttribute('viewBox', `0 0 ${w} ${h}`);
      svg.setAttribute('width', '100%');
      svg.setAttribute('height', '100%');
      svg.style.display = 'block';

      const data = series.length ? series.slice() : [{ x: 0, y: 0 }];
      const ys = data.map(d => d.y);
      const xs = data.map(d => d.x);

      const minY = Math.min(...ys), maxY = Math.max(...ys);
      const minX = Math.min(...xs), maxX = Math.max(...xs);
      const rangeY = Math.max(1e-6, maxY - minY);
      const rangeX = Math.max(1e-6, maxX - minX);

      const stepX = (w - pad * 2) / Math.max(1, data.length - 1);
      function toXY(d, i) {
        const x = pad + i * stepX;
        const y = pad + (h - pad * 2) - ((d.y - minY) / rangeY) * (h - pad * 2);
        return [x, y];
      }

      // grid lines
      for (let gy = 0; gy < 5; gy++) {
        const y = pad + gy * ((h - pad * 2) / 4);
        const line = document.createElementNS(svgNS, 'line');
        line.setAttribute('x1', pad); line.setAttribute('x2', w - pad); line.setAttribute('y1', y); line.setAttribute('y2', y);
        line.setAttribute('stroke', '#eef2f7'); line.setAttribute('stroke-width', '1'); svg.appendChild(line);
      }

      // build path
      let path = '';
      data.forEach((p, i) => {
        const [x, y] = toXY(p, i);
        path += (i === 0 ? `M ${x} ${y}` : ` L ${x} ${y}`);
      });
      const el = document.createElementNS(svgNS, 'path');
      el.setAttribute('d', path); el.setAttribute('fill', 'none');
      el.setAttribute('stroke', opts.color || '#0ea5e9'); el.setAttribute('stroke-width', '2');
      svg.appendChild(el);

      // current-month dotted line (maps CURRENT_MONTH to x coordinate if applicable)
      // If series x values are monotonic months starting at 1, find x for CURRENT_MONTH
      const months = data.map(d => d.x);
      const firstMonth = months[0] || 1;
      const lastMonth = months[months.length - 1] || firstMonth;
      const monthIndex = Math.max(firstMonth, Math.min(CURRENT_MONTH, lastMonth));
      const idxForCur = data.findIndex(d => d.x === monthIndex);
      const curX = (idxForCur >= 0) ? toXY(data[idxForCur], idxForCur)[0] : pad;

      const curLine = document.createElementNS(svgNS, 'line');
      curLine.setAttribute('x1', curX); curLine.setAttribute('x2', curX);
      curLine.setAttribute('y1', pad); curLine.setAttribute('y2', h - pad);
      curLine.setAttribute('stroke', '#111827'); curLine.setAttribute('stroke-dasharray', '3 4'); curLine.setAttribute('stroke-opacity', '0.5');
      svg.appendChild(curLine);

      // hover overlay
      const vLine = document.createElementNS(svgNS, 'line'); vLine.setAttribute('stroke', '#0f172a'); vLine.setAttribute('stroke-dasharray', '3 4'); vLine.setAttribute('opacity', '0.7');
      svg.appendChild(vLine);
      const hoverGroup = document.createElementNS(svgNS, 'g'); hoverGroup.setAttribute('class', 'hover'); svg.appendChild(hoverGroup);

      svg.addEventListener('mousemove', function (ev) {
        const rect = svg.getBoundingClientRect();
        const svgX = ev.clientX - rect.left;
        let idx = Math.round((svgX - pad) / stepX);
        idx = Math.max(0, Math.min(data.length - 1, idx));
        const point = data[idx];
        const [cx, cy] = toXY(point, idx);
        vLine.setAttribute('x1', cx); vLine.setAttribute('x2', cx); vLine.setAttribute('y1', pad); vLine.setAttribute('y2', h - pad);

        hoverGroup.innerHTML = '';
        const c = document.createElementNS(svgNS, 'circle');
        c.setAttribute('cx', cx); c.setAttribute('cy', cy); c.setAttribute('r', 4); c.setAttribute('fill', opts.color || '#0ea5e9'); c.setAttribute('stroke', '#fff'); c.setAttribute('stroke-width', '1.2');
        hoverGroup.appendChild(c);

        tooltip.style.display = 'block';
        tooltip.style.left = (rect.left + cx) + 'px';
        tooltip.style.top = (rect.top + cy - 28) + 'px';
        const label = (opts.labelFn && typeof opts.labelFn === 'function') ? opts.labelFn(point, idx) : `M${point.x} ‚Ä¢ ${(point.y*100).toFixed(2)}%`;
        tooltip.innerHTML = label;
      });

      svg.addEventListener('mouseleave', function () { hoverGroup.innerHTML = ''; vLine.setAttribute('x1', 0); vLine.setAttribute('x2', 0); tooltip.style.display = 'none'; });

      containerEl.appendChild(svg);
      return svg;
    }

    function createBarChart(containerEl, keys, values, opts = {}) {
      containerEl.innerHTML = '';
      const svgNS = 'http://www.w3.org/2000/svg';
      const rect = containerEl.getBoundingClientRect();
      const w = Math.max(480, rect.width || 600);
      const h = opts.h || 260;
      const padL = opts.padL || 60;
      const padR = opts.padR || 20;
      const padT = opts.padT || 30;
      const padB = opts.padB || 55;

      const svg = document.createElementNS(svgNS, 'svg');
      svg.setAttribute('viewBox', `0 0 ${w} ${h}`); svg.setAttribute('width', '100%'); svg.setAttribute('height', '100%');

      const maxValue = Math.max(...values, 1);
      const barW = (w - padL - padR) / Math.max(1, keys.length);

      // y grid & labels
      for (let i = 0; i <= 4; i++) {
        const y = padT + (h - padT - padB) * (i / 4);
        const line = document.createElementNS(svgNS, 'line');
        line.setAttribute('x1', padL); line.setAttribute('x2', w - padR); line.setAttribute('y1', y); line.setAttribute('y2', y); line.setAttribute('stroke', '#eef2f7'); svg.appendChild(line);

        const val = Math.round(maxValue * (1 - i / 4));
        const lbl = document.createElementNS(svgNS, 'text'); lbl.textContent = opts.yFn ? opts.yFn(val) : ('$' + val.toLocaleString());
        lbl.setAttribute('x', padL - 10); lbl.setAttribute('y', y + 4); lbl.setAttribute('font-size', '11'); lbl.setAttribute('fill', '#64748b'); lbl.setAttribute('text-anchor', 'end');
        svg.appendChild(lbl);
      }

      const hoverG = document.createElementNS(svgNS, 'g'); hoverG.setAttribute('class', 'hover'); svg.appendChild(hoverG);

      keys.forEach((k, i) => {
        const amount = values[i];
        const x = padL + i * barW;
        const barHeight = (amount / maxValue) * (h - padT - padB);
        const y = padT + (h - padT - padB) - barHeight;
        const rectEl = document.createElementNS(svgNS, 'rect');
        rectEl.setAttribute('x', x + 8); rectEl.setAttribute('y', y); rectEl.setAttribute('width', barW - 16); rectEl.setAttribute('height', barHeight);
        rectEl.setAttribute('rx', 6); rectEl.setAttribute('fill', opts.color || '#0ea5e9'); rectEl.style.cursor = 'pointer';
        svg.appendChild(rectEl);

        rectEl.addEventListener('mousemove', ev => {
          hoverG.innerHTML = '';
          const rectBox = svg.getBoundingClientRect();
          const cx = ev.clientX - rectBox.left;
          const cy = ev.clientY - rectBox.top - 14;
          const bg = document.createElementNS(svgNS, 'rect'); bg.setAttribute('x', cx - 36); bg.setAttribute('y', cy - 18); bg.setAttribute('width', 72); bg.setAttribute('height', 22); bg.setAttribute('rx', 6); bg.setAttribute('fill', 'rgba(255,255,255,0.95)'); bg.setAttribute('stroke', '#cbd5e1'); hoverG.appendChild(bg);
          const tip = document.createElementNS(svgNS, 'text'); tip.textContent = opts.labelFn ? opts.labelFn(amount, i) : ('$' + Math.round(amount).toLocaleString()); tip.setAttribute('x', cx); tip.setAttribute('y', cy - 4); tip.setAttribute('font-size', '12'); tip.setAttribute('text-anchor', 'middle'); tip.setAttribute('fill', '#0f172a'); hoverG.appendChild(tip);
        });
        rectEl.addEventListener('mouseleave', () => { hoverG.innerHTML = ''; });

        const txt = document.createElementNS(svgNS, 'text'); txt.textContent = k; txt.setAttribute('x', x + barW / 2); txt.setAttribute('y', h - padB + 20); txt.setAttribute('font-size', '11'); txt.setAttribute('text-anchor', 'middle'); txt.setAttribute('fill', '#64748b'); svg.appendChild(txt);
      });

      containerEl.appendChild(svg);
      return svg;
    }

    function createHistogram(containerEl, values, bins = 6, opts = {}) {
      // compute counts
      const minV = Math.min(...values), maxV = Math.max(...values);
      const range = Math.max(1e-6, maxV - minV);
      const binSize = range / bins;
      const counts = new Array(bins).fill(0);
      values.forEach(v => {
        let idx = Math.floor((v - minV) / binSize);
        if (idx === bins) idx = bins - 1;
        counts[idx]++;
      });
      const labels = counts.map((_, i) => {
        const a = minV + i * binSize; const b = a + binSize;
        return `${(a*100).toFixed(1)}‚Äì${(b*100).toFixed(1)}%`;
      });
      return createBarChart(containerEl, labels, counts, opts);
    }

    /* ============================
       Render KPI tiles & Loan tiles
       ============================ */
    const kpisEl = document.getElementById('kpis');
    kpisEl.innerHTML = `
      <div class="kpi" data-kpi="distribution"><h3>Total Loans</h3><div class="val">${loansWithAmort.length}</div><div class="mini">Loans purchased over time</div></div>
      <div class="kpi" data-kpi="tpv"><h3>Weighted ROI to Date</h3><div id="wroiTile" class="val">${(kpis.weightedROI*100).toFixed(2)}%</div><div class="mini">Portfolio weighted ROI (M${CURRENT_MONTH})</div></div>
      <div class="kpi" data-kpi="rates"><h3>Projected Weighted ROI</h3><div id="wprojTile" class="val">${(kpis.projectedWeightedROI*100).toFixed(2)}%</div><div class="mini">Projection to maturity</div></div>
      <div class="kpi" data-kpi="payments"><h3>Avg Rate</h3><div id="avgRateTile" class="val">${(kpis.weightedRate*100).toFixed(2)}%</div><div class="mini">Purchase-weighted</div></div>
    `;

    // Render loan tiles with mini sparklines
    const grid = document.getElementById('loanGrid');
    const tooltip = document.getElementById('tooltip');

    function buildPathFromPoints(points, w=180, h=54, pad=6){
      if(!points || !points.length) return '';
      const ys = points.map(p => p.y);
      const minY = Math.min(...ys), maxY = Math.max(...ys);
      const range = Math.max(1e-6, maxY - minY);
      const stepX = (w - pad*2) / Math.max(1, points.length - 1);
      let d = '';
      points.forEach((p, i) => {
        const x = pad + i * stepX;
        const y = pad + (h - pad*2) - ((p.y - minY)/range)*(h - pad*2);
        d += (i===0? `M ${x} ${y}` : ` L ${x} ${y}`);
      });
      return d;
    }

    loansWithAmort.forEach((loan, idx) => {
      const tile = document.createElement('div'); tile.className = 'tile'; tile.setAttribute('tabindex','0');
      tile.innerHTML = `
        <div class="tile-left">
          <div class="loan-name">Loan ${loan.id}</div>
          <div class="loan-sub">$${loan.purchasePrice.toLocaleString()}</div>
          <div class="loan-meta"><div>Term: ${loan.termYears}y</div><div>Grace: ${loan.graceYears}y</div></div>
        </div>
        <div class="chart-wrap">
          <div class="mini-label">ROI ${( (loan.roiSeries[Math.min(CURRENT_MONTH-1, loan.roiSeries.length-1)]||{}).roi || 0) * 100).toFixed(2)}%</div>
          <svg class="sparkline" viewBox="0 0 180 54" preserveAspectRatio="none" data-idx="${idx}" aria-hidden="true"></svg>
        </div>
      `;

      tile.addEventListener('click', e => { e.stopPropagation(); openDrawerForLoan(loan); });
      tile.addEventListener('keydown', e => { if(e.key === 'Enter' || e.key === ' ') { e.preventDefault(); openDrawerForLoan(loan); } });

      grid.appendChild(tile);

      // draw sparkline
      const svg = tile.querySelector('svg.sparkline');
      const w=180,h=54,pad=6;
      const pts = loan.miniPts && loan.miniPts.length ? loan.miniPts : loan.roiSeries.map(s => ({ x: s.month, y: s.roi }));
      const path = buildPathFromPoints(pts, w, h, pad);

      // compute current month x relative to loan (loans may have different start months)
      const earliestDate = loansWithAmort.reduce((mn, L) => mn < new Date(L.purchaseDate) ? mn : new Date(L.purchaseDate), new Date(loansWithAmort[0].purchaseDate));
      const diffMonths = (new Date(loan.purchaseDate).getFullYear() - earliestDate.getFullYear())*12 + (new Date(loan.purchaseDate).getMonth() - earliestDate.getMonth());
      let curIdx = CURRENT_MONTH - diffMonths;
      curIdx = Math.max(1, Math.min(curIdx, Math.max(1, pts.length)));
      const stepX = (w - pad*2) / Math.max(1, pts.length - 1);
      const dashX = pad + (curIdx - 1) * stepX;

      svg.innerHTML = `
        <path d="${path}" fill="none" stroke="#0ea5e9" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"></path>
        <g class="mini-hover"></g>
        <line class="current-line" x1="${dashX}" y1="2" x2="${dashX}" y2="${h-2}" stroke="#111827" stroke-dasharray="3 3" stroke-opacity="0.6" />
      `;

      // mini hover tooltip
      svg.addEventListener('mousemove', ev => {
        const rect = svg.getBoundingClientRect();
        const relX = ev.clientX - rect.left;
        const idxNearest = Math.round((relX - pad) / stepX);
        const i = Math.max(0, Math.min(pts.length - 1, idxNearest));
        const pt = pts[i];
        const rs = loan.roiSeries.find(r => r.month === (pt.x || (i+1))) || loan.roiSeries[i] || { month: 0, roi: 0 };
        tooltip.style.left = ev.clientX + 'px'; tooltip.style.top = (ev.clientY - 10) + 'px'; tooltip.style.display = 'block';
        tooltip.innerHTML = `M${rs.month} ‚Ä¢ ROI ${(rs.roi*100).toFixed(2)}%`;

        // hover dot
        const hoverG = svg.querySelector('g.mini-hover'); hoverG.innerHTML = '';
        const ys = pts.map(p=>p.y), minY = Math.min(...ys), maxY = Math.max(...ys), range = Math.max(1e-6, maxY - minY);
        const cx = pad + i * stepX;
        const cy = pad + (h - pad*2) - ((pt.y - minY) / range) * (h - pad*2);
        const c = document.createElementNS('http://www.w3.org/2000/svg','circle');
        c.setAttribute('cx', cx); c.setAttribute('cy', cy); c.setAttribute('r', 3.8); c.setAttribute('fill', '#0ea5e9'); c.setAttribute('stroke','#fff'); c.setAttribute('stroke-width','1');
        hoverG.appendChild(c);
      });
      svg.addEventListener('mouseleave', () => { tooltip.style.display='none'; const hoverG = svg.querySelector('g.mini-hover'); if(hoverG) hoverG.innerHTML=''; });
    });

    /* ============================
       Drawer & KPI Drawer renderers
       - openDrawerForLoan: full multi-line chart + amort table + current line
       - renderDistributionDrawer, renderTPVDrawer, renderRatesDrawer, renderPaymentsDrawer
       ============================ */
    const drawer = document.getElementById('drawer');
    const backdrop = document.getElementById('backdrop');
    const drawerTitle = document.getElementById('drawerTitle');
    const drawerSub = document.getElementById('drawerSub');
    const drawerPrimaryTitle = document.getElementById('drawerPrimaryTitle');
    const drawerPrimary = document.getElementById('drawerPrimary');
    const drawerSecondaryTitle = document.getElementById('drawerSecondaryTitle');
    const drawerSecondary = document.getElementById('drawerSecondary');
    const drawerChartArea = document.getElementById('drawerChartArea');
    const drawerLegend = document.getElementById('drawerLegend');
    const drawerExtra = document.getElementById('drawerExtra');
    const drawerAmortContainer = document.getElementById('drawerAmortContainer');
    const amortBody = document.getElementById('amortBody');

    let currentLoan = null, currentMode = null;

    function openDrawer() {
      drawer.classList.add('open'); backdrop.classList.add('show');
      drawer.setAttribute('aria-hidden','false'); backdrop.setAttribute('aria-hidden','false');
      document.body.style.overflow = 'hidden'; // avoid background scroll
      drawer.scrollTop = 0;
    }
    function closeDrawer() {
      drawer.classList.remove('open'); backdrop.classList.remove('show');
      drawer.setAttribute('aria-hidden','true'); backdrop.setAttribute('aria-hidden','true');
      document.body.style.overflow = '';
      tooltip.style.display = 'none'; currentLoan = null; currentMode = null;
    }
    document.getElementById('closeBtn').addEventListener('click', closeDrawer);
    backdrop.addEventListener('click', closeDrawer);
    document.addEventListener('keydown', e => { if(e.key === 'Escape') closeDrawer(); });

    // Download / Copy CSV
    function amortToCSV(loan) {
      const rows = [['Month','Payment','Principal','Interest','Balance']];
      loan.amort.schedule.forEach(r => rows.push([r.monthIndex, r.payment.toFixed(2), r.principalPaid.toFixed(2), r.interest.toFixed(2), r.balance.toFixed(2)]));
      return rows.map(r => r.join(',')).join('\n');
    }
    document.getElementById('copyCsvBtn').addEventListener('click', async () => {
      if(currentMode !== 'loan' || !currentLoan) return alert('Open a loan drawer to copy CSV');
      try { await navigator.clipboard.writeText(amortToCSV(currentLoan)); alert('CSV copied'); } catch(e){ alert('Copy failed'); }
    });
    document.getElementById('downloadCsvBtn').addEventListener('click', () => {
      if(currentMode === 'loan' && currentLoan){
        const csv = amortToCSV(currentLoan); const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'}); const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = `loan-${currentLoan.id}-amort.csv`; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
      } else alert('Download available for individual loan drawers only.');
    });

    document.getElementById('printBtn').addEventListener('click', () => window.print());

    // Open individual loan drawer
    function openDrawerForLoan(loan) {
      currentMode = 'loan'; currentLoan = loan;
      drawerTitle.textContent = `Loan ${loan.id}`;
      drawerSub.textContent = `Purchased: ${loan.purchaseDate}`;
      drawerPrimaryTitle.textContent = 'Purchase Price'; drawerPrimary.textContent = `$${loan.purchasePrice.toLocaleString()}`;
      drawerSecondaryTitle.textContent = 'Nominal Rate'; drawerSecondary.textContent = `${(loan.nominalRate*100).toFixed(2)}%`;

      // amort table
      drawerAmortContainer.style.display = 'block';
      amortBody.innerHTML = '';
      loan.amort.schedule.forEach(r => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td style="text-align:left">${r.monthIndex}</td><td style="text-align:right">$${Number(r.payment).toFixed(2)}</td><td style="text-align:right">$${Number(r.principalPaid).toFixed(2)}</td><td style="text-align:right">$${Number(r.interest).toFixed(2)}</td><td style="text-align:right">$${Number(r.balance).toFixed(2)}</td>`;
        amortBody.appendChild(tr);
      });

      // chart: balance + cumPrincipal + cumInterest + total
      drawerChartArea.innerHTML = ''; drawerLegend.style.display = 'flex';
      drawerLegend.innerHTML = `
        <div class="item"><span class="sw" style="background:#0f172a"></span>Balance</div>
        <div class="item"><span class="sw" style="background:${getComputedStyle(document.documentElement).getPropertyValue('--success') || '#06b6d4'}"></span>Cum Principal</div>
        <div class="item"><span class="sw" style="background:${getComputedStyle(document.documentElement).getPropertyValue('--accent') || '#a78bfa'}"></span>Cum Interest</div>
        <div class="item"><span class="sw" style="background:${getComputedStyle(document.documentElement).getPropertyValue('--danger') || '#fb7185'}"></span>Total</div>
      `;

      const schedule = loan.cumSchedule;
      const balances = loan.amort.schedule.map(s => ({ x: s.monthIndex, y: s.balance }));
      const cumP = schedule.map(s => ({ x: s.monthIndex, y: s.cumPrincipal }));
      const cumI = schedule.map(s => ({ x: s.monthIndex, y: s.cumInterest }));
      const cumT = schedule.map(s => ({ x: s.monthIndex, y: s.cumTotal }));

      // build combined series for scaling then plot each as line using createLineChart-like logic
      // We'll render all four series into one svg for consistent scaling and interactive hover
      function renderMultiLine(targetEl, seriesObjs, opts = {}) {
        targetEl.innerHTML = '';
        const svgNS = 'http://www.w3.org/2000/svg';
        const rect = targetEl.getBoundingClientRect();
        const w = Math.max(480, rect.width || 600);
        const h = opts.h || 260;
        const pad = opts.pad || 28;
        const svg = document.createElementNS(svgNS, 'svg'); svg.setAttribute('viewBox', `0 0 ${w} ${h}`); svg.setAttribute('width','100%'); svg.setAttribute('height','100%');

        const allPoints = seriesObjs.flatMap(s => s.data);
        const ys = allPoints.map(p => p.y);
        const minY = Math.min(...ys), maxY = Math.max(...ys);
        const range = Math.max(1e-6, maxY - minY);
        const length = Math.max(...seriesObjs.map(s => s.data.length));
        const stepX = (w - pad*2) / Math.max(1, length - 1);

        // grid
        for(let gy=0; gy<5; gy++){ const y = pad + gy * ((h - pad*2)/4); const line = document.createElementNS(svgNS, 'line'); line.setAttribute('x1', pad); line.setAttribute('x2', w-pad); line.setAttribute('y1', y); line.setAttribute('y2', y); line.setAttribute('stroke','#eef2f7'); svg.appendChild(line); }

        function toXY(point, i) { const x = pad + i * stepX; const y = pad + (h - pad*2) - ((point.y - minY)/range)*(h - pad*2); return [x,y]; }

        seriesObjs.forEach((s) => {
          let path = '';
          s.data.forEach((p, i) => { const [x,y] = toXY(p, i); path += (i===0?`M ${x} ${y}`:` L ${x} ${y}`); });
          const el = document.createElementNS(svgNS,'path'); el.setAttribute('d', path); el.setAttribute('fill','none'); el.setAttribute('stroke', s.color); el.setAttribute('stroke-width', s.width || '1.6'); svg.appendChild(el);
        });

        // current month vertical line (use CURRENT_MONTH mapped to x if present)
        const sample = seriesObjs[0].data;
        const firstMonth = sample.length ? sample[0].x : 1;
        const lastMonth = sample.length ? sample[sample.length-1].x : firstMonth;
        const monthIndex = Math.max(firstMonth, Math.min(CURRENT_MONTH, lastMonth));
        const idxForCur = sample.findIndex(p => p.x === monthIndex);
        const curX = (idxForCur >= 0) ? toXY(sample[idxForCur], idxForCur)[0] : pad;
        const curLine = document.createElementNS(svgNS,'line'); curLine.setAttribute('x1', curX); curLine.setAttribute('x2', curX); curLine.setAttribute('y1', pad); curLine.setAttribute('y2', h-pad); curLine.setAttribute('stroke','#111827'); curLine.setAttribute('stroke-dasharray','3 4'); curLine.setAttribute('stroke-opacity','0.6'); svg.appendChild(curLine);

        // hover
        const vLine = document.createElementNS(svgNS, 'line'); vLine.setAttribute('stroke','#0f172a'); vLine.setAttribute('stroke-dasharray','3 4'); vLine.setAttribute('opacity','0.7'); svg.appendChild(vLine);
        const circles = document.createElementNS(svgNS,'g'); svg.appendChild(circles);

        svg.addEventListener('mousemove', ev => {
          const rect = svg.getBoundingClientRect(); const x = ev.clientX - rect.left;
          let idx = Math.round((x - pad)/stepX); idx = Math.max(0, Math.min(length-1, idx));
          const px = pad + idx * stepX;
          vLine.setAttribute('x1', px); vLine.setAttribute('x2', px); vLine.setAttribute('y1', pad); vLine.setAttribute('y2', h - pad);
          circles.innerHTML = '';

          // show circle for each series at idx (if exists)
          seriesObjs.forEach(s => {
            const p = s.data[idx];
            if(!p) return;
            const [cx, cy] = toXY(p, idx);
            const c = document.createElementNS(svgNS,'circle'); c.setAttribute('cx', cx); c.setAttribute('cy', cy); c.setAttribute('r', 4); c.setAttribute('fill', s.color); c.setAttribute('stroke', '#fff'); c.setAttribute('stroke-width','1.2'); circles.appendChild(c);
          });

          // tooltip near vLine
          tooltip.style.display = 'block';
          tooltip.style.left = (rect.left + px) + 'px';
          tooltip.style.top = (rect.top + 16) + 'px';
          // aggregate values
          const vals = seriesObjs.map(s => {
            const p = s.data[idx]; return p ? `${s.label}: $${Math.round(p.y).toLocaleString()}` : `${s.label}: -`;
          }).join('<br>');
          tooltip.innerHTML = `M${(seriesObjs[0].data[idx]||{}).x || idx+1}<br>${vals}`;
        });

        svg.addEventListener('mouseleave', () => { circles.innerHTML = ''; vLine.setAttribute('x1',0); vLine.setAttribute('x2',0); tooltip.style.display = 'none'; });

        targetEl.appendChild(svg);
        return svg;
      }

      renderMultiLine(drawerChartArea, [
        { data: balances, color: '#0f172a', label: 'Balance', width: 2 },
        { data: cumP, color: getComputedStyle(document.documentElement).getPropertyValue('--success') || '#06b6d4', label: 'Cum Principal', width: 1.6 },
        { data: cumI, color: getComputedStyle(document.documentElement).getPropertyValue('--accent') || '#a78bfa', label: 'Cum Interest', width: 1.6 },
        { data: cumT, color: getComputedStyle(document.documentElement).getPropertyValue('--danger') || '#fb7185', label: 'Total', width: 1.4 }
      ]);

      openDrawer();
    }

    /* ============================
       KPI Drawer: Distribution (Total Loans)
       - Primary: Total Invested
       - Secondary: Total Loans
       - Chart: bar by purchase month
       ============================ */
    function monthLabel(dateStr) {
      const d = new Date(dateStr + 'T00:00:00'); return d.toLocaleString(undefined, { year: 'numeric', month: 'short' });
    }

    function renderDistributionDrawer(){
      currentMode = 'kpi'; currentLoan = null;
      drawerTitle.textContent = 'Distribution ‚Äî Loans by Purchase Month';
      drawerSub.textContent = 'Number of loans purchased by month';

      const totals = {};
      loansWithAmort.forEach(l => { const m = monthLabel(l.purchaseDate); totals[m] = (totals[m] || 0) + l.purchasePrice; });
      const keys = Object.keys(totals).sort((a,b)=> new Date(a) - new Date(b));
      const values = keys.map(k => totals[k]);
      const totalInvested = values.reduce((a,b)=>a+b,0);

      drawerPrimaryTitle.textContent = 'Total Invested'; drawerPrimary.textContent = `$${totalInvested.toLocaleString()}`;
      drawerSecondaryTitle.textContent = 'Total Loans'; drawerSecondary.textContent = `${loansWithAmort.length} loans`;

      drawerAmortContainer.style.display = 'none';
      drawerExtra.innerHTML = '';

      // bar chart
      createBarChart(drawerChartArea, keys, values, { color: '#0ea5e9', labelFn: amt => '$' + Math.round(amt).toLocaleString() });

      // loan table
      drawerExtra.innerHTML = `<div style="margin-top:10px"><strong class="small">Loans</strong><div style="max-height:220px;overflow:auto;margin-top:6px;border-radius:6px;padding:6px;border:1px solid var(--card-border);background:var(--surface)"><table style="width:100%"><thead><tr><th>Loan</th><th>Purchase</th><th>Amount</th><th>Rate</th></tr></thead><tbody>${
        loansWithAmort.map(l => `<tr><td style="text-align:left">Loan ${l.id}</td><td style="text-align:left">${l.purchaseDate}</td><td>$${l.purchasePrice.toLocaleString()}</td><td>${(l.nominalRate*100).toFixed(2)}%</td></tr>`).join('')
      }</tbody></table></div></div>`;

      openDrawer();
    }

    /* ============================
       KPI Drawer: TPV / Weighted ROI to Date
       - Primary: Weighted ROI to Date
       - Secondary: Portfolio Value (M CURRENT_MONTH)
       - Chart: weighted ROI timeseries
       ============================ */
    function renderTPVDrawer(){
      currentMode='kpi'; currentLoan=null;
      drawerTitle.textContent = 'Portfolio ‚Äî Weighted ROI (To Date)'; drawerSub.textContent = 'Snapshot';

      // compute portfolio value at CURRENT_MONTH
      let portfolioValue = 0;
      loansWithAmort.forEach(l => {
        const idx = Math.min(CURRENT_MONTH - 1, l.roiSeries.length - 1);
        const row = l.roiSeries[idx] || { loanValue: l.purchasePrice };
        portfolioValue += (row.loanValue || l.purchasePrice);
      });

      drawerPrimaryTitle.textContent = 'Weighted ROI to Date';
      drawerPrimary.textContent = `${(kpis.weightedROI*100).toFixed(2)}%`;
      drawerSecondaryTitle.textContent = 'Portfolio Value';
      drawerSecondary.textContent = `$${Math.round(portfolioValue).toLocaleString()}`;

      drawerAmortContainer.style.display = 'none';
      drawerExtra.innerHTML = '';

      // build series by month up to max months across loans
      const monthsMax = loansWithAmort.reduce((m,l)=>Math.max(m, l.roiSeries.length), 0);
      const series = [];
      for(let m=1;m<=monthsMax;m++){
        let totalInvested=0, weightedSum=0;
        loansWithAmort.forEach(l => {
          const entry = l.roiSeries.find(r => r.month === m);
          if(entry){ weightedSum += entry.roi * l.purchasePrice; totalInvested += l.purchasePrice; }
        });
        const wroi = totalInvested ? (weightedSum / totalInvested) : 0;
        series.push({ x: m, y: wroi });
      }

      createLineChart(drawerChartArea, series, { color: '#0f172a', labelFn: p => `M${p.x} ‚Ä¢ Weighted ROI ${(p.y*100).toFixed(2)}%` });

      drawerExtra.innerHTML = `<div style="margin-top:10px"><strong class="small">Weighted ROI to date</strong><div style="font-size:18px;font-weight:800;margin-top:6px">${(kpis.weightedROI*100).toFixed(2)}%</div></div>`;
      openDrawer();
    }

    /* ============================
       KPI Drawer: Projected Weighted ROI
       - Primary: Projected Weighted ROI
       - Secondary: Projected Portfolio Value
       - Chart: projected ROI curve
       ============================ */
    function renderRatesDrawer(){
      currentMode='kpi'; currentLoan=null;
      drawerTitle.textContent = 'Projected Weighted ROI'; drawerSub.textContent = 'Projection to maturity';

      const projectedPortfolioValue = loansWithAmort.reduce((s,l)=> s + ((l.roiSeries[l.roiSeries.length-1]||{loanValue:l.purchasePrice}).loanValue || l.purchasePrice), 0);

      drawerPrimaryTitle.textContent = 'Projected Weighted ROI';
      drawerPrimary.textContent = `${(kpis.projectedWeightedROI*100).toFixed(2)}%`;
      drawerSecondaryTitle.textContent = 'Projected Portfolio Value';
      drawerSecondary.textContent = `$${Math.round(projectedPortfolioValue).toLocaleString()}`;

      drawerAmortContainer.style.display = 'none';
      drawerExtra.innerHTML = '';

      const monthsMax = loansWithAmort.reduce((m,l)=>Math.max(m,l.roiSeries.length),0);
      const series = [];
      for(let m=1;m<=monthsMax;m++){
        let totalInvested=0, weightedSum=0;
        loansWithAmort.forEach(l => {
          const entry = l.roiSeries.find(r => r.month === m);
          if(entry){ weightedSum += l.purchasePrice * entry.roi; totalInvested += l.purchasePrice; }
        });
        series.push({ x: m, y: totalInvested ? (weightedSum / totalInvested) : 0 });
      }

      createLineChart(drawerChartArea, series, { color: '#7c3aed', labelFn: p => `M${p.x} ‚Ä¢ Projected ROI ${(p.y*100).toFixed(2)}%` });
      drawerExtra.innerHTML = `<div style="margin-top:8px" class="small">Projected Weighted ROI (to maturity)</div>`;
      openDrawer();
    }

    /* ============================
       KPI Drawer: Avg Rate
       - Primary: Average Rate
       - Secondary: Weighted Avg Rate
       - Chart: histogram of nominal rates
       ============================ */
    function renderPaymentsDrawer(){
      currentMode='kpi'; currentLoan=null;
      drawerTitle.textContent = 'Average / Rate Distribution'; drawerSub.textContent = 'Portfolio nominal rates';

      drawerPrimaryTitle.textContent = 'Average Rate';
      drawerPrimary.textContent = `${(kpis.weightedRate*100).toFixed(2)}%`;

      const total = loansWithAmort.reduce((s,l)=> s + l.purchasePrice, 0);
      const weightedAvgRate = loansWithAmort.reduce((s,l)=> s + l.nominalRate * l.purchasePrice, 0) / Math.max(1,total);
      drawerSecondaryTitle.textContent = 'Weighted Avg Rate';
      drawerSecondary.textContent = `${(weightedAvgRate*100).toFixed(2)}%`;

      drawerAmortContainer.style.display = 'none';
      drawerExtra.innerHTML = '';

      const rates = loansWithAmort.map(l => l.nominalRate);
      createHistogram(drawerChartArea, rates, 6, { color: '#0ea5e9' });

      drawerExtra.innerHTML = `<div style="margin-top:10px" class="small">Rates range: ${(Math.min(...rates)*100).toFixed(2)}% ‚Äî ${(Math.max(...rates)*100).toFixed(2)}%</div>`;
      openDrawer();
    }

    /* ============================
       Wire KPI tile clicks and global behavior
       ============================ */
    document.querySelectorAll('.kpi').forEach(k => {
      k.addEventListener('click', ev => {
        ev.stopPropagation();
        const key = k.getAttribute('data-kpi');
        if(key === 'distribution') renderDistributionDrawer();
        if(key === 'tpv') renderTPVDrawer();
        if(key === 'rates') renderRatesDrawer();
        if(key === 'payments') renderPaymentsDrawer();
      });
    });

    // Close drawer by clicking outside or pressing Escape handled above

    // Hide tooltip on grid scroll
    document.querySelector('.grid').addEventListener('scroll', () => tooltip.style.display = 'none');

    // Accessibility: close drawer when resizing to tiny screens
    window.addEventListener('resize', () => {
      if(window.innerWidth < 600) closeDrawer();
    });

    // Expose open loan drawer on global for debugging if needed:
    window.openDrawerForLoan = openDrawerForLoan;
  </script>
</body>
</html>
