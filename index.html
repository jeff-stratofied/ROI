<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Loan Portfolio — ROI Dashboard</title>
  <style>
    :root{--muted:#64748b;--card:#ffffff;--brand:#0ea5e9;--accent:#7c3aed}
    html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto;color:#0f172a;background:linear-gradient(180deg,#f1f5f9 0%, #f8fafc 100%)}
    .app{max-width:1200px;margin:20px auto;padding:16px}
    header{display:flex;flex-direction:column;gap:8px;margin-bottom:12px}
    .header-top{display:flex;align-items:center;justify-content:space-between}
    h1{ font-size:20px; margin:0 }
    p.lead{ margin:0; color:var(--muted); font-size:13px }
    .current-date{ font-size:13px; color:var(--muted); margin-top:4px }

    /* KPI row */
    .kpis{ display:grid; grid-template-columns:repeat(4,1fr); gap:12px; margin:14px 0 18px }
    .kpi{ background:var(--card); padding:12px; border-radius:10px; box-shadow:0 6px 18px rgba(16,24,40,0.04); border:1px solid rgba(15,23,42,0.04); cursor:pointer; transition: transform .18s, box-shadow .18s }
    .kpi:hover{ transform:translateY(-6px); box-shadow:0 12px 30px rgba(15,23,42,0.08) }
    .kpi h3{ margin:0; font-size:12px; color:var(--muted) }
    .kpi p{ margin:8px 0 0; font-size:18px; font-weight:700 }

    /* Portfolio tile full-width */
    .portfolio-tile{ background:var(--card); padding:12px; border-radius:10px; margin-bottom:12px; box-shadow:0 6px 18px rgba(16,24,40,0.04); border:1px solid rgba(15,23,42,0.04) }

    .grid{ display:grid; grid-template-columns:repeat(2,1fr); gap:12px; height:calc(100vh - 420px); overflow:auto; padding-right:6px }
    @media(max-width:900px){ .grid{ grid-template-columns:1fr; height:auto } .kpis{ grid-template-columns:repeat(2,1fr) } }

    .tile{ display:flex; align-items:center; justify-content:space-between; padding:10px 12px; border-radius:12px; background:var(--card); min-height:90px; cursor:pointer; overflow:hidden; transition: transform .18s ease, box-shadow .18s ease }
    .tile:hover{ transform:translateY(-6px); box-shadow:0 12px 30px rgba(15,23,42,0.08) }

    .tile-left{ flex:1; padding-right:10px }
    .loan-name{ font-weight:700; font-size:14px }
    .loan-sub{ font-size:12px; color:var(--muted); margin-top:6px }
    .loan-meta{ display:flex; gap:8px; font-size:12px; color:var(--muted); margin-top:8px }

    .chart-wrap{ width:220px; flex-shrink:0; display:flex; flex-direction:column; align-items:flex-end }
    .mini-label{ font-size:12px; color:var(--muted); margin-bottom:6px }
    svg.sparkline{ width:220px; height:64px; display:block }

    .drawer{ position:fixed; right:0; top:0; height:100vh; width:620px; background:var(--card); box-shadow:-28px 0 80px rgba(2,6,23,0.14); transform:translateX(110%); transition:transform .28s cubic-bezier(.2,.9,.3,1); z-index:90; overflow:auto; padding:20px }
    .drawer.open{ transform:translateX(0) }
    .drawer-head{ display:flex; align-items:start; justify-content:space-between; gap:8px }
    .close-btn{ background:#f1f5f9; border:none; padding:8px; border-radius:8px; cursor:pointer }
    .drawer-chart{ height:260px; background:linear-gradient(180deg,#ffffff,#fcfeff); border-radius:8px; border:1px solid rgba(15,23,42,0.03); display:flex; align-items:center; justify-content:center; margin-bottom:8px; position:relative; padding:8px }

    .roi-table{ width:100%; border-collapse:collapse; font-size:13px }
    .roi-table th{ text-align:left; padding:6px; background:#fbfdff; position:sticky; top:0 }
    .roi-table td{ padding:6px; border-bottom:1px dashed rgba(15,23,42,0.04); text-align:right }
    .roi-table td:first-child{ text-align:left }

    .small{ font-size:12px; color:var(--muted) }

    .controls{ display:flex; gap:8px; align-items:center; margin-bottom:8px }

    .btn{ padding:8px 10px; border-radius:8px; border:1px solid rgba(15,23,42,0.06); background:transparent; cursor:pointer; font-weight:600 }
    .btn.primary{ background:linear-gradient(90deg,var(--brand),var(--accent)); color:white; border:none }

    .filter-wrap{ display:flex; gap:8px; align-items:center }

    .accordion{ border:1px solid rgba(15,23,42,0.04); border-radius:6px; overflow:hidden; margin-top:8px }
    .accordion .acc-head{ background:#f8fafc; padding:8px; cursor:pointer }
    .accordion .acc-body{ display:none; padding:8px; background:#fff }

    .status-dot{ width:10px;height:10px;border-radius:50%;display:inline-block;margin-right:6px; }

    .muted{ color:var(--muted) }
  </style>
</head>
<body>
  <div class="app" role="main">
    <header>
      <div class="header-top">
        <div>
          <h1>Loan Portfolio — ROI Dashboard</h1>
          <p class="lead">Weighted portfolio ROI • ROI breakdowns • filtering & sorting</p>
        </div>
        <div style="display:flex;gap:10px;align-items:center">
          <div style="font-size:13px;color:var(--muted)">Brand: <strong style="color:var(--brand)">Enhanced ABC Lending Co.</strong></div>
        </div>
      </div>
      <div class="current-date">Current Month: <strong id="currentMonthLabel">18</strong></div>
    </header>

    <!-- Portfolio mini chart full width -->
    <div class="portfolio-tile" id="portfolioTile">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div>
          <div class="small muted">Portfolio — Weighted ROI</div>
          <div style="font-weight:800;font-size:20px" id="portfolioCurrent">--%</div>
        </div>
        <div style="width:70%">
          <svg id="portfolioSpark" viewBox="0 0 800 120" preserveAspectRatio="none" style="width:100%;height:80px"></svg>
        </div>
      </div>
    </div>

    <section class="kpis" id="kpis"></section>

    <div class="controls">
      <div class="filter-wrap">
        <label class="small">Status:</label>
        <select id="statusFilter"><option value="all">All</option><option value="current">Current</option><option value="delinquent">Delinquent</option><option value="paid">Paid</option></select>
      </div>
      <div style="margin-left:auto;display:flex;gap:8px">
        <button class="btn" id="sortRoi">Sort by ROI</button>
        <button class="btn" id="sortDate">Sort by Purchase Date</button>
      </div>
    </div>

    <section class="grid" id="loanGrid" aria-live="polite"></section>
  </div>

  <!-- Drawer -->
  <aside id="drawer" class="drawer" aria-hidden="true">
    <div class="drawer-head">
      <div>
        <h2 id="drawerTitle">Loan</h2>
        <div class="muted" id="drawerSub">details</div>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <button class="btn" id="downloadCsvBtn">Download CSV</button>
        <button class="close-btn" id="closeBtn" aria-label="Close drawer">✕</button>
      </div>
    </div>

    <div id="drawerBody">
      <div class="drawer-chart" id="drawerChartArea"></div>
      <div id="drawerMeta" style="display:flex;gap:10px;margin-bottom:8px">
        <div style="flex:1;background:#f8fafc;padding:10px;border-radius:8px">
          <div class="small muted" id="drawerPrimaryTitle">Purchase Price</div>
          <div id="drawerPrimary" style="font-weight:800;font-size:18px"></div>
        </div>
        <div style="width:140px;background:#f8fafc;padding:10px;border-radius:8px">
          <div class="small muted">Maturity</div>
          <div id="drawerMaturity" style="font-weight:800;font-size:16px"></div>
        </div>
      </div>

      <div id="roiTableWrap"></div>

      <!-- hidden accordion for amort tables (collapsed by default) -->
      <div class="accordion" id="amortAccordion">
        <div class="acc-head">Show Amortization Table</div>
        <div class="acc-body" id="amortAccBody"></div>
      </div>
    </div>
  </aside>

  <div id="tooltip" style="position:fixed;pointer-events:none;display:none;background:#0f172a;color:#fff;padding:6px 8px;border-radius:6px;font-size:12px;z-index:9999"></div>

  <script>
    // ===== Settings & Data =====
    const CURRENT_MONTH = 18;
    document.getElementById('currentMonthLabel').textContent = CURRENT_MONTH;

    // Flat servicing fee per month
    const SERVICER_FEE = 3.0;

    const loans = [
      { id:1, purchaseDate:'2024-01-01', purchasePrice:7000, termYears:10, graceYears:0.83, nominalRate:0.0883, status:'current' },
      { id:2, purchaseDate:'2024-02-01', purchasePrice:7500, termYears:8, graceYears:2, nominalRate:0.075, status:'current' },
      { id:3, purchaseDate:'2024-03-01', purchasePrice:12000, termYears:12, graceYears:3, nominalRate:0.0825, status:'delinquent' },
      { id:4, purchaseDate:'2024-04-01', purchasePrice:6000, termYears:9, graceYears:1.5, nominalRate:0.095, status:'current' },
      { id:5, purchaseDate:'2024-07-01', purchasePrice:5000, termYears:10, graceYears:1, nominalRate:0.09, status:'paid' },
      { id:6, purchaseDate:'2025-01-01', purchasePrice:7500, termYears:5, graceYears:0, nominalRate:0.073, status:'current' },
      { id:7, purchaseDate:'2025-06-01', purchasePrice:10000, termYears:8, graceYears:0, nominalRate:0.09, status:'current' },
      { id:8, purchaseDate:'2025-10-01', purchasePrice:5000, termYears:9, graceYears:0.5, nominalRate:0.11, status:'current' },
      { id:9, purchaseDate:'2025-02-01', purchasePrice:10000, termYears:7, graceYears:0.25, nominalRate:0.10, status:'current' },
      { id:10,purchaseDate:'2025-03-01', purchasePrice:8000, termYears:3, graceYears:0, nominalRate:0.06, status:'current' }
    ];

    // ===== Amortization && ROI calc (interest capitalizes during grace) =====
    function calcAmort(principal, annualRate, termYears, graceYears){
      const monthlyRate = annualRate/12;
      const totalMonths = Math.round(termYears*12);
      const graceMonths = Math.round(graceYears*12);
      const repayMonths = Math.max(1, totalMonths - graceMonths);
      let balance = principal;
      const schedule = [];
      // grace months - interest accrues and capitalizes
      for(let m=1;m<=graceMonths;m++){
        const interest = +(balance*monthlyRate).toFixed(2);
        balance = +(balance + interest).toFixed(2);
        schedule.push({ monthIndex:m, payment:0, principalPaid:0, interest, balance, fees:0 });
      }
      // payment computed on capitalized balance
      const payment = monthlyRate===0 ? +(balance/repayMonths).toFixed(2) : +((balance*monthlyRate)/(1-Math.pow(1+monthlyRate,-repayMonths))).toFixed(2);
      for(let m=1;m<=repayMonths;m++){
        const interest = +(balance*monthlyRate).toFixed(2);
        const principalPaid = +Math.min(balance, +(payment - interest).toFixed(2));
        balance = +(Math.max(0, balance - principalPaid).toFixed(2));
        schedule.push({ monthIndex: graceMonths + m, payment:+payment.toFixed(2), principalPaid, interest, balance, fees: SERVICER_FEE });
      }
      return { payment, schedule };
    }

    // build loansWithAmort and roi series
    const loansWithAmort = loans.map(l=>{
      const amort = calcAmort(l.purchasePrice, l.nominalRate, l.termYears, l.graceYears);
      let cumP=0, cumI=0, cumTotal=0, cumFees=0;
      const cumSchedule = amort.schedule.map(r=>{
        cumP=+(cumP + r.principalPaid).toFixed(2);
        cumI=+(cumI + r.interest).toFixed(2);
        cumTotal=+(cumTotal + r.payment).toFixed(2);
        cumFees = +(cumFees + (r.fees||0)).toFixed(2);
        // loan value as balance + cumInterest + cumPayments - feesPaid? We'll include fees as reduction of loan value.
        const loanValue = +(r.balance + cumI + cumTotal - cumFees).toFixed(2);
        const roi = +( (loanValue - l.purchasePrice) / l.purchasePrice ).toFixed(6);
        return {...r, cumPrincipal:cumP, cumInterest:cumI, cumTotal, cumFees, loanValue, roi};
      });
      const roiSeries = cumSchedule.map(s=>({month:s.monthIndex, roi:s.roi, loanValue:s.loanValue, cumFees:s.cumFees, cumInterest:s.cumInterest, cumPrincipal:s.cumPrincipal}));
      return {...l, amort, cumSchedule, roiSeries};
    });

    // KPIs compute (weighted ROI)
    function computeKPIs(list){
      const total = list.reduce((s,l)=>s+l.purchasePrice,0);
      const weightedROI = list.reduce((s,l)=> s + l.purchasePrice * ( (l.roiSeries[Math.min(CURRENT_MONTH-1, l.roiSeries.length-1)]||{}).roi || 0 ), 0) / Math.max(1, total);
      const projectedWeightedROI = list.reduce((s,l)=> s + l.purchasePrice * ( (l.roiSeries[l.roiSeries.length-1]||{}).roi || 0 ), 0) / Math.max(1, total);
      const avgRate = list.reduce((s,l)=> s + l.nominalRate * l.purchasePrice,0)/ Math.max(1, total);
      return { total, weightedROI, projectedWeightedROI, avgRate };
    }

    let loansView = loansWithAmort.slice(); // filtered/sorted view
    let kpis = computeKPIs(loansWithAmort);

    // render KPIs
    const kpisEl = document.getElementById('kpis');
    function renderKpis(){
      kpis = computeKPIs(loansWithAmort);
      kpisEl.innerHTML = `
        <div class="kpi" data-kpi="distribution"><h3>Total Loans</h3><p>${loansWithAmort.length}</p></div>
        <div class="kpi" data-kpi="tpv"><h3>Current Weighted ROI</h3><p id="wroi">${(kpis.weightedROI*100).toFixed(2)}%</p></div>
        <div class="kpi" data-kpi="rates"><h3>Projected Weighted ROI</h3><p id="wproj">${(kpis.projectedWeightedROI*100).toFixed(2)}%</p></div>
        <div class="kpi" data-kpi="payments"><h3>Avg Rate</h3><p>${(kpis.avgRate*100).toFixed(2)}%</p></div>`;
      document.querySelectorAll('.kpi').forEach(k=>k.addEventListener('click', (e)=>{ e.stopPropagation(); const key=k.getAttribute('data-kpi'); if(key==='distribution') openKpiDrawer(); if(key==='tpv') openPortfolioDrawer(); }));
    }

    // portfolio mini chart (weighted ROI series)
    function buildPortfolioSeries(){
      // find max months among loans
      const maxMonths = Math.max(...loansWithAmort.map(l=>l.roiSeries.length));
      const series=[];
      for(let m=1;m<=maxMonths;m++){
        let numerator=0, denom=0;
        loansWithAmort.forEach(l=>{
          const idx = Math.min(l.roiSeries.length-1, m-1);
          const val = l.roiSeries[idx] ? l.roiSeries[idx].loanValue : l.purchasePrice;
          numerator += val * l.purchasePrice;
          denom += l.purchasePrice;
        });
        const weighted = denom ? (numerator/denom - (loansWithAmort.reduce((s,l)=>s+l.purchasePrice,0)/loansWithAmort.length)) : 0;
        // Instead of weird scale, compute weighted ROI as weighted avg of roi:
        const weightedRoi = loansWithAmort.reduce((s,l)=> s + l.purchasePrice * ( (l.roiSeries[Math.min(l.roiSeries.length-1, m-1)]||{}).roi || 0 ), 0) / Math.max(1, loansWithAmort.reduce((s,l)=>s+l.purchasePrice,0));
        series.push({month:m, roi:weightedRoi});
      }
      return series;
    }

    function renderPortfolioMini(){
      const series = buildPortfolioSeries();
      // update current value
      const cur = series[Math.min(CURRENT_MONTH-1, series.length-1)] || {roi:0};
      document.getElementById('portfolioCurrent').textContent = (cur.roi*100).toFixed(2) + '%';
      // draw sparkline in svg#portfolioSpark
      const svg = document.getElementById('portfolioSpark');
      const w=800,h=120,pad=20;
      const ys = series.map(s=>s.roi);
      const minY = Math.min(...ys); const maxY = Math.max(...ys); const range = Math.max(1e-6, maxY-minY);
      const stepX = (w - pad*2) / Math.max(1, series.length -1);
      let d='';
      series.forEach((p,i)=>{ const x = pad + i*stepX; const y = pad + (h - pad*2) - ((p.roi - minY)/range)*(h - pad*2); d += (i===0?`M ${x} ${y}`:` L ${x} ${y}`); });
      svg.innerHTML = `<path d="${d}" fill="none" stroke="#0ea5e9" stroke-width="2"/>`;
      // draw current marker
      const curIdx = Math.min(CURRENT_MONTH-1, series.length-1);
      const curX = pad + curIdx*stepX;
      svg.innerHTML += `<line x1="${curX}" x2="${curX}" y1="${pad}" y2="${h-pad}" stroke="#111827" stroke-dasharray="3 4" stroke-opacity="0.4"/>`;
    }

    // render loans grid
    const grid = document.getElementById('loanGrid');
    function renderLoans(list){
      grid.innerHTML='';
      list.forEach(loan=>{
        const el = document.createElement('div'); el.className='tile'; el.tabIndex=0;
        el.innerHTML = `
          <div class="tile-left">
            <div class="loan-name">Loan ${loan.id} <span class="small muted">• ${loan.status}</span></div>
            <div class="loan-sub">$${loan.purchasePrice.toLocaleString()}</div>
            <div class="loan-meta"><div>Term: ${loan.termYears}y</div><div>Grace: ${loan.graceYears}y</div></div>
          </div>
          <div class="chart-wrap">
            <div class="mini-label">ROI ${( (loan.roiSeries[Math.min(CURRENT_MONTH-1, loan.roiSeries.length-1)]||{}).roi || 0)*100).toFixed(2)}%</div>
            <svg class="sparkline" viewBox="0 0 220 64" preserveAspectRatio="none" data-id="${loan.id}"></svg>
          </div>`;
        el.addEventListener('click',(e)=>{ e.stopPropagation(); openDrawerForLoan(loan); });
        grid.appendChild(el);

        // draw mini sparkline
        const svg = el.querySelector('svg.sparkline'); const w=220,h=64,pad=6;
        const pts = loan.roiSeries.map(s=>({y:s.roi}));
        if(pts.length){
          const ys = pts.map(p=>p.y); const minY=Math.min(...ys); const maxY=Math.max(...ys); const range=Math.max(1e-6,maxY-minY);
          const stepX=(w-pad*2)/Math.max(1,pts.length-1);
          let d='';
          pts.forEach((p,i)=>{ const x=pad + i*stepX; const y=pad + (h-pad*2) - ((p.y-minY)/range)*(h-pad*2); d += (i===0?`M ${x} ${y}`:` L ${x} ${y}`); });
          svg.innerHTML = `<path d="${d}" fill="none" stroke="#06b6d4" stroke-width="1.6"/>`;
          // current month line
          const curX = pad + Math.min(CURRENT_MONTH-1, pts.length-1)*stepX;
          svg.innerHTML += `<line x1="${curX}" x2="${curX}" y1="2" y2="${h-2}" stroke="#111827" stroke-dasharray="3 3" stroke-opacity="0.4"/>`;
        }
      });
    }

    // Drawer helpers
    const drawer = document.getElementById('drawer');
    const drawerTitle = document.getElementById('drawerTitle');
    const drawerSub = document.getElementById('drawerSub');
    const drawerPrimary = document.getElementById('drawerPrimary');
    const drawerSecondary = document.getElementById('drawerSecondary');
    const drawerChartArea = document.getElementById('drawerChartArea');
    const roiTableWrap = document.getElementById('roiTableWrap');
    const amortAccordion = document.getElementById('amortAccordion');
    const amortAccBody = document.getElementById('amortAccBody');
    let currentLoan=null;

    document.getElementById('closeBtn').addEventListener('click', closeDrawer);
    document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeDrawer(); });

    function closeDrawer(){ drawer.classList.remove('open'); drawer.setAttribute('aria-hidden','true'); document.getElementById('tooltip').style.display='none'; currentLoan=null; }

    function openDrawerForLoan(loan){
      currentLoan=loan;
      drawerTitle.textContent = `Loan ${loan.id}`;
      drawerSub.textContent = `Purchased: ${loan.purchaseDate}`;
      drawerPrimary.textContent = `$${loan.purchasePrice.toLocaleString()}`;
      // maturity display: compute original maturity date
      const pd = new Date(loan.purchaseDate + 'T00:00:00');
      const totalMonths = Math.round(loan.termYears*12);
      pd.setMonth(pd.getMonth() + totalMonths);
      const matStr = pd.toISOString().slice(0,10);
      drawerSecondary.textContent = `${(loan.nominalRate*100).toFixed(2)}%`;
      document.getElementById('drawerMaturity').textContent = matStr + ' (' + monthsUntil(pd) + ' months left)';

      // build drawer ROI chart with hover hotspots
      drawerChartArea.innerHTML='';
      const svgNS='http://www.w3.org/2000/svg'; const w=560,h=260,pad=36;
      const svg = document.createElementNS(svgNS,'svg'); svg.setAttribute('viewBox',`0 0 ${w} ${h}`); svg.setAttribute('width','100%'); svg.setAttribute('height','100%');
      const series = loan.roiSeries;
      const vals = series.map(s=>s.loanValue); const minV=Math.min(...vals), maxV=Math.max(...vals), rangeV=Math.max(1, maxV-minV);
      const stepX = (w - pad*2)/Math.max(1, series.length-1);
      // grid
      for(let gy=0;gy<5;gy++){ const y = pad + gy*((h-pad*2)/4); const line=document.createElementNS(svgNS,'line'); line.setAttribute('x1',pad); line.setAttribute('x2',w-pad); line.setAttribute('y1',y); line.setAttribute('y2',y); line.setAttribute('stroke','#eef2f7'); line.setAttribute('stroke-width','1'); svg.appendChild(line); }
      // path for loanValue
      let path=''; series.forEach((p,i)=>{ const x = pad + i*stepX; const y = pad + (h-pad*2) - ((p.loanValue - minV)/rangeV)*(h-pad*2); path += (i===0?`M ${x} ${y}`:` L ${x} ${y}`); });
      const el = document.createElementNS(svgNS,'path'); el.setAttribute('d',path); el.setAttribute('fill','none'); el.setAttribute('stroke','#0f172a'); el.setAttribute('stroke-width','2'); svg.appendChild(el);
      // hover line & circles
      const vLine = document.createElementNS(svgNS,'line'); vLine.setAttribute('stroke','#0f172a'); vLine.setAttribute('stroke-dasharray','3 4'); vLine.setAttribute('opacity','0.6'); svg.appendChild(vLine);
      const circlesG = document.createElementNS(svgNS,'g'); svg.appendChild(circlesG);

      // build hotspots (transparent rects)
      series.forEach((p,i)=>{
        const x = pad + i*stepX;
        const hit = document.createElementNS(svgNS,'rect');
        hit.setAttribute('x', x - stepX/2); hit.setAttribute('y', pad); hit.setAttribute('width', Math.max(1,stepX)); hit.setAttribute('height', h - pad*2);
        hit.setAttribute('fill','transparent');
        hit.style.cursor='crosshair';
        hit.addEventListener('mousemove', (ev)=>{
          const px = x;
          vLine.setAttribute('x1',px); vLine.setAttribute('x2',px); vLine.setAttribute('y1',pad); vLine.setAttribute('y2',h-pad);
          circlesG.innerHTML='';
          // compute positions for circles for loan value and roi
          const [cx,cy] = [x, pad + (h-pad*2) - ((p.loanValue - minV)/rangeV)*(h-pad*2)];
          const c = document.createElementNS(svgNS,'circle'); c.setAttribute('cx',cx); c.setAttribute('cy',cy); c.setAttribute('r',4); c.setAttribute('fill','#0ea5e9'); c.setAttribute('stroke','#fff'); c.setAttribute('stroke-width','1.2'); circlesG.appendChild(c);
          // tooltip content
          const tip = `M${p.month} • Value $${Math.round(p.loanValue).toLocaleString()} • ROI ${(p.roi*100).toFixed(2)}% • Int $${Math.round(p.cumInterest).toLocaleString()} • Fees $${Math.round(p.cumFees).toLocaleString()}`;
          const tt = document.getElementById('tooltip'); tt.style.display='block'; tt.style.left = (ev.clientX + 10) + 'px'; tt.style.top = (ev.clientY + 6) + 'px'; tt.innerHTML = tip;
          // highlight corresponding row in ROI table
          const rows = document.querySelectorAll('#roiTableWrap table tr'); rows.forEach(r=>r.classList.remove('highlight'));
          const target = document.querySelector('#roiTableWrap table tr[data-month=\"'+p.month+'\"]');
          if(target) target.classList.add('highlight');
        });
        hit.addEventListener('mouseleave', ()=>{ vLine.setAttribute('x1',0); vLine.setAttribute('x2',0); circlesG.innerHTML=''; document.getElementById('tooltip').style.display='none'; const rows=document.querySelectorAll('#roiTableWrap table tr'); rows.forEach(r=>r.classList.remove('highlight')); });
        svg.appendChild(hit);
      });

      drawerChartArea.appendChild(svg);

      // ROI by date table (includes fees breakdown)
      buildRoiTable(loan);

      // amort table inside accordion (collapsed)
      amortAccBody.innerHTML = buildAmortHtml(loan);
      amortAccordion.querySelector('.acc-head').onclick = function(){ const body = amortAccordion.querySelector('.acc-body'); body.style.display = body.style.display === 'block' ? 'none' : 'block'; };

      drawer.classList.add('open'); drawer.setAttribute('aria-hidden','false'); drawer.scrollTop=0;
    }

    function buildRoiTable(loan){
      let html = '<div style="margin-top:6px"><strong class="small">ROI by Month (includes fees)</strong><div style="max-height:300px;overflow:auto;margin-top:6px;border-radius:6px;padding:6px;border:1px solid #f0f3f7"><table class="roi-table"><thead><tr><th>Month</th><th>Payment</th><th>Principal</th><th>Interest</th><th>Accrued Int</th><th>Fees</th><th>Loan Value</th><th style="text-align:right">ROI%</th></tr></thead><tbody>';
      loan.roiSeries.forEach(r=>{
        html += `<tr data-month="${r.month}"><td>${r.month}</td><td>$${(r.cumTotal - (r.prevCumTotal||0)).toFixed(2)}</td><td>$${r.cumPrincipal.toFixed(2)}</td><td>$${r.cumInterest.toFixed(2)}</td><td>$${r.cumInterest.toFixed(2)}</td><td>$${r.cumFees.toFixed(2)}</td><td>$${Math.round(r.loanValue).toLocaleString()}</td><td style="text-align:right">${(r.roi*100).toFixed(2)}%</td></tr>`;
      });
      html += '</tbody></table></div></div>';
      roiTableWrap.innerHTML = html;
    }

    function buildAmortHtml(loan){
      let html = '<table style="width:100%;font-size:13px"><thead><tr><th>Month</th><th style="text-align:right">Payment</th><th style="text-align:right">Principal</th><th style="text-align:right">Interest</th><th style="text-align:right">Balance</th></tr></thead><tbody>';
      loan.amort.schedule.forEach(r=>{ html += `<tr><td>${r.monthIndex}</td><td style="text-align:right">$${r.payment.toFixed(2)}</td><td style="text-align:right">$${r.principalPaid.toFixed(2)}</td><td style="text-align:right">$${r.interest.toFixed(2)}</td><td style="text-align:right">$${r.balance.toFixed(2)}</td></tr>`; });
      html += '</tbody></table>';
      return html;
    }

    // utility: months until date
    function monthsUntil(d){
      const now = new Date();
      const years = d.getFullYear() - now.getFullYear();
      const months = d.getMonth() - now.getMonth();
      return years*12 + months;
    }

    // KPI drawer for loans by purchase date bar chart
    function openKpiDrawer(){
      // build bar counts by month
      const counts = {};
      loansWithAmort.forEach(l=>{ const m = new Date(l.purchaseDate+'T00:00:00').toLocaleString(undefined,{year:'numeric',month:'short'}); counts[m] = (counts[m]||0)+1; });
      const months = Object.keys(counts);
      drawerTitle.textContent='Loans by Purchase Date'; drawerSub.textContent='Counts'; drawerAmortContainer.style.display='none';
      drawerChartArea.innerHTML=''; drawerExtra = drawer.querySelector('#drawerMeta'); // not used
      const svgNS='http://www.w3.org/2000/svg'; const w=560,h=260,pad=30; const svg=document.createElementNS(svgNS,'svg'); svg.setAttribute('viewBox',`0 0 ${w} ${h}`); svg.setAttribute('width','100%'); svg.setAttribute('height','100%');
      const maxC = Math.max(...Object.values(counts));
      months.forEach((m,i)=>{
        const barW = (w - pad*2)/months.length * 0.6; const gap = ((w-pad*2)/months.length - barW)/2;
        const x = pad + i*((w-pad*2)/months.length) + gap; const barH = (counts[m]/maxC)*(h-pad*2); const y = h-pad-barH;
        const rect = document.createElementNS(svgNS,'rect'); rect.setAttribute('x',x); rect.setAttribute('y',y); rect.setAttribute('width',barW); rect.setAttribute('height',barH); rect.setAttribute('fill','#06b6d4'); svg.appendChild(rect);
        const text = document.createElementNS(svgNS,'text'); text.setAttribute('x', x+barW/2); text.setAttribute('y', h-pad+14); text.setAttribute('font-size','11'); text.setAttribute('text-anchor','middle'); text.setAttribute('fill','#475569'); text.textContent = m; svg.appendChild(text);
        rect.addEventListener('mousemove',(ev)=>{ const tt=document.getElementById('tooltip'); tt.style.display='block'; tt.style.left=ev.clientX+'px'; tt.style.top=(ev.clientY-12)+'px'; tt.innerHTML = `${m} • ${counts[m]} loans`; });
        rect.addEventListener('mouseleave',()=>document.getElementById('tooltip').style.display='none');
      });
      drawerChartArea.appendChild(svg);
      drawer.classList.add('open'); drawer.setAttribute('aria-hidden','false');
    }

    function openPortfolioDrawer(){
      drawerTitle.textContent='Portfolio — Weighted ROI Series'; drawerSub.textContent='Weighted ROI over time'; drawerAmortContainer.style.display='none';
      drawerChartArea.innerHTML=''; const svgNS='http://www.w3.org/2000/svg'; const w=560,h=260,pad=30; const svg=document.createElementNS(svgNS,'svg'); svg.setAttribute('viewBox',`0 0 ${w} ${h}`); svg.setAttribute('width','100%'); svg.setAttribute('height','100%');
      const series = buildPortfolioSeries(); const ys = series.map(s=>s.roi); const minY=Math.min(...ys); const maxY=Math.max(...ys); const range=Math.max(1e-6,maxY-minY); const stepX=(w-pad*2)/Math.max(1,series.length-1);
      let pts=''; series.forEach((p,i)=>{ const x=pad+i*stepX; const y=pad+(h-pad*2)-((p.roi-minY)/range)*(h-pad*2); pts += (i===0?`M ${x} ${y}`:` L ${x} ${y}`); });
      const poly = document.createElementNS(svgNS,'path'); poly.setAttribute('d',pts); poly.setAttribute('fill','none'); poly.setAttribute('stroke','#0ea5e9'); poly.setAttribute('stroke-width','2'); svg.appendChild(poly);
      // hotspots similar to loan chart
      series.forEach((p,i)=>{ const x = pad + i*stepX; const hit = document.createElementNS(svgNS,'rect'); hit.setAttribute('x', x-stepX/2); hit.setAttribute('y', pad); hit.setAttribute('width', Math.max(1,stepX)); hit.setAttribute('height', h-pad*2); hit.setAttribute('fill','transparent'); hit.addEventListener('mousemove',(ev)=>{ const tt=document.getElementById('tooltip'); tt.style.display='block'; tt.style.left=ev.clientX+'px'; tt.style.top=(ev.clientY-12)+'px'; tt.innerHTML = `M${p.month} • Weighted ROI ${(p.roi*100).toFixed(2)}%`; }); hit.addEventListener('mouseleave',()=>document.getElementById('tooltip').style.display='none'); svg.appendChild(hit); });
      drawerChartArea.appendChild(svg); drawer.classList.add('open'); drawer.setAttribute('aria-hidden','false');
    }

    // filters & sorting
    document.getElementById('statusFilter').addEventListener('change', ()=>{ applyFilters(); });
    document.getElementById('sortRoi').addEventListener('click', ()=>{ loansView.sort((a,b)=>((b.roiSeries[Math.min(CURRENT_MONTH-1,b.roiSeries.length-1)]||{}).roi||0)-((a.roiSeries[Math.min(CURRENT_MONTH-1,a.roiSeries.length-1)]||{}).roi||0)); renderLoans(loansView); });
    document.getElementById('sortDate').addEventListener('click', ()=>{ loansView.sort((a,b)=> new Date(a.purchaseDate) - new Date(b.purchaseDate)); renderLoans(loansView); });

    function applyFilters(){
      const status = document.getElementById('statusFilter').value;
      loansView = loansWithAmort.filter(l=> status==='all' ? true : l.status === status);
      renderLoans(loansView);
    }

    // initial render
    renderKpis();
    renderPortfolioMini();
    loansView = loansWithAmort.slice();
    renderLoans(loansView);

  </script>
</body>
</html>
