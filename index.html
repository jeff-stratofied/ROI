<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Loan Portfolio — ROI Dashboard</title>
  <style>
    :root{--muted:#64748b;--card:#ffffff;--brand:#0ea5e9;--accent:#7c3aed}
    html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto;color:#0f172a}
    body{background:linear-gradient(180deg,#f1f5f9 0%, #f8fafc 100%)}
    .app{max-width:1200px;margin:20px auto;padding:16px}
    header{display:flex;flex-direction:column;gap:8px;margin-bottom:12px}
    .header-top{display:flex;align-items:center;justify-content:space-between}
    h1{ font-size:20px; margin:0 }
    p.lead{ margin:0; color:var(--muted); font-size:13px }
    .current-date{ font-size:13px; color:var(--muted); margin-top:4px }

    .kpis{ display:grid; grid-template-columns:repeat(4,1fr); gap:12px; margin:14px 0 18px }
    .kpi{ background:var(--card); padding:12px; border-radius:10px; box-shadow:0 6px 18px rgba(16,24,40,0.04); border:1px solid rgba(15,23,42,0.04); cursor:pointer; transition: transform .18s, box-shadow .18s }
    .kpi:hover{ transform:translateY(-6px); box-shadow:0 12px 30px rgba(15,23,42,0.08) }
    .kpi h3{ margin:0; font-size:12px; color:var(--muted) }
    .kpi p{ margin:8px 0 0; font-size:18px; font-weight:700 }

    .grid{ display:grid; grid-template-columns:repeat(2,1fr); gap:12px; height:calc(100vh - 320px); overflow:auto; padding-right:6px }
    @media(max-width:900px){ .grid{ grid-template-columns:1fr; height:auto } .kpis{ grid-template-columns:repeat(2,1fr) } }

    .tile{ display:flex; align-items:center; justify-content:space-between; padding:10px 12px; border-radius:12px; background:var(--card); min-height:110px; cursor:pointer; overflow:hidden; transition: transform .18s ease, box-shadow .18s ease }
    .tile:hover{ transform:translateY(-6px); box-shadow:0 12px 30px rgba(15,23,42,0.08) }

    .tile-left{ flex:1; padding-right:10px }
    .loan-name{ font-weight:700; font-size:14px }
    .loan-sub{ font-size:12px; color:var(--muted); margin-top:6px }
    .loan-meta{ display:flex; gap:8px; font-size:12px; color:var(--muted); margin-top:8px }

    .chart-wrap{ width:170px; flex-shrink:0; display:flex; flex-direction:column; align-items:flex-end }
    .mini-label{ font-size:12px; color:var(--muted); margin-bottom:6px }
    svg.sparkline{ width:170px; height:48px; display:block }

    .drawer{ position:fixed; right:0; top:0; height:100vh; width:860px; background:var(--card); box-shadow:-28px 0 80px rgba(2,6,23,0.14); transform:translateX(110%); transition:transform .28s cubic-bezier(.2,.9,.3,1); z-index:90; overflow:auto; padding:20px }
    .drawer.open{ transform:translateX(0) }
    .drawer-head{ display:flex; align-items:start; justify-content:space-between; gap:8px }
    .close-btn{ background:#f1f5f9; border:none; padding:8px; border-radius:8px; cursor:pointer }
    .drawer-chart{ height:220px; background:linear-gradient(180deg,#ffffff,#fcfeff); border-radius:8px; border:1px solid rgba(15,23,42,0.03); display:flex; align-items:center; justify-content:center; margin-bottom:8px; position:relative; padding:8px }

/* Drawer info layout improvements */
.drawer .drawer-info-row { display:flex; gap:10px; margin-bottom:8px; }
.drawer .info-card { flex:1; background:#f8fafc; padding:10px; border-radius:8px; }
.drawer .info-card.small { width:120px; display:flex; flex-direction:column; align-items:flex-end; justify-content:center; }
.drawer .info-card .muted-small {
  font-size:12px;
  color:var(--muted);
  margin-bottom:10px;    /* was 6px */
  display:block;
}
    
    .amort-wrap{ border:1px solid rgba(15,23,42,0.04); border-radius:8px; padding:8px; max-height:40vh; overflow:auto }
    table{ width:100%; border-collapse:collapse; font-size:13px }
    thead th{ position:sticky; top:0; background:var(--card); padding:8px; text-align:left; color:var(--muted); font-weight:700 }
    td{ padding:8px; border-bottom:1px dashed rgba(15,23,42,0.04); text-align:right }
    td:first-child, th:first-child{ text-align:left }

    .tooltip{ position:fixed; pointer-events:none; background:#0f172a; color:white; padding:6px 8px; border-radius:6px; font-size:12px; transform:translate(-50%,-120%); box-shadow:0 6px 18px rgba(2,6,23,0.2); display:none; z-index:9999; line-height:1.12 }
    .small{ font-size:12px; color:var(--muted) }

    /* ROI table styling (matches amort page look) */
.roi-table {
  width: 100%;
  border-collapse: collapse;
  font-size: 13px;
  background: #fff;
}
.roi-table thead th {
  text-align: left;
  padding: 8px;
  background: #f8fafc;
  font-weight: 700;
  color: var(--muted);
  border-bottom: 1px solid rgba(15,23,42,0.04);
}
.roi-table tbody td {
  padding: 8px;
  border-bottom: 1px dashed rgba(15,23,42,0.04);
  text-align: right;
}
.roi-table tbody td:first-child { text-align:left; }
.roi-table-container h3 { margin: 0 0 8px; font-size:15px; }
  
  </style>
</head>
<body>
  <div class="app" role="main">
    <header>
      <div class="header-top">
        <div>
          <h1>Loan Portfolio — ROI Dashboard</h1>
          <p class="lead">Interactive ROI mini-charts • Drawer with expanded ROI and amortization • KPIs at the top</p>
        </div>
        <div style="display:flex;gap:10px;align-items:center">
          <div style="font-size:13px;color:var(--muted)">User: <strong style="color:var(--brand)">Jeff H Customer</strong></div>
        </div>
      </div>
      <div class="current-date">Current Month: <strong id="currentMonthLabel">18</strong> (months since first purchase)</div>
    </header>

    <section class="kpis" id="kpis"></section>
    <section class="grid" id="loanGrid" aria-live="polite"></section>
  </div>

  <aside id="drawer" class="drawer" aria-hidden="true">
    <div class="drawer-head">
      <div>
        <h2 id="drawerTitle">Drawer</h2>
        <div class="muted" id="drawerSub">details</div>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <button class="btn" id="downloadCsvBtn">Download CSV</button>
        <button class="close-btn" id="closeBtn" aria-label="Close drawer">✕</button>
      </div>
    </div>
    
<div class="drawer-info-row">
  <div class="info-card">
    <div class="muted-small" id="drawerPrimaryTitle">Purchase Price</div>
    <div id="drawerPrimary" style="font-weight:800;font-size:18px"></div>
  </div>
  <div class="info-card small">
    <div class="muted-small" id="drawerSecondaryTitle">Rate</div>
    <div id="drawerSecondary" style="font-weight:800;font-size:16px"></div>
  </div>
</div>
    
    <div id="drawerBody">
      <div class="drawer-chart" id="drawerChartArea"></div>
<!-- ROI table (inserted below drawerChartArea) -->
<div class="roi-table-container" style="margin-top: 18px;">
  <h3 style="margin-bottom:8px">ROI Breakdown</h3>

  <div style="overflow:auto; border-radius:8px; border:1px solid rgba(15,23,42,0.04); padding:6px; background:#fff">
    <table class="roi-table" aria-label="ROI by month">
      <thead>
        <tr>
          <th style="min-width:70px">Month</th>
          <th style="min-width:90px">Payment</th>
          <th style="min-width:90px">Principal</th>
          <th style="min-width:90px">Interest</th>
          <th style="min-width:110px">Accrued Int</th>
          <th style="min-width:80px">Fees</th>
          <th style="min-width:110px">Loan Value</th>
          <th style="min-width:80px">ROI %</th>
        </tr>
      </thead>
      <tbody id="roiTableBody">
        <!-- JS will inject rows here -->
      </tbody>
    </table>
  </div>
</div>

      
      <div class="legend" id="drawerLegend" style="display:none"></div>

      <div id="drawerExtra"></div>


    <div class="actions" style="padding-top:10px">
      <button class="btn" id="printBtn">Print</button>
      <button class="btn primary" id="copyCsvBtn">Copy CSV</button>
    </div>
  </aside>

  <div id="tooltip" class="tooltip" role="status" aria-live="polite"></div>

  <script>
    const CURRENT_MONTH = 18;
    function monthDiff(d1, d2) {
  const a = new Date(d1);
  const b = new Date(d2);
  return (b.getFullYear() - a.getFullYear()) * 12 + (b.getMonth() - a.getMonth());
}
    document.getElementById('currentMonthLabel').textContent = CURRENT_MONTH;

    const loans = [
      { id:1, purchaseDate:'2024-01-01', purchasePrice:7000, termYears:10, graceYears:0.83, nominalRate:0.0883 },
      { id:2, purchaseDate:'2024-02-01', purchasePrice:7500, termYears:8, graceYears:2, nominalRate:0.075 },
      { id:3, purchaseDate:'2024-03-01', purchasePrice:12000, termYears:12, graceYears:3, nominalRate:0.0825 },
      { id:4, purchaseDate:'2024-04-01', purchasePrice:6000, termYears:9, graceYears:1.5, nominalRate:0.095 },
      { id:5, purchaseDate:'2024-07-01', purchasePrice:5000, termYears:10, graceYears:1, nominalRate:0.09 },
      { id:6, purchaseDate:'2025-01-01', purchasePrice:7500, termYears:5, graceYears:0, nominalRate:0.073 },
      { id:7, purchaseDate:'2025-06-01', purchasePrice:10000, termYears:8, graceYears:0, nominalRate:0.09 },
      { id:8, purchaseDate:'2025-10-01', purchasePrice:5000, termYears:9, graceYears:0.5, nominalRate:0.11 },
      { id:9, purchaseDate:'2025-02-01', purchasePrice:10000, termYears:7, graceYears:0.25, nominalRate:0.10 },
      { id:10,purchaseDate:'2025-03-01', purchasePrice:8000, termYears:3, graceYears:0, nominalRate:0.06 }
    ];

    function calcAmort(principal, annualRate, termYears, graceYears){
      const monthlyRate = annualRate/12;
      const totalMonths = Math.round(termYears*12);
      const graceMonths = Math.round(graceYears*12);
      const repayMonths = Math.max(1, totalMonths - graceMonths);
      let balance = principal;
      const schedule = [];
      for(let m=1;m<=graceMonths;m++){
        const interest = +(balance*monthlyRate).toFixed(2);
        balance = +(balance + interest).toFixed(2);
        schedule.push({ monthIndex:m, payment:0, principalPaid:0, interest, balance });
      }
      const payment = monthlyRate===0 ? +(balance/repayMonths).toFixed(2) : +((balance*monthlyRate)/(1-Math.pow(1+monthlyRate,-repayMonths))).toFixed(2);
      for(let m=1;m<=repayMonths;m++){
        const interest = +(balance*monthlyRate).toFixed(2);
        const principalPaid = +Math.min(balance, +(payment - interest).toFixed(2));
        balance = +(Math.max(0, balance - principalPaid).toFixed(2));
        schedule.push({ monthIndex: graceMonths + m, payment:+payment.toFixed(2), principalPaid, interest, balance });
      }
      return { payment, schedule };
    }

    const loansWithAmort = loans.map(l=>{
      const amort = calcAmort(l.purchasePrice, l.nominalRate, l.termYears, l.graceYears);
      let cumP=0, cumI=0, cumTotal=0;
      const cumSchedule = amort.schedule.map(r=>{ cumP=+(cumP+r.principalPaid).toFixed(2); cumI=+(cumI+r.interest).toFixed(2); cumTotal=+(cumTotal+r.payment).toFixed(2); return {...r, cumPrincipal:cumP, cumInterest:cumI, cumTotal}; });
      const roiSeries = cumSchedule.map(s => { const loanValue = s.balance + s.cumInterest + s.cumTotal; const roi = (loanValue - l.purchasePrice)/l.purchasePrice; return { month:s.monthIndex, roi, loanValue }; });
      const miniPts = roiSeries.slice(0, Math.min(24, roiSeries.length)).map(s=>({ x:s.month, y:s.roi }));
      return {...l, amort, cumSchedule, roiSeries, miniPts };
    });

    function computeKPIs(list){
      const total = list.reduce((s,l)=>s + l.purchasePrice, 0);
      const weightedROI = list.reduce((s,l)=> s + l.purchasePrice * ( (l.roiSeries[Math.min(CURRENT_MONTH-1, l.roiSeries.length-1)] || {}).roi || 0 ), 0) / Math.max(1, total);
      const projectedWeightedROI = list.reduce((s,l)=> s + l.purchasePrice * ( (l.roiSeries[l.roiSeries.length-1] || {}).roi || 0 ), 0) / Math.max(1, total);
      const avgRate = list.reduce((s,l)=> s + l.nominalRate * l.purchasePrice, 0) / Math.max(1, total);
      return { total, weightedROI, projectedWeightedROI, avgRate };
    }

    const kpis = computeKPIs(loansWithAmort);

    const kpisEl = document.getElementById('kpis');
    kpisEl.innerHTML = ''
      + '<div class="kpi" data-kpi="distribution"><h3>Total Loans</h3><p>' + loansWithAmort.length + '</p></div>'
      + '<div class="kpi" data-kpi="tpv"><h3>Weighted ROI to Date</h3><p id="wroi">' + (kpis.weightedROI*100).toFixed(2) + '%</p></div>'
      + '<div class="kpi" data-kpi="rates"><h3>Projected Weighted ROI</h3><p id="wproj">' + (kpis.projectedWeightedROI*100).toFixed(2) + '%</p></div>'
      + '<div class="kpi" data-kpi="payments"><h3>Avg Rate</h3><p>' + (kpis.avgRate*100).toFixed(2) + '%</p></div>'
    ;

    function buildPathFromPoints(points, w=170, h=48, pad=6){
      if(!points.length) return '';
      const ys = points.map(p=>p.y);
      const minY = Math.min.apply(null, ys); const maxY = Math.max.apply(null, ys); const range = Math.max(1e-6, maxY - minY);
      const stepX = (w - pad*2) / Math.max(1, points.length - 1);
      let d=''; points.forEach(function(p,i){ const x = pad + i*stepX; const y = pad + (h - pad*2) - ((p.y - minY)/range)*(h - pad*2); d += (i===0?('M '+x+' '+y):(' L '+x+' '+y)); }); return d;
    }

    const grid = document.getElementById('loanGrid');
    const tooltip = document.getElementById('tooltip');

    loansWithAmort.forEach(function(loan, idx){
      var tile = document.createElement('div'); tile.className='tile'; tile.setAttribute('tabindex','0');
      var inner = ''
        + '<div class="tile-left">'
        + '<div class="loan-name">Loan ' + loan.id + '</div>'
        + '<div class="loan-sub">$' + loan.purchasePrice.toLocaleString() + '</div>'
        + '<div class="loan-meta"><div>Term: ' + loan.termYears + 'y</div><div>Grace: ' + loan.graceYears + 'y</div></div>'
        + '</div>'
        + '<div class="chart-wrap">'
        + '<div class="mini-label">ROI ' + (( (loan.roiSeries[Math.min(CURRENT_MONTH-1, loan.roiSeries.length-1)]||{}).roi || 0)*100).toFixed(2) + '%</div>'
        + '<svg class="sparkline" viewBox="0 0 170 48" preserveAspectRatio="none" data-idx="' + idx + '" aria-hidden="true"></svg>'
        + '</div>';
      tile.innerHTML = inner;

      tile.addEventListener('click', function(e){ e.stopPropagation(); openDrawerForLoan(loan); });
      tile.addEventListener('keydown', function(e){ if(e.key==='Enter' || e.key===' '){ e.preventDefault(); openDrawerForLoan(loan); } });
      grid.appendChild(tile);

      var svg = tile.querySelector('svg.sparkline'); var w=170,h=48,pad=6;
      var pts = loan.miniPts && loan.miniPts.length?loan.miniPts:loan.roiSeries.map(function(s){return {x:s.month,y:s.roi};});
      var path = buildPathFromPoints(pts, w, h, pad);
     // compute dashed line X first
const earliestDate = "2024-01-01";
const diff = monthDiff(earliestDate, loan.purchaseDate);

let currentIdxForLoan = CURRENT_MONTH - diff;
currentIdxForLoan = Math.max(1, Math.min(loan.roiSeries.length, currentIdxForLoan));

const stepX = (w - pad*2) / Math.max(1, loan.roiSeries.length - 1);
const dashX = pad + (currentIdxForLoan - 1) * stepX;

// now build SVG innerHTML including the dashed line
svg.innerHTML =
    '<path d="' + path + '" fill="none" stroke="#0ea5e9" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" />'
  + '<g class="mini-hover"></g>'
  + '<line class="current-line" x1="' + dashX + '" y1="2" x2="' + dashX + '" y2="' + (h-2)
      + '" stroke="#111827" stroke-dasharray="3 3" stroke-opacity="0.6" />';

      svg.addEventListener('mousemove', function(ev){
        var rect = svg.getBoundingClientRect(); var relativeX = ev.clientX - rect.left; var frac = relativeX / rect.width; var idxNearest = Math.round(frac*(loan.roiSeries.length - 1)); var p = loan.roiSeries[Math.max(0, Math.min(loan.roiSeries.length-1, idxNearest))];
        tooltip.style.left = (ev.clientX) + 'px'; tooltip.style.top = (ev.clientY - 10) + 'px'; tooltip.style.display='block'; tooltip.innerHTML = 'M' + p.month + ' • ROI ' + (p.roi*100).toFixed(2) + '%';
        var hoverG = svg.querySelector('g.mini-hover'); hoverG.innerHTML='';
        var svgNS='http://www.w3.org/2000/svg'; var stepX = (w - pad*2) / Math.max(1, loan.roiSeries.length - 1); var iX = pad + idxNearest*stepX;
        var vals = loan.roiSeries.map(function(rr){return rr.roi;}); var minV=Math.min.apply(null, vals), maxV=Math.max.apply(null, vals), rangeV=Math.max(1e-6, maxV-minV);
        var cy = pad + (h-pad*2) - ((p.roi - minV)/rangeV)*(h-pad*2);
        var c = document.createElementNS(svgNS,'circle'); c.setAttribute('cx', iX); c.setAttribute('cy', cy); c.setAttribute('r',3.6); c.setAttribute('fill','#0ea5e9'); c.setAttribute('stroke','#fff'); c.setAttribute('stroke-width','1'); hoverG.appendChild(c);
      });
      svg.addEventListener('mouseleave', function(){ tooltip.style.display='none'; var hoverG=svg.querySelector('g.mini-hover'); if(hoverG) hoverG.innerHTML=''; });
    });

    var drawer = document.getElementById('drawer'); var drawerTitle = document.getElementById('drawerTitle'); var drawerSub = document.getElementById('drawerSub'); var drawerPrimary = document.getElementById('drawerPrimary'); var drawerSecondary = document.getElementById('drawerSecondary'); var amortBody = document.getElementById('amortBody'); var drawerChartArea = document.getElementById('drawerChartArea'); var drawerLegend = document.getElementById('drawerLegend'); var drawerExtra = document.getElementById('drawerExtra'); var drawerAmortContainer = document.getElementById('drawerAmortContainer');
    document.getElementById('closeBtn').addEventListener('click', function(){ closeDrawer(); }); document.addEventListener('keydown', function(e){ if(e.key==='Escape') closeDrawer(); });

    var currentLoan=null; var currentMode=null;
    function closeDrawer(){ drawer.classList.remove('open'); drawer.setAttribute('aria-hidden','true'); tooltip.style.display='none'; currentLoan=null; currentMode=null; }

    function openDrawerForLoan(loan){
      currentMode='loan'; currentLoan=loan; drawerTitle.textContent = 'Loan ' + loan.id; drawerSub.textContent = 'Purchased: ' + loan.purchaseDate; drawerPrimary.textContent = '$' + loan.purchasePrice.toLocaleString(); drawerSecondary.textContent = (loan.nominalRate*100).toFixed(2) + '%' 

      drawerChartArea.innerHTML=''; drawerLegend.style.display='flex'; drawerLegend.innerHTML = '<div class=\"item\"><span class=\"sw\" style=\"background:#0f172a\"></span>Balance</div><div class=\"item\"><span class=\"sw\" style=\"background:#0ea5e9\"></span>ROI</div>';
      var svgNS='http://www.w3.org/2000/svg'; var w=480,h=240,pad=28; var svg=document.createElementNS(svgNS,'svg'); svg.setAttribute('viewBox','0 0 ' + w + ' ' + h); svg.setAttribute('width','100%'); svg.setAttribute('height','100%');
      var schedule = loan.roiSeries; var vals = schedule.map(function(s){return s.roi;}); var maxV=Math.max.apply(null, vals), minV=Math.min.apply(null, vals), range=Math.max(1e-6,maxV-minV);
      var stepX = (w - pad*2) / Math.max(1, schedule.length - 1);
      function toXY(val,i){ var x = pad + i*stepX; var y = pad + (h - pad*2) - ((val - minV)/range)*(h - pad*2); return [x,y]; }
      for(var gy=0;gy<5;gy++){ var y = pad + gy*((h-pad*2)/4); var line=document.createElementNS(svgNS,'line'); line.setAttribute('x1',pad); line.setAttribute('x2',w-pad); line.setAttribute('y1',y); line.setAttribute('y2',y); line.setAttribute('stroke','#eef2f7'); line.setAttribute('stroke-width','1'); svg.appendChild(line); }
      var path=''; schedule.forEach(function(p,i){ var xy = toXY(p.roi,i); path += (i===0?('M ' + xy[0] + ' ' + xy[1]):(' L ' + xy[0] + ' ' + xy[1])); }); var el=document.createElementNS(svgNS,'path'); el.setAttribute('d',path); el.setAttribute('fill','none'); el.setAttribute('stroke','#0ea5e9'); el.setAttribute('stroke-width','2'); svg.appendChild(el);
      var curIdx = Math.min(CURRENT_MONTH-1, schedule.length-1); var curX = pad + Math.max(0,curIdx)*stepX; var curLine=document.createElementNS(svgNS,'line'); curLine.setAttribute('x1',curX); curLine.setAttribute('x2',curX); curLine.setAttribute('y1',pad); curLine.setAttribute('y2',h-pad); curLine.setAttribute('stroke','#111827'); curLine.setAttribute('stroke-dasharray','3 4'); curLine.setAttribute('stroke-opacity','0.6'); svg.appendChild(curLine);
      var vLine=document.createElementNS(svgNS,'line'); vLine.setAttribute('stroke','#0f172a'); vLine.setAttribute('stroke-width','1'); vLine.setAttribute('stroke-dasharray','3 4'); vLine.setAttribute('opacity','0.6'); svg.appendChild(vLine);
      var circles=document.createElementNS(svgNS,'g'); svg.appendChild(circles);
      svg.addEventListener('mousemove', function(ev){ var rect=svg.getBoundingClientRect(); var x=ev.clientX-rect.left; var idx=Math.round((x-pad)/stepX); idx=Math.max(0,Math.min(schedule.length-1,idx)); var px = pad + idx*stepX; vLine.setAttribute('x1',px); vLine.setAttribute('x2',px); vLine.setAttribute('y1',pad); vLine.setAttribute('y2',h-pad); circles.innerHTML=''; var val=schedule[idx].roi; var xy=toXY(val,idx); var cx=xy[0], cy=xy[1]; var c=document.createElementNS(svgNS,'circle'); c.setAttribute('cx',cx); c.setAttribute('cy',cy); c.setAttribute('r',4); c.setAttribute('fill','#0ea5e9'); c.setAttribute('stroke','#fff'); c.setAttribute('stroke-width','1.2'); circles.appendChild(c); tooltip.style.display='block'; tooltip.style.left=(rect.left+px)+'px'; tooltip.style.top=(rect.top+16)+'px'; tooltip.innerHTML = 'M' + schedule[idx].month + ' • ROI ' + (schedule[idx].roi*100).toFixed(2) + '%'; });
      svg.addEventListener('mouseleave', function(){ vLine.setAttribute('x1',0); vLine.setAttribute('x2',0); circles.innerHTML=''; tooltip.style.display='none'; });
      drawerChartArea.appendChild(svg);
// ----------------------
// Populate ROI table below the chart
// feePerMonth is flat servicing fee charged every month (including grace)
const feePerMonth = 3.00;

// locate tbody and clear it
const roiBody = document.getElementById('roiTableBody');
if (roiBody) roiBody.innerHTML = '';

// We'll use loan.amort.schedule (which has payment, principalPaid, interest, balance)
// and loan.cumSchedule (which has cumPrincipal, cumInterest, cumTotal)
const cum = loan.cumSchedule || [];
const sched = loan.amort && loan.amort.schedule ? loan.amort.schedule : [];

sched.forEach((r) => {
  const month = r.monthIndex;
  // find cumulative row for same month
  const cs = cum.find(c => c.monthIndex === month) || { cumPrincipal:0, cumInterest:0, cumTotal:0 };

  const payment = Number(r.payment) || 0;
  const principalPaid = Number(r.principalPaid) || 0;
  const interestPaid = Number(r.interest) || 0;
  const accruedInterest = Number(cs.cumInterest) || 0;
  const cumulativePayments = Number(cs.cumTotal) || 0;

  // fees charged up to and including this month
  const fees = +(month * feePerMonth).toFixed(2);

  // Loan Value definition per your spec:
  // LoanValue = balance + cumulativeAccruedInterest + cumulativePayments - cumulativeFees
  const loanValue = +(Number(r.balance || 0) + accruedInterest + cumulativePayments - fees).toFixed(2);

  const roiPct = +(((loanValue - loan.purchasePrice) / loan.purchasePrice) * 100).toFixed(2);

  const tr = document.createElement('tr');
  tr.innerHTML = ''
    + '<td>M' + month + '</td>'
    + '<td>$' + payment.toFixed(2) + '</td>'
    + '<td>$' + principalPaid.toFixed(2) + '</td>'
    + '<td>$' + interestPaid.toFixed(2) + '</td>'
    + '<td>$' + accruedInterest.toFixed(2) + '</td>'
    + '<td>$' + fees.toFixed(2) + '</td>'
    + '<td>$' + loanValue.toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2}) + '</td>'
    + '<td>' + roiPct.toFixed(2) + '%</td>'
  ;
  roiBody.appendChild(tr);
});
      drawer.classList.add('open'); drawer.setAttribute('aria-hidden','false'); drawer.scrollTop=0;
    }

    document.querySelectorAll('.kpi').forEach(function(k){ k.addEventListener('click', function(ev){ ev.stopPropagation(); var key=k.getAttribute('data-kpi'); if(key==='distribution') renderDistributionDrawer(); if(key==='tpv') renderTPVDrawer(); if(key==='rates') renderRatesDrawer(); if(key==='payments') renderPaymentsDrawer(); }); });

    function renderTPVDrawer(){ currentMode='kpi'; currentLoan=null; drawerTitle.textContent='Portfolio — Weighted ROI'; drawerSub.textContent='Snapshot'; drawerPrimary.textContent = ''; drawerSecondary.textContent = '';  drawerExtra.innerHTML = '<div style=\"margin-top:10px\"><strong class=\"small\">Weighted ROI to date</strong><div style=\"font-size:18px;font-weight:800;margin-top:6px\">' + (kpis.weightedROI*100).toFixed(2) + '%</div></div>'; drawerChartArea.innerHTML=''; drawerLegend.style.display='none'; drawer.classList.add('open'); drawer.setAttribute('aria-hidden','false'); }
    function renderDistributionDrawer(){ currentMode='kpi'; currentLoan=null; drawerTitle.textContent='Distribution'; drawerSub.textContent='Loans by purchase month';  drawerExtra.innerHTML=''; drawerChartArea.innerHTML=''; drawerLegend.style.display='none'; drawerExtra.innerHTML = '<div style=\"margin-top:10px\"><strong class=\"small\">Loans</strong><div style=\"max-height:220px;overflow:auto;margin-top:6px;border-radius:6px;padding:6px;border:1px solid #f0f3f7\"><table style=\"width:100%;font-size:13px\"><thead><tr><th>Loan</th><th>Purchase</th><th>Rate</th></tr></thead><tbody>' + loansWithAmort.map(function(l){ return '<tr><td style=\"text-align:left\">Loan ' + l.id + '</td><td style=\"text-align:left\">' + l.purchaseDate + '</td><td style=\"text-align:left\">' + (l.nominalRate*100).toFixed(2) + '%</td></tr>'; }).join('') + '</tbody></table></div></div>'; drawer.classList.add('open'); drawer.setAttribute('aria-hidden','false'); }
    function renderRatesDrawer(){ currentMode='kpi'; currentLoan=null; drawerTitle.textContent='Rates Distribution'; drawerSub.textContent='Histogram of nominal rates';  drawerExtra.innerHTML=''; drawerChartArea.innerHTML=''; drawerLegend.style.display='none'; drawer.classList.add('open'); drawer.setAttribute('aria-hidden','false'); }
    function renderPaymentsDrawer(){ currentMode='kpi'; currentLoan=null; drawerTitle.textContent='Payments'; drawerSub.textContent='Expected monthly payments';  drawerExtra.innerHTML=''; drawerChartArea.innerHTML=''; drawerLegend.style.display='none'; drawer.classList.add('open'); drawer.setAttribute('aria-hidden','false'); }

    function amortToCSV(loan){ var rows=[['Month','Payment','Principal','Interest','Balance']]; loan.amort.schedule.forEach(function(r){ rows.push([r.monthIndex, r.payment.toFixed(2), r.principalPaid.toFixed(2), r.interest.toFixed(2), r.balance.toFixed(2)]); }); return rows.map(function(r){ return r.join(','); }).join('\n'); }
    document.getElementById('copyCsvBtn')?.addEventListener('click', async function(){ if(currentMode!=='loan' || !currentLoan) return alert('Open an individual loan drawer to copy CSV'); var csv=amortToCSV(currentLoan); try{ await navigator.clipboard.writeText(csv); alert('CSV copied to clipboard'); }catch(e){ alert('Copy failed — browser denied clipboard access'); } });
    document.getElementById('downloadCsvBtn')?.addEventListener('click', function(){ if(currentMode==='loan' && currentLoan){ var csv=amortToCSV(currentLoan); var blob=new Blob([csv],{type:'text/csv;charset=utf-8;'}); var url=URL.createObjectURL(blob); var a=document.createElement('a'); a.href=url; a.download='loan-' + currentLoan.id + '-amort.csv'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url); } else alert('Download CSV is supported for individual loan drawers only.'); });
    document.getElementById('printBtn')?.addEventListener('click', function(){ window.print(); });

    document.querySelector('.grid').addEventListener('scroll', function(){ tooltip.style.display='none'; });

    document.addEventListener('click', function (e) { if(!drawer.classList.contains('open')) return; var clickedInsideDrawer = drawer.contains(e.target); var clickedTile = !!e.target.closest('.tile'); if(!clickedInsideDrawer && !clickedTile) closeDrawer(); });
  </script>
</body>
</html>
